<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BearBake Calculator - Professional Bakery Management Tool</title>

    <!-- SEO Meta Tags -->
    <meta name="description"
        content="BearBake Professional Bakery Calculator. The ultimate tool to calculate costs, manage recipes, track ingredients, compare suppliers, and optimize your bakery business profitability.">
    <meta name="keywords"
        content="bakery calculator, recipe costing, bakery management software, cake pricing calculator, baking ingredients tracker, production planner, bearbake">
    <meta name="author" content="BearBake">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://bearbake.online/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bearbake.online/">
    <meta property="og:title" content="BearBake - Professional Bakery Management Tool">
    <meta property="og:description"
        content="Streamline your bakery operations with BearBake. Calculate costs, manage recipes, and track stock all in one place.">
    <meta property="og:image" content="https://bearbake.online/social-share.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://bearbake.online/">
    <meta property="twitter:title" content="BearBake - Professional Bakery Management Tool">
    <meta property="twitter:description"
        content="Streamline your bakery operations with BearBake. Calculate costs, manage recipes, and track stock all in one place.">
    <meta property="twitter:image" content="https://bearbake.online/social-share.png">
    <link rel="icon" type="image/x-icon" href="LogoBB.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light-border.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-pink': {
                            50: '#fef2f6',
                            100: '#fce7f0',
                            200: '#f9bed7',
                            300: '#f596be',
                            400: '#f06da4',
                            500: '#e9448b',
                            600: '#d52770',
                            700: '#b41d5a',
                            800: '#961a4a',
                            900: '#801a40',
                        },
                        'brand-indigo': {
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* General Body & Animation Styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* External Library Customization */
        .ts-control {
            border-radius: 0.5rem;
            border-color: #D1D5DB;
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .ts-control:focus,
        .ts-control.focus {
            border-color: #e9448b;
            box-shadow: 0 0 0 3px rgba(233, 68, 139, 0.2);
        }

        .ts-dropdown {
            background-color: white;
            z-index: 20;
        }

        .tippy-box[data-theme~='light-border'] {
            font-family: 'Inter', sans-serif;
        }

        .tippy-box[data-theme~='light-border'] .tippy-content {
            padding: 0.5rem;
        }


        /* Custom Scrollbar for Inventory History */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        /* Custom Components */
        .recipe-item-row {
            position: relative;
        }

        .recipe-item-row.is-active {
            z-index: 100;
        }

        .breakdown-container {
            transition: max-height 0.4s ease-in-out;
        }

        .breakdown-container.is-collapsed {
            max-height: 280px;
            overflow-y: auto;
            -webkit-mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            scrollbar-width: thin;
            scrollbar-color: #e9448b #F9FAFB;
        }

        .breakdown-container.is-collapsed::-webkit-scrollbar {
            width: 6px;
        }

        .breakdown-container.is-collapsed::-webkit-scrollbar-track {
            background: #F9FAFB;
        }

        .breakdown-container.is-collapsed::-webkit-scrollbar-thumb {
            background-color: #f9bed7;
            border-radius: 10px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center;
        }

        .calendar-header,
        .calendar-day {
            padding: 8px 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .calendar-header {
            font-weight: 600;
            color: #4B5563;
        }

        .calendar-day {
            cursor: pointer;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }

        .calendar-day:hover:not(.not-current-month) {
            background-color: #fef2f6;
        }

        .calendar-day.selected {
            background-color: #e9448b;
            color: white;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .calendar-nav button {
            background: none;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            color: #d52770;
        }

        .calendar-day.has-recipe {
            background-color: #fce7f0;
            border: 1px solid #f9bed7;
            position: relative;
            font-weight: bold;
        }

        .team-card-details {
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, border 0.5s ease-in-out;
            max-height: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            border-top-width: 0px;
        }

        .team-card-details.expanded {
            max-height: 2000px;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            border-top-width: 1px;
        }

        .recipe-book-item .recipe-book-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }

        .recipe-book-item.is-expanded .recipe-book-content {
            max-height: 2500px;
            /* A large value to accommodate long recipes */
        }

        .recipe-book-item .collapse-recipe-btn {
            margin-bottom: -1.5rem;
            /* Pulls button down to cover padding */
            padding-bottom: 0.3rem;
            padding-top: 0.3rem;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
            margin-left: -1.5rem;
            margin-right: -1.5rem;
            width: calc(100% + 3rem);
        }

        .recipe-book-item.is-expanded .chevron-icon {
            transform: rotate(180deg);
        }

        /* Full Production Planner */
        .full-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(100px, auto);
            border-left: 1px solid #E5E7EB;
            border-top: 1px solid #E5E7EB;
        }

        .full-calendar-header {
            text-align: center;
            font-weight: 900;
            font-size: 0.75rem;
            color: #4B5563;
            padding: 0.5rem 0;
            border-right: 1px solid #E5E7EB;
            border-bottom: 1px solid #E5E7EB;
            background-color: #F9FAFB;
        }

        /* Tab Bar Styles */
        .supplier-tabs-container {
            display: flex;
            align-items: end;
            overflow-x: auto;
            overflow-y: hidden;
            background: transparent;
            padding: 8px 8px 2px 8px;
            /* Added bottom padding */
            gap: 4px;
            border-radius: 8px 8px 0 0;
            margin-top: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .supplier-tabs-container::-webkit-scrollbar {
            display: none;
        }

        .supplier-tab {
            position: relative;
            padding: 8px 12px;
            background: #ffffff;
            color: #1f2937;
            border-radius: 8px 8px 0 0;
            max-width: 150px;
            min-width: 80px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            border: 1px solid #d1d5db;
            border-bottom: none;
            margin-bottom: -2px;
        }

        .supplier-tab.active {
            background: #db2777;
            color: #ffffff;
            border-color: #db2777;
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        .supplier-tab:hover:not(.active) {
            background: #f3f4f6;
            color: #000000;
        }

        .tab-label-container {
            overflow: hidden;
            white-space: nowrap;
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
            flex: 1;
            margin-right: 6px;
        }

        .tab-label {
            display: inline-block;
            transition: transform 4s linear;
            min-width: 100%;
        }

        .supplier-tab:hover .tab-label {
            transform: translateX(-50%);
        }

        .tab-close {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            opacity: 0.6;
        }

        .tab-close:hover {
            background: rgba(0, 0, 0, 0.2);
            opacity: 1;
        }

        .supplier-tab.active .tab-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .active-price-toggle {
            cursor: pointer;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
        }

        .active-price-toggle.active {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .active-price-toggle.active .indicator-dot {
            background-color: #166534;
        }

        .active-price-toggle.inactive {
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .full-calendar-day {
            padding: 0.5rem;
            border-right: 1px solid #E5E7EB;
            border-bottom: 1px solid #E5E7EB;
            position: relative;
            font-size: 0.875rem;
        }

        .full-calendar-day.not-current-month {
            background-color: #F9FAFB;
        }

        .full-calendar-day .day-number {
            font-weight: 600;
            color: #374151;
        }

        .full-calendar-day.not-current-month .day-number {
            color: #9CA3AF;
        }

        .full-calendar-day.has-events {
            background-color: #fef2f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .full-calendar-day.has-events:hover {
            background-color: #f9bed7;
        }

        .planner-recipe-item {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            margin-top: 2px;
            word-break: break-word;
        }

        .planner-event-list {
            margin-top: 0.5rem;
        }

        .planner-more-items-btn {
            font-size: 0.7rem;
            font-weight: 600;
            color: #b41d5a;
            text-align: center;
            margin-top: 4px;
            padding: 2px;
            border-radius: 4px;
            background-color: #fce7f0;
        }

        /* Utility and Custom Editor Styles */
        .focus-ring {
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .focus-ring:focus {
            outline: none;
            border-color: #e9448b;
            box-shadow: 0 0 0 3px rgba(233, 68, 139, 0.2);
        }

        .ql-textbox {
            background-color: #d52770;
            color: #ffffff;
            border-radius: 8px;
            padding: 4px 12px;
            margin: 0 2px;
            display: inline-block;
            white-space: nowrap;
            font-weight: 500;
        }

        .ql-snow .ql-formats button.ql-textbox .ql-stroke {
            fill: none;
            stroke: #444;
            stroke-width: 2;
            stroke-linecap: square;
            stroke-linejoin: round;
        }

        .category-filter-btn.active {
            background-color: #d52770;
            color: white;
            font-weight: 600;
            border-color: #ffffff;
        }

        /* Homepage-specific styles */
        .feature-card {
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: #f9bed7;
            box-shadow: 0 10px 25px -5px rgba(233, 68, 139, 0.15);
        }

        .stats-card {
            background: linear-gradient(145deg, #fef2f6, #fce7f0);
            border: 1px solid #f9bed7;
        }

        .cta-button {
            background: linear-gradient(to right, #e9448b, #d52770);
            box-shadow: 0 4px 6px rgba(233, 68, 139, 0.3);
        }

        .cta-button:hover {
            background: linear-gradient(to right, #d52770, #b41d5a);
            box-shadow: 0 6px 8px rgba(233, 68, 139, 0.4);
            transform: translateY(-2px);
        }

        .secondary-button {
            background: linear-gradient(to right, #f9fafb, #f3f4f6);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .secondary-button:hover {
            background: linear-gradient(to right, #f3f4f6, #e5e7eb);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        /* Optimizer Modal Styles */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(233, 68, 139, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(233, 68, 139, 0.5);
            }
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .optimizer-modal-content {
            animation: slideInUp 0.4s ease-out forwards;
        }

        .optimizer-stat-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.9) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(233, 68, 139, 0.15);
            transition: all 0.3s ease;
        }

        .optimizer-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(233, 68, 139, 0.15);
            border-color: rgba(233, 68, 139, 0.3);
        }

        .optimizer-stat-value {
            animation: countUp 0.6s ease-out forwards;
            animation-delay: 0.2s;
            opacity: 0;
        }

        .optimizer-table-row {
            transition: all 0.2s ease;
        }

        .optimizer-table-row:hover {
            background-color: #fef2f6;
            transform: scale(1.005);
        }

        .savings-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulseGlow 2s ease-in-out infinite;
            animation-delay: 0.5s;
        }

        .switch-btn-row {
            transition: all 0.2s ease;
        }

        .switch-btn-row:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(233, 68, 139, 0.3);
        }

        .optimizer-header-gradient {
            background: linear-gradient(135deg, #e9448b 0%, #d52770 50%, #b41d5a 100%);
        }

        .optimizer-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #f9bed7 #fef2f6;
        }

        .optimizer-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .optimizer-scroll-container::-webkit-scrollbar-track {
            background: #fef2f6;
            border-radius: 4px;
        }

        .optimizer-scroll-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #f9bed7 0%, #e9448b 100%);
            border-radius: 4px;
        }

        .price-compare-arrow {
            animation: bounceRight 1s ease-in-out infinite;
        }

        @keyframes bounceRight {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(4px);
            }
        }

        .apply-all-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }

        .apply-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .close-optimizer-btn {
            transition: all 0.2s ease;
        }

        .close-optimizer-btn:hover {
            background-color: #f3f4f6;
            transform: scale(1.05);
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col md:flex-row antialiased">

    <!-- Mobile Header -->
    <header
        class="md:hidden bg-brand-pink-600 text-white p-4 flex justify-between items-center sticky top-0 z-40 shadow-md">
        <div class="flex items-center gap-2">
            <svg class="w-6 h-6 text-brand-pink-100" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 11.25v8.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5v-8.25M12 4.875A3.375 3.375 0 006.375 8.25v2.25H17.625v-2.25A3.375 3.375 0 0012 4.875z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75v6.75h6.75v-6.75H12z" />
            </svg>
            <h1 class="text-xl font-bold">BearBake</h1>
        </div>
        <button id="mobile-menu-btn" class="text-white focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
    </header>

    <aside class="w-64 h-screen bg-brand-pink-600 text-white flex-col p-4 sticky top-0 hidden md:flex">
        <div class="flex items-center gap-3 px-3 mb-10">
            <svg class="w-8 h-8 text-brand-pink-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 11.25v8.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5v-8.25M12 4.875A3.375 3.375 0 006.375 8.25v2.25H17.625v-2.25A3.375 3.375 0 0012 4.875z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75v6.75h6.75v-6.75H12z" />
            </svg>
            <h1 class="text-2xl font-bold">BearBake</h1>
        </div>
        <nav>
            <ul class="space-y-2">
                <li><a href="#home" id="nav-home"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        <span>Home</span></a>
                </li>

                <li><a href="#recipes" id="nav-recipes"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <span>Recipes</span></a>
                </li>
                <li><a href="#ingredients" id="nav-ingredients"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <span>Ingredients</span></a>
                </li>
                <li><a href="#inventory" id="nav-inventory"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        <span>Inventory</span></a>
                </li>
                <!-- Financial Management Section -->
                <li class="pt-4 pb-1">
                    <span class="text-xs font-semibold text-brand-pink-200 uppercase tracking-wider px-3">Financial
                        Management</span>
                </li>
                <li><a href="#supplier" id="nav-supplier"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Supplier Comparison</span></a>
                </li>
                <li><a href="#budget" id="nav-budget"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <span>Production & Budget</span></a></li>
                <li><a href="#settings" id="nav-settings"
                        class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>Settings</span></a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 bg-brand-pink-600 z-50 text-white p-6 hidden flex-col">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold">Menu</h2>
            <button id="close-mobile-menu-btn" class="p-2 hover:bg-white/10 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav class="flex-1">
            <ul class="space-y-4 text-lg">
                <li><a href="#home" id="mob-nav-home"
                        class="flex items-center gap-4 p-3 rounded-lg hover:bg-white/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        Home</a></li>
                <li><a href="#recipes" id="mob-nav-recipes"
                        class="flex items-center gap-4 p-3 rounded-lg hover:bg-white/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        Recipes</a></li>
                <li><a href="#ingredients" id="mob-nav-ingredients"
                        class="flex items-center gap-4 p-3 rounded-lg hover:bg-white/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        Ingredients</a></li>
                <li><a href="#inventory" id="mob-nav-inventory"
                        class="flex items-center gap-4 p-3 rounded-lg hover:bg-white/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        Inventory</a></li>
                <!-- Financial Management Section Mobile -->
                <li class="pt-4 pb-1">
                    <span class="text-xs font-semibold text-brand-pink-200 uppercase tracking-wider">Financial
                        Management</span>
                </li>
                <li><a href="#supplier" id="mob-nav-supplier"
                        class="flex items-center gap-4 p-3 rounded-lg hover:bg-white/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Supplier Comparison</a></li>
                <li><a href="#budget" id="mob-nav-budget"
                        class="flex items-center gap-4 p-3 rounded-lg hover:bg-white/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Production & Budget</a></li>
                <li><a href="#settings" id="mob-nav-settings"
                        class="flex items-center gap-4 p-3 rounded-lg hover:bg-white/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Settings</a>
                </li>
            </ul>
        </nav>
    </div>

    <main class="flex-1 p-4 md:p-8 lg:p-10 w-full overflow-x-hidden">

        <!-- Redesigned Homepage -->
        <div id="home-page">
            <div class="max-w-6xl mx-auto">
                <!-- Hero Section -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-visible mb-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div class="p-8 lg:p-12 order-2 md:order-1">
                            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">Bake Smarter,<br>Not Harder
                                with <span class="text-brand-pink-600">BearBake Calculator</span></h1>
                            <p class="text-lg text-gray-600 mb-8">Calculate costs, maximize profits, and streamline your
                                baking business with our all-in-one dessert management platform.</p>
                            <div class="flex flex-wrap gap-4">
                                <button id="home-to-recipes-btn"
                                    class="cta-button py-3 px-8 text-white font-semibold rounded-lg transition-all duration-200">
                                    Get Started
                                </button>
                                <button id="home-to-ingredients-btn"
                                    class="secondary-button py-3 px-8 text-gray-800 font-semibold rounded-lg transition-all duration-200">
                                    Explore Features
                                </button>
                            </div>
                        </div>
                        <div class="order-1 md:order-2 p-8 relative">
                            <div class="w-[300px] h-[380px]"></div>

                            <div class="absolute inset-0 flex justify-end items-end">
                                <div class="relative w-[700px] h-[490px] float -mt-10">
                                    <img src="https://cdn.jsdelivr.net/gh/Starverz/my-svg-assets/Bake%20Bear%20Mascot-01.svg"
                                        alt="Bake Bear Mascot" class="w-full h-full">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="stats-card rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-brand-pink-600 mb-2">100%</div>
                        <p class="text-gray-700">Control your cost & profit with ease</p>
                    </div>
                    <div class="stats-card rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-brand-pink-600 mb-2">10x</div>
                        <p class="text-gray-700">Faster cost calculation</p>
                    </div>
                    <div class="stats-card rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-brand-pink-600 mb-2">100%</div>
                        <p class="text-gray-700">Recipes calculated instantaneously</p>
                    </div>
                </div>

                <!-- Features Section -->
                <div class="mb-16">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">Everything You Need to Succeed</h2>
                    <p class="text-gray-600 text-center max-w-2xl mx-auto mb-12">Our comprehensive tools help you manage
                        every aspect of your dessert business in one place.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="feature-card bg-white rounded-xl p-6">
                            <div class="w-12 h-12 rounded-full bg-brand-pink-100 flex items-center justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Recipe Costing</h3>
                            <p class="text-gray-600">Calculate exact costs for every dessert with automatic ingredient
                                pricing.</p>
                        </div>

                        <div class="feature-card bg-white rounded-xl p-6">
                            <div class="w-12 h-12 rounded-full bg-brand-pink-100 flex items-center justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Profit Analysis</h3>
                            <p class="text-gray-600">Set profit margins and instantly see your selling price
                                recommendations.</p>
                        </div>

                        <div class="feature-card bg-white rounded-xl p-6">
                            <div class="w-12 h-12 rounded-full bg-brand-pink-100 flex items-center justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Production Planning</h3>
                            <p class="text-gray-600">Schedule production, manage teams, and optimize your baking
                                workflow.</p>
                        </div>

                        <div class="feature-card bg-white rounded-xl p-6">
                            <div class="w-12 h-12 rounded-full bg-brand-pink-100 flex items-center justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Ingredient Library</h3>
                            <p class="text-gray-600">Track all your ingredients with current prices and unit
                                conversions.</p>
                        </div>

                        <div class="feature-card bg-white rounded-xl p-6">
                            <div class="w-12 h-12 rounded-full bg-brand-pink-100 flex items-center justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Data Security</h3>
                            <p class="text-gray-600">Your data stays private with local storage and easy backup options.
                            </p>
                        </div>

                        <div class="feature-card bg-white rounded-xl p-6">
                            <div class="w-12 h-12 rounded-full bg-brand-pink-100 flex items-center justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Recipe Book</h3>
                            <p class="text-gray-600">Create beautiful recipe books with ingredients and preparation
                                steps.</p>
                        </div>
                    </div>
                </div>

                <!-- CTA Section -->
                <div class="bg-brand-pink-600 rounded-2xl p-10 text-center text-white">
                    <h2 class="text-3xl font-bold mb-4">Ready to Transform Your Baking Business?</h2>
                    <p class="text-brand-pink-100 max-w-2xl mx-auto mb-8">Join thousands of bakers who are already
                        saving time and increasing profits with BearBake Calculator.</p>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button id="home-to-recipes-btn-2"
                            class="bg-white text-brand-pink-600 py-3 px-8 font-semibold rounded-lg shadow-md hover:bg-gray-100 transition-all duration-200">
                            Start Calculating Now
                        </button>
                        <button id="home-to-ingredients-btn-2"
                            class="bg-transparent border-2 border-white text-white py-3 px-8 font-semibold rounded-lg hover:bg-white hover:text-brand-pink-600 transition-all duration-200">
                            Take a Tour
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="budget-page" class="hidden">
            <div class="max-w-7xl mx-auto space-y-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">Production & Financials</h2>
                    <p class="text-gray-500 mt-1">A complete overview of your production schedule and team financials.
                    </p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">Monthly Production Planner</h3>
                    </div>
                    <div id="production-planner-container" class="p-6"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Team Financials</h3>
                                <p class="text-sm text-gray-500">Manage your teams and their specific budgets.</p>
                            </div>
                            <button id="open-add-team-modal-btn"
                                class="py-2 px-4 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-all duration-200 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    class="w-5 h-5">
                                    <path
                                        d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                                </svg>
                                Add Team
                            </button>
                        </div>
                    </div>
                    <div id="team-list" class="p-6 bg-gray-50">
                        <p class="text-center text-gray-500">No teams created yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-page" class="hidden">
            <div class="max-w-4xl mx-auto space-y-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">Settings</h2>
                    <p class="text-gray-500 mt-1">Manage your application data.</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">Data Management</h3>
                        <p class="text-sm text-gray-500">Export a backup of your data, or import data from a file.</p>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-700">Export All Data</p>
                                <p class="text-sm text-gray-500">Save a JSON file of all your recipes, ingredients, and
                                    teams.</p>
                            </div>
                            <button id="export-data-btn"
                                class="py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-sm hover:bg-gray-700 transition-all duration-200">Export</button>
                        </div>
                        <div class="flex items-center justify-between pt-4 border-t">
                            <div>
                                <p class="font-medium text-gray-700">Import Data</p>
                                <p class="text-sm text-gray-500">Load data from a JSON backup file. This will overwrite
                                    current data.</p>
                            </div>
                            <button id="import-data-btn"
                                class="py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-sm hover:bg-gray-700 transition-all duration-200">Import</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-red-300">
                    <div class="p-6 border-b border-red-300">
                        <h3 class="text-lg font-semibold text-red-800">Danger Zone</h3>
                    </div>
                    <div class="p-6 flex items-center justify-between">
                        <div>
                            <p class="font-medium text-red-700">Reset All Data</p>
                            <p class="text-sm text-gray-500">This will permanently delete all recipes, ingredients, and
                                teams.</p>
                        </div>
                        <button id="reset-data-btn"
                            class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-sm hover:bg-red-700 transition-all duration-200">Reset
                            Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ingredients-page" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Ingredient Library</h2>
                        <p class="text-gray-500 mt-1">Manage your inventory of raw materials.</p>
                    </div>
                    <button id="open-add-ingredient-modal-btn"
                        class="py-2 px-4 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-all duration-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path
                                d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                        </svg>
                        Add Ingredient
                    </button>
                </div>
                <div class="mb-6 flex flex-wrap gap-4">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                        <input type="text" id="ingredient-search-input" placeholder="Search by name..."
                            class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <select id="ingredient-sort-select"
                        class="p-2 border border-gray-300 rounded-lg focus-ring bg-white">
                        <option value="latest">Sort by: Latest</option>
                        <option value="oldest">Sort by: Oldest</option>
                        <option value="name-az">Name: A-Z</option>
                        <option value="name-za">Name: Z-A</option>
                        <option value="price-desc">Cost: High to Low</option>
                        <option value="price-asc">Cost: Low to High</option>
                        <option value="weight-desc">Amount: High to Low</option>
                        <option value="weight-asc">Amount: Low to High</option>
                    </select>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div id="ingredient-list" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <div id="inventory-page" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Inventory Management</h2>
                        <p class="text-gray-500 mt-1">Track stock levels for your ingredients.</p>
                    </div>
                </div>

                <!-- Dashboard Cards -->
                <!-- Dashboard Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-brand-pink-100 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Total Items</p>
                                <p id="inventory-total-items" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Out of Stock Alerts</p>
                                <p id="inventory-out-of-stock-count" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Low Stock Alerts</p>
                                <p id="inventory-low-stock-count" class="text-2xl font-bold text-amber-600">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Total Stock Value</p>
                                <p id="inventory-total-value" class="text-2xl font-bold text-green-600">RM 0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search & Filter Controls -->
                <div class="mb-6 flex flex-wrap gap-4">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                        <input type="text" id="inventory-search-input" placeholder="Search inventory..."
                            class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <select id="inventory-filter-select"
                        class="p-2 border border-gray-300 rounded-lg focus-ring bg-white">
                        <option value="all">Show: All Items</option>
                        <option value="low-stock">Low Stock Only</option>
                        <option value="in-stock">In Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                    <select id="inventory-sort-select"
                        class="p-2 border border-gray-300 rounded-lg focus-ring bg-white">
                        <option value="name-az">Name: A-Z</option>
                        <option value="name-za">Name: Z-A</option>
                        <option value="stock-asc">Stock: Low to High</option>
                        <option value="stock-desc">Stock: High to Low</option>
                        <option value="value-desc">Value: High to Low</option>
                    </select>
                </div>

                <!-- Inventory Grid -->
                <div id="inventory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Inventory items will be rendered here -->
                </div>

                <!-- Empty State -->
                <div id="inventory-empty-state" class="hidden text-center py-16">
                    <div class="mx-auto w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">No Ingredients Yet</h3>
                    <p class="text-gray-500 mb-4">Add ingredients to your library to start tracking inventory.</p>
                    <button id="inventory-go-to-ingredients-btn"
                        class="py-2 px-4 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-all duration-200">
                        Go to Ingredients
                    </button>
                </div>
            </div>
        </div>

        <div id="recipes-page">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Your Recipes</h2>
                        <p class="text-gray-500 mt-1">Manage and calculate costs for your recipes.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="view-recipe-book-btn"
                            class="py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-sm hover:bg-gray-700 transition-all duration-200 flex items-center gap-2">
                            View Recipe Book
                        </button>
                        <button id="open-add-recipe-modal-btn"
                            class="py-2 px-4 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-all duration-200 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-5 h-5">
                                <path
                                    d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                            </svg>
                            Add Recipe
                        </button>
                    </div>
                </div>
                <div class="mb-6 flex flex-wrap gap-4">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                        <input type="text" id="recipe-search-input" placeholder="Search by title..."
                            class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <select id="recipe-sort-select"
                        class="p-2 border border-gray-300 rounded-lg focus-ring bg-white w-52">
                        <option value="latest">Sort by: Latest</option>
                        <option value="oldest">Sort by: Oldest</option>
                        <option value="title-az">Title: A-Z</option>
                        <option value="title-za">Title: Z-A</option>
                        <option value="cost-desc">Total Cost: High to Low</option>
                        <option value="cost-asc">Total Cost: Low to High</option>
                    </select>
                </div>

                <div id="recipe-category-filters" class="flex flex-wrap gap-2 mb-6"></div>

                <div class="space-y-6" id="recipe-list-display"></div>
            </div>
        </div>

        <div id="recipe-book-page" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Your Recipe Book</h2>
                        <p class="text-gray-500 mt-1">A collection of your recipes with preparation instructions.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="back-to-recipes-btn"
                            class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">
                            &larr; Back to Recipe Costs
                        </button>
                        <button id="manage-categories-btn"
                            class="py-2 px-4 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-all duration-200">
                            Manage Categories
                        </button>
                    </div>
                </div>
                <div class="mb-6 flex flex-wrap gap-4">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                        <input type="text" id="recipe-book-search-input" placeholder="Search by title..."
                            class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <select id="recipe-book-sort-select"
                        class="p-2 border border-gray-300 rounded-lg focus-ring bg-white w-52">
                        <option value="latest">Sort by: Latest</option>
                        <option value="oldest">Sort by: Oldest</option>
                        <option value="title-az">Title: A-Z</option>
                        <option value="title-za">Title: Z-A</option>
                    </select>
                </div>
                <div id="recipe-book-category-filters" class="flex flex-wrap gap-2 mb-6"></div>

                <div id="recipe-book-list" class="space-y-8"></div>
                <div id="recipe-book-pagination" class="mt-8 flex justify-center items-center space-x-2"></div>
            </div>
        </div>
        <div id="supplier-dashboard-page" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Supplier Comparison</h2>
                    <p class="text-gray-500 mt-1">Analyze ingredient costs across different vendors to maximize savings.
                    </p>
                </div>
                <button id="optimize-shopping-list-btn"
                    class="py-2.5 px-6 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-md hover:bg-brand-pink-700 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Run Shopping List Optimizer
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-brand-pink-100 flex items-center gap-4">
                    <div class="p-3 bg-brand-pink-50 text-brand-pink-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Suppliers</h4>
                        <p class="text-2xl font-bold text-gray-800" id="total-suppliers-count">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-green-100 flex items-center gap-4">
                    <div class="p-3 bg-green-50 text-green-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Ingredients Checked</h4>
                        <p class="text-2xl font-bold text-gray-800" id="ingredients-checked-count">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-100 flex items-center gap-4">
                    <div class="p-3 bg-blue-50 text-blue-600 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Cost Variance</h4>
                        <p class="text-sm text-gray-500">Price difference between highest & lowest</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="text-xl font-bold text-gray-800">Wholesale Value Matrix</h3>
                    <div class="flex items-center gap-2">

                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input type="text" id="supplier-search-input" placeholder="Filter ingredients..."
                                class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand-pink-500 focus:border-brand-pink-500 outline-none w-64">
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-bold tracking-wider">
                            <tr>
                                <th class="p-4 border-b w-12 text-center">#</th>
                                <th class="p-4 border-b">Name</th>
                                <th class="p-4 border-b">Active Source</th>
                                <th class="p-4 border-b">Best Price</th>
                                <th class="p-4 border-b text-center">Status</th>
                                <th class="p-4 border-b text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-matrix-body"
                            class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                    <div id="supplier-empty-state" class="hidden p-8 text-center text-gray-500">
                        No ingredients found. Add ingredients with multiple suppliers to see the comparison.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="add-ingredient-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div class="px-6 pt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Ingredient</h3>
            </div>
            <form id="add-ingredient-form" class="px-6 space-y-3">
                <div>
                    <label for="add-name" class="block text-sm font-medium text-gray-700 mb-1">Ingredient Name</label>
                    <input type="text" id="add-name" required placeholder="e.g., All Purpose Flour"
                        class="w-full p-2 border border-gray-300 rounded-lg focus-ring">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="add-price" class="block text-sm font-medium text-gray-700 mb-1">Price (RM)</label>
                        <input type="number" id="add-price" step="0.01" min="0" required placeholder="10.50"
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <div>
                        <label for="add-weight" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                        <input type="number" id="add-weight" step="0.01" min="0" required placeholder="1"
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <div>
                        <label for="add-unit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <select id="add-unit" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring bg-white">
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="l">l</option>
                            <option value="ml">ml</option>
                            <option value="pcs">pcs</option>
                        </select>
                    </div>
                </div>
            </form>
            <div class="flex justify-end items-center px-6 py-3 border-t bg-gray-50 rounded-b-xl gap-4 mt-4">
                <button type="button" id="add-ingredient-modal-cancel-btn"
                    class="py-2 px-4 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                <button type="submit" form="add-ingredient-form"
                    class="py-2 px-4 bg-brand-pink-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors">Add
                    Ingredient</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[95vh]">
            <div class="px-6 pt-3 border-b pb-0 relative">
                <h3 class="text-xl font-bold text-gray-800">Edit Ingredient</h3>
                <div class="relative w-full flex items-center gap-1">
                    <button type="button" id="tab-scroll-left"
                        class="hidden flex-shrink-0 z-10 p-1 bg-gray-100 text-black hover:bg-gray-200 rounded-full shadow-md border border-gray-300 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div id="edit-supplier-tabs"
                        class="supplier-tabs-container flex-1 flex overflow-x-auto no-scrollbar scroll-smooth px-1 items-center">
                        <!-- Tabs will be injected here -->
                        <button type="button" id="add-tab-btn"
                            class="ml-1 text-gray-400 hover:text-white px-2 rounded hover:bg-white/10 text-xl font-light h-full flex items-center mb-1 flex-shrink-0">+</button>
                    </div>
                    <button type="button" id="tab-scroll-right"
                        class="hidden flex-shrink-0 z-10 p-1 bg-gray-100 text-black hover:bg-gray-200 rounded-full shadow-md border border-gray-300 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
            <form id="edit-form" class="p-6 space-y-5 overflow-y-auto">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="edit-name" class="block text-sm font-medium text-gray-700">Ingredient Name</label>
                        <button type="button" id="edit-active-toggle" class="active-price-toggle inactive">
                            <span class="w-2 h-2 rounded-full bg-gray-400 indicator-dot"></span>
                            <span class="text-xs font-semibold toggle-text">Set Active Price</span>
                        </button>
                    </div>
                    <input type="text" id="edit-name" required placeholder="e.g., Sugar"
                        class="w-full p-2 border border-gray-300 rounded-lg focus-ring">
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label for="edit-price" class="block text-sm font-medium text-gray-700 mb-1">Price
                            (RM)</label><input type="number" id="edit-price" step="0.01" min="0" required
                            placeholder="10.00" class="w-full p-2 border border-gray-300 rounded-lg focus-ring"></div>
                    <div><label for="edit-weight"
                            class="block text-sm font-medium text-gray-700 mb-1">Amount</label><input type="number"
                            id="edit-weight" step="0.01" min="0" required placeholder="1"
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring"></div>
                    <div><label for="edit-unit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label><select
                            id="edit-unit" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring bg-white">
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="l">l</option>
                            <option value="ml">ml</option>
                            <option value="pcs">pcs</option>
                        </select></div>
                </div>
                <div class="pt-4 border-t">
                    <h4 class="font-semibold text-gray-800 mb-1">Unit Conversions</h4>
                    <p class="text-sm text-gray-500 mb-3">Define custom volumetric measurements (e.g., 1 cup = 120g).
                    </p>
                    <div id="edit-conversions-list" class="space-y-2"></div>
                    <button type="button" id="add-conversion-btn"
                        class="mt-2 text-sm font-semibold text-brand-pink-600 hover:text-brand-pink-800">+ Add
                        Conversion</button>
                </div>
                <div class="pt-4 border-t">
                    <h4 class="font-semibold text-gray-800 mb-1">Inventory Tracking</h4>
                    <p class="text-sm text-gray-500 mb-3">Track stock levels for this ingredient.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="edit-stock-qty" class="block text-sm font-medium text-gray-700 mb-1">Current
                                Stock</label>
                            <div class="flex">
                                <input type="number" id="edit-stock-qty" step="0.01" min="0" placeholder="0"
                                    class="w-full p-2 border border-gray-300 rounded-l-lg focus-ring">
                                <select id="edit-stock-unit"
                                    class="px-2 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600 text-sm focus-ring">
                                    <option value="g">g</option>
                                    <option value="kg">kg</option>
                                    <option value="ml">ml</option>
                                    <option value="l">l</option>
                                    <option value="pcs">pcs</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="edit-reorder-level" class="block text-sm font-medium text-gray-700 mb-1">Reorder
                                Level</label>
                            <div class="flex">
                                <input type="number" id="edit-reorder-level" step="0.01" min="0" placeholder="0"
                                    class="w-full p-2 border border-gray-300 rounded-l-lg focus-ring">
                                <span id="edit-reorder-unit"
                                    class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600 text-sm flex items-center">kg</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="edit-stock-location" class="block text-sm font-medium text-gray-700 mb-1">Storage
                            Location <span class="text-gray-400">(Optional)</span></label>
                        <input type="text" id="edit-stock-location" placeholder="e.g., Chiller A, Shelf 2"
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring">
                    </div>
                </div>
                <div class="pt-4 border-t space-y-4">
                    <div><label for="edit-supplier" class="block text-sm font-medium text-gray-700 mb-1">Supplier Name
                            <span class="text-gray-400">(Optional)</span></label><input type="text" id="edit-supplier"
                            placeholder="e.g., Bakery Supply Co"
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring"></div>
                    <div><label for="edit-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes <span
                                class="text-gray-400">(Optional)</span></label><textarea id="edit-notes" rows="3"
                            placeholder="e.g., Halal certified"
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring"></textarea></div>
                </div>
            </form>
            <div
                class="flex flex-col md:flex-row md:justify-between md::items-center px-6 py-3 border-t bg-gray-50 rounded-b-xl mt-auto gap-3">
                <div class="flex justify-between items-center w-full md:w-auto">
                    <button type="button" id="modal-delete-btn"
                        class="py-2 px-3 bg-red-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-red-700 transition-colors">Delete</button>

                    <!-- Mobile History Controls (Synced via Script) -->
                    <div id="edit-history-controls-mobile" class="hidden flex gap-3 md:hidden border-gray-300">
                        <button type="button" id="edit-undo-btn-mobile"
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Undo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                            </svg>
                        </button>
                        <button type="button" id="edit-redo-btn-mobile"
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Redo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-3 w-full md:w-auto">
                    <!-- Desktop History Controls (Hidden on mobile via wrapper) -->
                    <div class="hidden md:block">
                        <div id="edit-history-controls"
                            class="hidden flex gap-3 md:border-r md:pr-6 md:mr-2 border-gray-300">
                            <button type="button" id="edit-undo-btn"
                                class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                title="Undo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                </svg>
                            </button>
                            <button type="button" id="edit-redo-btn"
                                class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                title="Redo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="modal-cancel-btn"
                        class="flex-1 md:flex-none py-2 px-4 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" form="edit-form" id="modal-done-btn"
                        class="flex-1 md:flex-none py-2 px-4 bg-brand-pink-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors whitespace-nowrap">Save
                        Changes</button>
                </div>
            </div>
            <script>
                    // Proxy Script for Mobile History Buttons
                    (function () {
                        const desktopContainer = document.getElementById('edit-history-controls');
                        const mobileContainer = document.getElementById('edit-history-controls-mobile');
                        const desktopUndo = document.getElementById('edit-undo-btn');
                        const desktopRedo = document.getElementById('edit-redo-btn');
                        const mobileUndo = document.getElementById('edit-undo-btn-mobile');
                        const mobileRedo = document.getElementById('edit-redo-btn-mobile');

                        // 1. Proxy Clicks
                        mobileUndo.addEventListener('click', () => desktopUndo.click());
                        mobileRedo.addEventListener('click', () => desktopRedo.click());

                        // 2. Sync Visibility & State
                        const syncState = () => {
                            // Sync Visibility (Hidden class)
                            if (desktopContainer.classList.contains('hidden')) {
                                mobileContainer.classList.add('hidden');
                            } else {
                                mobileContainer.classList.remove('hidden');
                            }

                            // Sync Disabled State
                            mobileUndo.disabled = desktopUndo.disabled;
                            mobileRedo.disabled = desktopRedo.disabled;
                        };

                        // Initial Sync
                        syncState();

                        // Observe Changes on Desktop Container (for visibility) and Buttons (for disabled)
                        const observer = new MutationObserver(syncState);
                        observer.observe(desktopContainer, { attributes: true, attributeFilter: ['class'] });
                        observer.observe(desktopUndo, { attributes: true, attributeFilter: ['disabled'] });
                        observer.observe(desktopRedo, { attributes: true, attributeFilter: ['disabled'] });
                    })();
            </script>
        </div>
    </div>

    <div id="add-recipe-modal"
        class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
            <div class="px-6 py-3 border-b">
                <h3 class="text-xl font-bold text-gray-800">Create New Recipe</h3>
            </div>
            <form id="recipe-form" class="p-6 space-y-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <label for="recipe-title" class="block text-sm font-medium text-gray-700 mb-1">Recipe
                            Title</label>
                        <input type="text" id="recipe-title" required placeholder="e.g., Chocolate Cake"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <div>
                        <label for="recipe-category"
                            class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="recipe-category"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Yields</label>
                    <select id="recipe-yield-type"
                        class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white mb-2">
                        <option value="quantity">By Quantity (e.g., 12 pcs)</option>
                        <option value="size">By Pan Size (e.g., 8-inch Loaf)</option>
                    </select>
                    <div id="yield-quantity-fields">
                        <div class="grid grid-cols-3 gap-2"><input type="number" id="recipe-servings-value" min="1"
                                placeholder="e.g., 12"
                                class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><select
                                id="recipe-servings-unit"
                                class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus-ring">
                                <option value="pcs">pcs</option>
                                <option value="Slice">Slice</option>
                                <option value="Cup">Cup</option>
                                <option value="Cookie">Cookie</option>
                            </select></div>
                    </div>
                    <div id="yield-size-fields" class="hidden space-y-2">
                        <select id="recipe-pan-shape"
                            class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus-ring">
                            <option value="rectangular">Rectangular / Square</option>
                            <option value="round">Round</option>
                        </select>
                        <div id="pan-shape-rectangular" class="grid grid-cols-3 gap-2"><input type="number" step="0.1"
                                id="recipe-pan-length" placeholder="Length (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><input type="number"
                                step="0.1" id="recipe-pan-width" placeholder="Width (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><input type="number"
                                step="0.1" id="recipe-pan-height" placeholder="Height (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"></div>
                        <div id="pan-shape-round" class="hidden grid grid-cols-2 gap-2"><input type="number" step="0.1"
                                id="recipe-pan-diameter" placeholder="Diameter (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><input type="number"
                                step="0.1" id="recipe-pan-height-round" placeholder="Height (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"></div>
                        <div class="grid grid-cols-3 gap-2 pt-1"><input type="number" min="1" value="1"
                                id="recipe-pan-quantity"
                                class="col-span-1 w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><select
                                id="recipe-pan-unit"
                                class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg bg-white focus-ring">
                                <option value="Loaf">Loaf</option>
                                <option value="Cake">Cake</option>
                                <option value="Tart">Tart</option>
                            </select></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Ingredients & Costs</h4>
                    <div id="recipe-ingredients-list" class="space-y-3"></div>
                    <div class="mt-4 flex items-center gap-3"><button type="button" id="add-library-ingredient-btn"
                            class="py-2 px-4 bg-brand-pink-50 text-brand-pink-700 font-semibold rounded-lg text-sm hover:bg-brand-pink-100 transition-colors">+
                            Add from Library</button><button type="button" id="add-open-item-btn"
                            class="py-2 px-4 bg-gray-100 text-gray-700 font-semibold rounded-lg text-sm hover:bg-gray-200 transition-colors">+
                            Add Open Item</button></div>
                </div>
                <div>
                    <h4 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Profit Calculation</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="profit-type"
                                class="block text-sm font-medium text-gray-700 mb-1">Method</label><select
                                id="profit-type"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white">
                                <option value="percent">Percent (%)</option>
                                <option value="multiplier" selected>Multiplier (x)</option>
                            </select></div>
                        <div><label for="profit-value"
                                class="block text-sm font-medium text-gray-700 mb-1">Value</label><input type="number"
                                id="profit-value" step="0.01" min="0" placeholder="3" required
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"></div>
                    </div>
                </div>
            </form>
            <div class="flex justify-between items-center px-6 py-3 border-t bg-gray-50 rounded-b-xl mt-auto">
                <div></div>
                <div class="flex items-center gap-4">
                    <div id="add-recipe-history-controls" class="hidden flex gap-3 mr-2 border-r pr-6 border-gray-300">
                        <button type="button" id="add-recipe-undo-btn"
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Undo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                            </svg>
                        </button>
                        <button type="button" id="add-recipe-redo-btn"
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Redo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                            </svg>
                        </button>
                    </div>
                    <button type="button" id="add-recipe-modal-cancel-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" form="recipe-form"
                        class="py-2 px-4 bg-brand-pink-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors">Add
                        Recipe</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-recipe-modal"
        class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
            <div class="px-6 py-3 border-b">
                <h3 class="text-xl font-bold text-gray-800">Edit Recipe</h3>
            </div>
            <form id="edit-recipe-form" class="p-6 space-y-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <label for="edit-recipe-title" class="block text-sm font-medium text-gray-700 mb-1">Recipe
                            Title</label>
                        <input type="text" id="edit-recipe-title" required placeholder="e.g., Chocolate Cake"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <div>
                        <label for="edit-recipe-category"
                            class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="edit-recipe-category"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Yields</label>
                    <select id="edit-recipe-yield-type"
                        class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white mb-2">
                        <option value="quantity">By Quantity (e.g., 12 pcs)</option>
                        <option value="size">By Pan Size (e.g., 8-inch Loaf)</option>
                    </select>
                    <div id="edit-yield-quantity-fields">
                        <div class="grid grid-cols-3 gap-2"><input type="number" id="edit-recipe-servings-value" min="1"
                                class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><select
                                id="edit-recipe-servings-unit"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white">
                                <option value="pcs">pcs</option>
                                <option value="Slice">Slice</option>
                                <option value="Cup">Cup</option>
                                <option value="Cookie">Cookie</option>
                            </select></div>
                    </div>
                    <div id="edit-yield-size-fields" class="hidden space-y-2">
                        <select id="edit-recipe-pan-shape"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white">
                            <option value="rectangular">Rectangular / Square</option>
                            <option value="round">Round</option>
                        </select>
                        <div id="edit-pan-shape-rectangular" class="grid grid-cols-3 gap-2"><input type="number"
                                step="0.1" id="edit-recipe-pan-length" placeholder="Length (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><input type="number"
                                step="0.1" id="edit-recipe-pan-width" placeholder="Width (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><input type="number"
                                step="0.1" id="edit-recipe-pan-height" placeholder="Height (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"></div>
                        <div id="edit-pan-shape-round" class="hidden grid grid-cols-2 gap-2"><input type="number"
                                step="0.1" id="edit-recipe-pan-diameter" placeholder="Diameter (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><input type="number"
                                step="0.1" id="edit-recipe-pan-height-round" placeholder="Height (in)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"></div>
                        <div class="grid grid-cols-3 gap-2 pt-1"><input type="number" min="1"
                                id="edit-recipe-pan-quantity" placeholder="Qty"
                                class="col-span-1 w-full p-2.5 border border-gray-300 rounded-lg focus-ring"><select
                                id="edit-recipe-pan-unit"
                                class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white">
                                <option value="Loaf">Loaf</option>
                                <option value="Cake">Cake</option>
                                <option value="Tart">Tart</option>
                            </select></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Ingredients & Costs</h4>
                    <div id="edit-recipe-ingredients-list" class="space-y-3"></div>
                    <div class="mt-4 flex items-center gap-3"><button type="button" id="edit-add-library-ingredient-btn"
                            class="py-2 px-4 bg-brand-pink-50 text-brand-pink-700 font-semibold rounded-lg text-sm hover:bg-brand-pink-100 transition-colors">+
                            Add from Library</button><button type="button" id="edit-add-open-item-btn"
                            class="py-2 px-4 bg-gray-100 text-gray-700 font-semibold rounded-lg text-sm hover:bg-gray-200 transition-colors">+
                            Add Open Item</button></div>
                </div>
                <div>
                    <h4 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Profit Calculation</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="edit-profit-type"
                                class="block text-sm font-medium text-gray-700 mb-1">Method</label><select
                                id="edit-profit-type"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring bg-white">
                                <option value="percent">Percent (%)</option>
                                <option value="multiplier" selected>Multiplier (x)</option>
                            </select></div>
                        <div><label for="edit-profit-value"
                                class="block text-sm font-medium text-gray-700 mb-1">Value</label><input type="number"
                                id="edit-profit-value" step="0.01" min="0" required placeholder="3"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring"></div>
                    </div>
                </div>
            </form>
            <div class="flex justify-between items-center px-6 py-3 border-t bg-gray-50 rounded-b-xl mt-auto">
                <button type="button" id="edit-recipe-modal-delete-btn"
                    class="py-2 px-3 bg-red-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-red-700 transition-colors">Delete</button>
                <div class="flex items-center gap-4">
                    <div id="edit-recipe-history-controls" class="hidden flex gap-3 mr-2 border-r pr-6 border-gray-300">
                        <button type="button" id="edit-recipe-undo-btn"
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Undo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                            </svg>
                        </button>
                        <button type="button" id="edit-recipe-redo-btn"
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Redo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                            </svg>
                        </button>
                    </div>
                    <button type="button" id="edit-recipe-modal-cancel-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" form="edit-recipe-form"
                        class="py-2 px-4 bg-brand-pink-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="add-team-modal"
        class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">Add New Team</h3>
            </div>
            <form id="team-form" class="flex-1 flex flex-col overflow-hidden">
                <div class="p-6 space-y-6 overflow-y-auto">
                    <div>
                        <label for="team-name" class="block text-sm font-medium text-gray-700 mb-1">Team Name</label>
                        <input type="text" id="team-name" placeholder="e.g., Donut Baking Team"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus-ring">
                    </div>
                    <div>
                        <h4 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Manage Staff</h4>
                        <div id="staff-list" class="space-y-3"></div>
                        <button type="button" id="add-staff-btn"
                            class="mt-3 text-sm font-semibold text-brand-pink-600 hover:text-brand-pink-800">+ Add Staff
                            Member</button>
                    </div>
                    <div>
                        <h4 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Production Schedule</h4>
                        <div id="team-recipe-list" class="space-y-3"></div>
                        <button type="button" id="add-team-recipe-btn"
                            class="mt-3 text-sm font-semibold text-brand-pink-600 hover:text-brand-pink-800">+ Add
                            Recipe to Schedule</button>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h4 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Live Financial Summary</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                            <div><strong>Total Production Days:</strong> <span id="summary-total-days">0</span></div>
                            <div><strong>Total Labor Cost:</strong> <span id="summary-total-salary">RM 0.00</span></div>
                            <div class="col-span-2">
                                <h5 class="font-semibold text-gray-700 mt-3 mb-2">Per-Piece Costing Breakdown</h5>
                                <div id="summary-recipe-spending" class="space-y-2">
                                    <p class="text-xs text-gray-500">Select recipes and schedule dates to see the
                                        breakdown.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end items-center p-6 border-t bg-gray-50 rounded-b-xl mt-auto">
                    <div class="flex gap-4">
                        <button type="button" id="add-team-modal-cancel-btn"
                            class="py-2.5 px-6 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit"
                            class="py-2.5 px-6 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700">Create
                            Team</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="manage-categories-modal"
        class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div class="px-6 py-3 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Manage Categories</h3>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label for="new-category-name" class="block text-sm font-medium text-gray-700 mb-1">Add New
                        Category</label>
                    <div class="flex gap-2">
                        <input type="text" id="new-category-name" placeholder="e.g., Cakes, Cookies"
                            class="w-full p-2 border border-gray-300 rounded-lg focus-ring">
                        <button id="add-category-btn"
                            class="py-2 px-4 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700">Add</button>
                    </div>
                </div>
                <div>
                    <h4 class="text-base font-medium text-gray-800 mb-3">Registered Categories</h4>
                    <div id="category-list-in-modal"
                        class="space-y-2 max-h-60 overflow-y-auto overflow-hidden bg-gray-50 p-3 rounded-lg"></div>
                </div>
            </div>
            <div class="flex justify-end items-center p-4 border-t bg-gray-50 rounded-b-xl">
                <div class="flex items-center gap-4">
                    <div id="category-history-controls" class="hidden flex gap-3 mr-2 border-r pr-6 border-gray-300">
                        <button type="button" id="category-undo-btn" disabled
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Undo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                            </svg>
                        </button>
                        <button type="button" id="category-redo-btn" disabled
                            class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg shadow-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            title="Redo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                            </svg>
                        </button>
                    </div>
                    <button type="button" id="cancel-categories-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="button" id="save-categories-btn"
                        class="py-2 px-4 bg-brand-pink-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="preparation-editor-modal"
        class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b">
                <h3 class="text-xl font-bold text-gray-800">Edit Preparation Steps for <span id="editor-recipe-title"
                        class="text-brand-pink-600"></span></h3>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <div id="quill-editor" style="height: 400px;"></div>
            </div>
            <div class="flex justify-end items-center p-4 border-t bg-gray-50">
                <div class="flex gap-4">
                    <button type="button" id="editor-cancel-btn"
                        class="py-2 px-5 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="button" id="editor-save-btn"
                        class="py-2 px-5 bg-brand-pink-600 text-white font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700">Save
                        Instructions</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Supplier Dashboard Page -->


    <div id="planner-day-modal"
        class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800" id="planner-modal-title">Production Details</h3>
                <button id="planner-modal-close-btn" class="p-1 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                        class="w-5 h-5 text-gray-600">
                        <path
                            d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                </button>
            </div>
            <div id="planner-modal-body" class="p-6 space-y-4 overflow-y-auto"></div>
        </div>
    </div>

    <input type="file" id="import-file-input" class="hidden" accept=".json">



    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- PAGE & NAVIGATION ELEMENTS ---
            const navHome = document.getElementById('nav-home');
            const navRecipes = document.getElementById('nav-recipes');
            const navIngredients = document.getElementById('nav-ingredients');
            const navInventory = document.getElementById('nav-inventory');
            const navBudget = document.getElementById('nav-budget');
            const navSettings = document.getElementById('nav-settings');
            const ingredientsPage = document.getElementById('ingredients-page');
            const inventoryPage = document.getElementById('inventory-page');
            const recipesPage = document.getElementById('recipes-page');
            const budgetPage = document.getElementById('budget-page');
            const settingsPage = document.getElementById('settings-page');
            const homePage = document.getElementById('home-page');
            const homeToRecipesBtn = document.getElementById('home-to-recipes-btn');
            const homeToIngredientsBtn = document.getElementById('home-to-ingredients-btn');
            const homeToRecipesBtn2 = document.getElementById('home-to-recipes-btn-2');
            const homeToIngredientsBtn2 = document.getElementById('home-to-ingredients-btn-2');
            // --- FIX END ---

            // --- MOBILE MENU ELEMENTS ---
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const closeMobileMenuBtn = document.getElementById('close-mobile-menu-btn');
            const mobNavLinks = [
                document.getElementById('mob-nav-home'),
                document.getElementById('mob-nav-recipes'),
                document.getElementById('mob-nav-ingredients'),
                document.getElementById('mob-nav-inventory'),
                document.getElementById('mob-nav-budget'),
                document.getElementById('mob-nav-supplier'),
                document.getElementById('mob-nav-settings')
            ];

            // Mobile Menu Logic
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.remove('hidden');
                mobileMenu.classList.add('flex');
            });

            closeMobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.add('hidden');
                mobileMenu.classList.remove('flex');
            });

            mobNavLinks.forEach(link => {
                if (link) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        mobileMenu.classList.add('hidden');
                        mobileMenu.classList.remove('flex');
                        const targetId = link.id.replace('mob-nav-', '');
                        showPage(targetId);
                    });
                }
            });




            // --- INGREDIENT PAGE ELEMENTS ---
            const ingredientListDiv = document.getElementById('ingredient-list');
            const openAddIngredientModalBtn = document.getElementById('open-add-ingredient-modal-btn');
            const addIngredientModal = document.getElementById('add-ingredient-modal');
            const addIngredientForm = document.getElementById('add-ingredient-form');
            const addIngredientModalCancelBtn = document.getElementById('add-ingredient-modal-cancel-btn');
            const ingredientSearchInput = document.getElementById('ingredient-search-input');
            const ingredientSortSelect = document.getElementById('ingredient-sort-select');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const editNameInput = document.getElementById('edit-name'), editPriceInput = document.getElementById('edit-price'), editWeightInput = document.getElementById('edit-weight'), editUnitInput = document.getElementById('edit-unit'), editSupplierInput = document.getElementById('edit-supplier'), editNotesInput = document.getElementById('edit-notes');
            const modalCancelBtn = document.getElementById('modal-cancel-btn'), modalDeleteBtn = document.getElementById('modal-delete-btn');
            const conversionsListDiv = document.getElementById('edit-conversions-list'), addConversionBtn = document.getElementById('add-conversion-btn');

            // Undo/Redo Elements
            const editUndoBtn = document.getElementById('edit-undo-btn');
            const editRedoBtn = document.getElementById('edit-redo-btn');
            const editHistoryControls = document.getElementById('edit-history-controls');



            // --- RECIPE PAGE ELEMENTS ---
            const recipeListDisplay = document.getElementById('recipe-list-display');
            const recipeForm = document.getElementById('recipe-form');
            const recipeIngredientsList = document.getElementById('recipe-ingredients-list');
            const addLibraryIngredientBtn = document.getElementById('add-library-ingredient-btn');
            const addOpenItemBtn = document.getElementById('add-open-item-btn');
            const openAddRecipeModalBtn = document.getElementById('open-add-recipe-modal-btn');
            const addRecipeModal = document.getElementById('add-recipe-modal');
            const addRecipeModalCancelBtn = document.getElementById('add-recipe-modal-cancel-btn');
            const recipeSearchInput = document.getElementById('recipe-search-input');
            const recipeSortSelect = document.getElementById('recipe-sort-select');
            const editRecipeModal = document.getElementById('edit-recipe-modal');
            const editRecipeForm = document.getElementById('edit-recipe-form');
            const editRecipeIngredientsList = document.getElementById('edit-recipe-ingredients-list');
            const editAddLibraryIngredientBtn = document.getElementById('edit-add-library-ingredient-btn');
            const editAddOpenItemBtn = document.getElementById('edit-add-open-item-btn');
            const editRecipeModalCancelBtn = document.getElementById('edit-recipe-modal-cancel-btn');

            // --- RECIPE BOOK ELEMENTS ---
            const recipeBookPage = document.getElementById('recipe-book-page');
            const viewRecipeBookBtn = document.getElementById('view-recipe-book-btn');
            const backToRecipesBtn = document.getElementById('back-to-recipes-btn');
            const recipeBookList = document.getElementById('recipe-book-list');
            const preparationEditorModal = document.getElementById('preparation-editor-modal');
            const editorRecipeTitle = document.getElementById('editor-recipe-title');
            const editorCancelBtn = document.getElementById('editor-cancel-btn');
            const editorSaveBtn = document.getElementById('editor-save-btn');
            const manageCategoriesBtn = document.getElementById('manage-categories-btn');
            const manageCategoriesModal = document.getElementById('manage-categories-modal');
            const newCategoryNameInput = document.getElementById('new-category-name');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const categoryListInModal = document.getElementById('category-list-in-modal');
            const cancelCategoriesBtn = document.getElementById('cancel-categories-btn');
            const saveCategoriesBtn = document.getElementById('save-categories-btn');
            const categoryUndoBtn = document.getElementById('category-undo-btn');
            const categoryRedoBtn = document.getElementById('category-redo-btn');
            const categoryHistoryControls = document.getElementById('category-history-controls');
            const recipeBookSearchInput = document.getElementById('recipe-book-search-input');
            const recipeBookSortSelect = document.getElementById('recipe-book-sort-select');
            const recipeBookPagination = document.getElementById('recipe-book-pagination');
            const categoryFiltersContainer = document.getElementById('recipe-book-category-filters');
            const recipeCategoryFiltersContainer = document.getElementById('recipe-category-filters');

            // --- BUDGET PAGE ELEMENTS ---
            const openAddTeamModalBtn = document.getElementById('open-add-team-modal-btn');
            const addTeamModal = document.getElementById('add-team-modal');
            const addTeamModalCancelBtn = document.getElementById('add-team-modal-cancel-btn');
            const addStaffBtn = document.getElementById('add-staff-btn');
            const staffList = document.getElementById('staff-list');
            const addTeamRecipeBtn = document.getElementById('add-team-recipe-btn');
            const teamRecipeList = document.getElementById('team-recipe-list');
            const teamForm = document.getElementById('team-form');
            const productionPlannerContainer = document.getElementById('production-planner-container');

            // --- SETTINGS PAGE ELEMENTS ---
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            const resetDataBtn = document.getElementById('reset-data-btn');

            // --- SUPPLIER DASHBOARD ELEMENTS ---
            const navSupplier = document.getElementById('nav-supplier');
            const mobNavSupplier = document.getElementById('mob-nav-supplier');
            const supplierDashboardPage = document.getElementById('supplier-dashboard-page');
            const supplierMatrixBody = document.getElementById('supplier-matrix-body');
            const supplierSearchInput = document.getElementById('supplier-search-input');
            const totalSuppliersCount = document.getElementById('total-suppliers-count');
            const ingredientsCheckedCount = document.getElementById('ingredients-checked-count');
            const optimizeShoppingListBtn = document.getElementById('optimize-shopping-list-btn');
            const supplierEmptyState = document.getElementById('supplier-empty-state');

            // --- DATA & STATE ---
            let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
            let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
            let teams = JSON.parse(localStorage.getItem('teams')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || [];
            let currentlyEditingId = null;
            let recipeTomSelectInstances = {};
            let currentlyEditingRecipeId = null;
            let editRecipeTomSelectInstances = {};
            let currentlyEditingTeamId = null;
            let plannerDate = new Date();
            let recipeBookCurrentPage = 1;
            const RECIPES_PER_PAGE = 20;

            // --- RECIPE UNDO/REDO STATE ---
            let recipeEditHistory = [];
            let recipeHistoryStep = -1;
            let isRecipeUndoingRedoing = false;

            // --- CATEGORY UNDO/REDO STATE ---
            let categoryEditHistory = [];
            let categoryHistoryStep = -1;
            let isCategoryUndoingRedoing = false;
            let tempCategories = [];
            let originalCategories = [];


            const saveIngredients = () => { try { localStorage.setItem('ingredients', JSON.stringify(ingredients)); } catch (e) { console.error('Error saving ingredients:', e); alert('Warning: Could not save ingredients. Storage might be full or restricted.'); } };
            const saveRecipes = () => { try { localStorage.setItem('recipes', JSON.stringify(recipes)); } catch (e) { console.error('Error saving recipes:', e); alert('Warning: Could not save recipes. Storage might be full or restricted.'); } };
            const saveTeams = () => { try { localStorage.setItem('teams', JSON.stringify(teams)); } catch (e) { console.error('Error saving teams:', e); alert('Warning: Could not save teams. Storage might be full or restricted.'); } };
            const saveCategories = () => { try { localStorage.setItem('categories', JSON.stringify(categories)); } catch (e) { console.error('Error saving categories:', e); alert('Warning: Could not save categories. Storage might be full or restricted.'); } };

            // =================================================================
            // SETTINGS & DATA MANAGEMENT (No changes here)
            // =================================================================
            const rerenderAll = () => {
                renderIngredients();
                renderRecipes();
                renderTeams();
                renderFullProductionCalendar();
                renderCategoryFilters();
                renderRecipeBook();
                renderRecipePageCategoryFilters(); // This makes the new buttons show up
            };

            exportDataBtn.addEventListener('click', () => {
                const dataToExport = {
                    ingredients,
                    recipes,
                    teams,
                    categories,
                    exportedAt: new Date().toISOString()
                };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `dessertcost_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });

            importDataBtn.addEventListener('click', () => {
                importFileInput.click();
            });

            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.ingredients && importedData.recipes && importedData.teams && importedData.categories) {
                            if (confirm('Importing this file will overwrite all current data. Are you sure?')) {
                                ingredients = importedData.ingredients;
                                recipes = importedData.recipes;
                                teams = importedData.teams;
                                categories = importedData.categories;
                                saveIngredients();
                                saveRecipes();
                                saveTeams();
                                saveCategories();
                                rerenderAll();
                                alert('Data imported successfully!');
                            }
                        } else {
                            alert('Invalid file format.');
                        }
                    } catch (error) {
                        alert('Error reading or parsing file.');
                        console.error("Import error:", error);
                    } finally {
                        e.target.value = null;
                    }
                };
                reader.readAsText(file);
            });

            resetDataBtn.addEventListener('click', () => {
                showFeedbackModal({
                    type: 'danger',
                    title: 'Reset All Data?',
                    message: 'WARNING: This will delete ALL data permanently. This action cannot be undone. Are you absolutely sure?',
                    confirmText: 'Yes, Delete Everything',
                    onConfirm: () => {
                        ingredients = [];
                        recipes = [];
                        teams = [];
                        categories = [];
                        saveIngredients();
                        saveRecipes();
                        saveTeams();
                        saveCategories();
                        rerenderAll();

                        showFeedbackModal({
                            type: 'success',
                            title: 'Data Reset',
                            message: 'All application data has been successfully reset.'
                        });
                    }
                });
            });

            // =================================================================
            // FULL PRODUCTION PLANNER FUNCTIONS
            // =================================================================

            const renderFullProductionCalendar = () => {
                productionPlannerContainer.innerHTML = '';

                const schedule = new Map();
                const teamColors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-yellow-500', 'bg-red-500', 'bg-indigo-500'];
                teams.forEach(team => {
                    team.recipes.forEach(teamRecipe => {
                        const recipe = recipes.find(r => r.id === teamRecipe.recipeId);
                        if (!recipe) return;

                        teamRecipe.cookDates.forEach(date => {
                            if (!schedule.has(date)) {
                                schedule.set(date, []);
                            }
                            schedule.get(date).push({
                                teamName: team.name,
                                teamId: team.id,
                                recipeTitle: recipe.title,
                                quantity: teamRecipe.qtyPerDay
                            });
                        });
                    });
                });

                const year = plannerDate.getFullYear();
                const month = plannerDate.getMonth();
                const monthName = plannerDate.toLocaleString('default', { month: 'long' });
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();

                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-4';
                header.innerHTML = `
      <button id="planner-prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-600"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
      </button>
      <h4 class="text-lg font-bold text-gray-800">${monthName} ${year}</h4>
      <button id="planner-next-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-600"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
      </button>
    `;
                productionPlannerContainer.appendChild(header);

                const calendarGrid = document.createElement('div');
                calendarGrid.className = 'full-calendar';

                ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].forEach(day => {
                    calendarGrid.innerHTML += `<div class="full-calendar-header">${day}</div>`;
                });

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const dayNum = daysInPrevMonth - firstDayOfMonth + i + 1;
                    calendarGrid.innerHTML += `<div class="full-calendar-day not-current-month"><span class="day-number">${dayNum}</span></div>`;
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'full-calendar-day';
                    dayDiv.innerHTML = `<span class="day-number">${i}</span>`;

                    if (schedule.has(dateStr)) {
                        dayDiv.classList.add('has-events');
                        dayDiv.dataset.date = dateStr;

                        const eventsForDay = schedule.get(dateStr);
                        const MAX_ITEMS_VISIBLE = 2;
                        let itemsRendered = 0;
                        let totalItems = eventsForDay.length;

                        const eventContainer = document.createElement('div');
                        let eventListHTML = '<div class="planner-event-list">';
                        for (const event of eventsForDay) {
                            if (itemsRendered < MAX_ITEMS_VISIBLE) {
                                const teamColor = teamColors[event.teamId % teamColors.length];
                                eventListHTML += `<div class="planner-recipe-item ${teamColor} !mt-1">${event.recipeTitle} ${event.quantity}pcs</div>`;
                                itemsRendered++;
                            } else {
                                break;
                            }
                        }
                        eventListHTML += '</div>';

                        const remainingItems = totalItems - itemsRendered;
                        if (remainingItems > 0) {
                            eventListHTML += `<div class="planner-more-items-btn">+ ${remainingItems} more</div>`;
                        }
                        eventContainer.innerHTML = eventListHTML;
                        dayDiv.appendChild(eventContainer);
                    }
                    calendarGrid.appendChild(dayDiv);
                }

                const lastDayOfMonth = new Date(year, month, daysInMonth).getDay();
                let nextMonthDay = 1;
                for (let i = lastDayOfMonth + 1; i < 7; i++) {
                    calendarGrid.innerHTML += `<div class="full-calendar-day not-current-month"><span class="day-number">${nextMonthDay++}</span></div>`;
                }

                calendarGrid.addEventListener('click', (e) => {
                    const dayCell = e.target.closest('.full-calendar-day.has-events');
                    if (dayCell) {
                        const dateStr = dayCell.dataset.date;
                        const eventsForDay = schedule.get(dateStr);
                        if (eventsForDay) {
                            openPlannerDayModal(dateStr, eventsForDay, teamColors);
                        }
                    }
                });

                productionPlannerContainer.appendChild(calendarGrid);

                document.getElementById('planner-prev-month').addEventListener('click', () => {
                    plannerDate.setMonth(plannerDate.getMonth() - 1);
                    renderFullProductionCalendar();
                });
                document.getElementById('planner-next-month').addEventListener('click', () => {
                    plannerDate.setMonth(plannerDate.getMonth() + 1);
                    renderFullProductionCalendar();
                });

                if (schedule.size > 0) {
                    const summaryContainer = document.createElement('div');
                    summaryContainer.className = 'mt-8 pt-6 border-t border-gray-200';
                    summaryContainer.innerHTML = '<h4 class="text-base font-semibold text-gray-800 mb-4">Production Summary for the Month</h4>';

                    const summaryList = document.createElement('div');
                    summaryList.className = 'space-y-4 text-sm';

                    const sortedDates = [...schedule.keys()].sort();

                    sortedDates.forEach(dateStr => {
                        const events = schedule.get(dateStr);
                        const date = new Date(dateStr + 'T00:00:00');
                        const dayNumber = date.getDate();
                        const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });

                        const dayEntryContainer = document.createElement('div');
                        dayEntryContainer.innerHTML = `<h5 class="font-semibold text-brand-pink-900 bg-brand-pink-100 px-3 py-1 rounded-md inline-block">${dayNumber} (${dayOfWeek})</h5>`;

                        const eventsByTeam = events.reduce((acc, event) => {
                            if (!acc[event.teamName]) {
                                acc[event.teamName] = [];
                            }
                            acc[event.teamName].push(event);
                            return acc;
                        }, {});

                        const teamsContainer = document.createElement('div');
                        teamsContainer.className = 'pl-4 mt-1 space-y-2';

                        for (const teamName in eventsByTeam) {
                            const teamEvents = eventsByTeam[teamName];
                            const recipesString = teamEvents.map(event =>
                                `${event.recipeTitle} (${event.quantity}pcs)`
                            ).join(' | ');

                            const teamEntry = document.createElement('div');
                            teamEntry.innerHTML = `
            <p class="font-semibold text-gray-800">${teamName}</p>
            <p class="pl-2 text-gray-600">${recipesString}</p>
          `;
                            teamsContainer.appendChild(teamEntry);
                        }

                        dayEntryContainer.appendChild(teamsContainer);
                        summaryList.appendChild(dayEntryContainer);
                    });

                    summaryContainer.appendChild(summaryList);
                    productionPlannerContainer.appendChild(summaryContainer);
                }
            };

            const openPlannerDayModal = (dateStr, events, teamColors) => {
                const modal = document.getElementById('planner-day-modal');
                const modalTitle = document.getElementById('planner-modal-title');
                const modalBody = document.getElementById('planner-modal-body');
                const modalCloseBtn = document.getElementById('planner-modal-close-btn');

                const date = new Date(dateStr + 'T00:00:00');
                modalTitle.textContent = `Production for ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

                const eventsByTeam = events.reduce((acc, event) => {
                    if (!acc[event.teamName]) {
                        acc[event.teamName] = { teamId: event.teamId, recipes: [] };
                    }
                    acc[event.teamName].recipes.push(event);
                    return acc;
                }, {});

                modalBody.innerHTML = '';
                for (const teamName in eventsByTeam) {
                    const teamInfo = eventsByTeam[teamName];
                    const teamColor = teamColors[teamInfo.teamId % teamColors.length];

                    let teamHTML = `<div class="mb-3"><h4 class="font-bold text-gray-800">${teamName}</h4><div class="mt-1 space-y-1">`;
                    teamInfo.recipes.forEach(event => {
                        teamHTML += `
          <div class="flex items-center gap-0.5 py-1 px-0.5 rounded-md bg-gray-50 border">
            <span class="w-3 h-3 rounded-full ${teamColor}"></span>
            <span class="flex-1 font-medium text-sm text-gray-700 whitespace-nowrap">${event.recipeTitle}</span>
            <span class="text-sm font-semibold text-brand-pink-700 whitespace-nowrap">${event.quantity} pcs</span>
          </div>
        `;
                    });
                    teamHTML += `</div></div>`;
                    modalBody.innerHTML += teamHTML;
                }

                modal.classList.remove('hidden');

                const closeModal = () => modal.classList.add('hidden');
                modalCloseBtn.onclick = closeModal;
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                };
            };

            // =================================================================
            // BUDGET PAGE FUNCTIONS
            // =================================================================
            const calculateTeamData = (team) => {
                // 1. Calculate unique production days
                const allCookDays = new Set();
                team.recipes.forEach(r => {
                    if (Array.isArray(r.cookDates)) {
                        r.cookDates.forEach(d => allCookDays.add(d));
                    }
                });
                const totalProductionDays = allCookDays.size;

                // 2. Calculate total labor cost
                let totalDailySalaryRate = 0;
                team.staff.forEach(staff => {
                    const salary = staff.salary || 0;
                    const durationValue = staff.duration_value || 1;
                    const durationType = staff.duration_type || 'day';
                    let dailyRate = 0;
                    if (durationType === 'day') {
                        dailyRate = salary / durationValue;
                    } else if (durationType === 'week') {
                        dailyRate = salary / (durationValue * 7);
                    } else if (durationType === 'month') {
                        dailyRate = salary / (durationValue * 30); // Approximation
                    }
                    totalDailySalaryRate += dailyRate;
                });
                const totalLaborCost = totalDailySalaryRate * totalProductionDays;

                // 3. Calculate total ingredient cost and projected revenue
                let totalIngredientCost = 0;
                let projectedRevenue = 0;
                const recipeBreakdowns = team.recipes.map(teamRecipe => {
                    const recipe = recipes.find(r => r.id === teamRecipe.recipeId);
                    if (!recipe) return null;

                    const qtyPerDay = teamRecipe.qtyPerDay || 0;
                    const recipeCookDays = Array.isArray(teamRecipe.cookDates) ? teamRecipe.cookDates.length : 0;
                    const totalQty = qtyPerDay * recipeCookDays;

                    const recipeCosts = calculateRecipeCost(recipe);
                    const servingsPerBatch = (recipe.servings.type === 'quantity' ? recipe.servings.value : recipe.servings.quantity) || 1;

                    if (servingsPerBatch > 0) {
                        const batchesNeeded = totalQty / servingsPerBatch;
                        totalIngredientCost += recipeCosts.totalCost * batchesNeeded;
                        projectedRevenue += recipeCosts.finalPrice * batchesNeeded;
                    }

                    const salaryCostPerRecipeRun = totalDailySalaryRate * recipeCookDays;
                    const salaryCostPerPc = totalQty > 0 ? salaryCostPerRecipeRun / totalQty : 0;
                    const ingredientCostPerPc = recipeCosts.costPerServing;
                    const totalCostPerPc = ingredientCostPerPc + salaryCostPerPc;

                    return {
                        title: recipe.title,
                        totalCostPerPc: totalCostPerPc.toFixed(2)
                    };
                }).filter(b => b !== null);

                // 4. Calculate final numbers
                const totalProductionCost = totalLaborCost + totalIngredientCost;
                const projectedProfit = projectedRevenue - totalProductionCost;

                // 5. Return all the new data
                return {
                    totalProductionDays,
                    totalLaborCost,
                    totalIngredientCost,
                    totalProductionCost,
                    projectedRevenue,
                    projectedProfit,
                    recipeBreakdowns
                };
            };

            const renderProductionCalendar = (container, team) => {
                container.innerHTML = '';
                const schedule = {};
                team.recipes.forEach(teamRecipe => {
                    const recipe = recipes.find(r => r.id === teamRecipe.recipeId);
                    if (!recipe) return;
                    teamRecipe.cookDates.forEach(date => {
                        if (!schedule[date]) schedule[date] = [];
                        schedule[date].push({
                            title: recipe.title,
                            quantity: teamRecipe.qtyPerDay
                        });
                    });
                });

                const currentDate = new Date();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const grid = document.createElement('div');
                grid.className = 'calendar';
                'S,M,T,W,T,F,S'.split(',').forEach(day => {
                    grid.innerHTML += `<div class="calendar-header">${day}</div>`;
                });
                for (let i = 0; i < firstDay; i++) { grid.innerHTML += '<div></div>'; }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

                    if (schedule[dateStr]) {
                        dayDiv.classList.add('has-recipe');
                        dayDiv.innerHTML = `<span>${i}</span>`;
                        tippy(dayDiv, {
                            content: schedule[dateStr].map(event => `<div>- ${event.title} (${event.quantity}pcs)</div>`).join(''),
                            allowHTML: true,
                            theme: 'light-border'
                        });
                    } else {
                        dayDiv.textContent = i;
                    }
                    grid.appendChild(dayDiv);
                }
                container.innerHTML = `
            <div class="calendar-nav !mb-2">
                <span class="font-semibold text-sm">${currentDate.toLocaleString('default', { month: 'long' })} ${year}</span>
            </div>
        `;
                container.appendChild(grid);
            };

            const renderTeams = () => {
                const teamListDiv = document.getElementById('team-list');
                teamListDiv.innerHTML = '';
                if (teams.length === 0) {
                    teamListDiv.innerHTML = `<p class="text-center text-gray-500">No teams created yet.</p>`;
                    return;
                }

                const teamsContainer = document.createElement('div');
                teamsContainer.className = 'space-y-4';

                teams.forEach(team => {
                    const teamData = calculateTeamData(team);
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden';
                    card.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg text-gray-800">${team.name}</h4>
                            <p class="text-sm text-gray-500">${team.staff.length} staff members &bull; ${team.recipes.length} recipes</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button title="Edit Team" class="edit-team-btn p-1.5 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-md" data-team-id="${team.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                            </button>
                            <button class="font-semibold text-sm text-brand-pink-600 toggle-team-details py-1.5 px-3 rounded-md hover:bg-brand-pink-50" data-team-id="${team.id}">Details</button>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center border-t pt-4">
                        <div><p class="text-xs text-gray-500">Labor Cost</p><p class="font-bold text-gray-800 text-lg">RM ${teamData.totalLaborCost.toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-500">Ingredient Cost</p><p class="font-bold text-gray-800 text-lg">RM ${teamData.totalIngredientCost.toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-500">Projected Revenue</p><p class="font-bold text-blue-600 text-lg">RM ${teamData.projectedRevenue.toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-500">Projected Profit</p><p class="font-bold text-green-600 text-lg">RM ${teamData.projectedProfit.toFixed(2)}</p></div>
                    </div>
                </div>
                <div class="team-card-details bg-gray-50/70 px-5" data-details-for="${team.id}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-semibold mb-2 text-gray-700">Costing per Piece</h5>
                            <div class="space-y-2">
                                ${teamData.recipeBreakdowns.length > 0 ? teamData.recipeBreakdowns.map(rb => `
                                    <div class="text-xs p-2 bg-white rounded-md border">
                                        <p class="font-bold text-gray-800">${rb.title}</p>
                                        <p>Total Cost (Ingredients + Labor): <strong class="text-brand-pink-700">RM ${rb.totalCostPerPc} per pc</strong></p>
                                    </div>
                                `).join('') : '<p class="text-xs text-gray-500">No recipes scheduled.</p>'}
                            </div>
                        </div>
                        <div>
                            <h5 class="font-semibold mb-2 text-gray-700">Production Schedule (${teamData.totalProductionDays} days)</h5>
                            <div class="production-calendar-container bg-white p-2 rounded-lg border"></div>
                            <div class="mt-4 text-right">
                                <button class="delete-team-btn py-2 px-4 bg-red-600 text-white font-semibold rounded-lg text-sm hover:bg-red-700" data-team-id="${team.id}">Delete Team</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    teamsContainer.appendChild(card);
                });
                teamListDiv.appendChild(teamsContainer);
            };


            const openEditTeamModal = (teamId) => {
                const teamToEdit = teams.find(t => t.id === teamId);
                if (!teamToEdit) return;

                currentlyEditingTeamId = teamId;

                addTeamModal.querySelector('h3').textContent = 'Edit Team';
                teamForm.querySelector('button[type="submit"]').textContent = 'Save Changes';
                document.getElementById('team-name').value = teamToEdit.name;
                staffList.innerHTML = '';
                teamRecipeList.innerHTML = '';

                teamToEdit.staff.forEach(staffMember => addStaffRow(staffMember));
                teamToEdit.recipes.forEach(recipeItem => addTeamRecipeRow(recipeItem));

                addTeamModal.classList.remove('hidden');
                updateBudgetSummary();
            };

            const openAddTeamModal = () => {
                currentlyEditingTeamId = null;
                addTeamModal.querySelector('h3').textContent = 'Add New Team';
                teamForm.querySelector('button[type="submit"]').textContent = 'Create Team';

                teamForm.reset();
                staffList.innerHTML = '';
                teamRecipeList.innerHTML = '';
                if (staffList.children.length === 0) addStaffRow();
                if (teamRecipeList.children.length === 0) addTeamRecipeRow();

                addTeamModal.classList.remove('hidden');
                updateBudgetSummary();
            };

            const closeAddTeamModal = () => {
                addTeamModal.classList.add('hidden');
                currentlyEditingTeamId = null;
            };

            const addStaffRow = (staff = {}) => {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg bg-gray-50 staff-row border';
                div.innerHTML = `
            <div class="flex flex-wrap gap-x-4 gap-y-2 items-center justify-between">
                <input type="text" placeholder="Staff Name" class="staff-name p-2 border rounded-lg flex-grow md:flex-grow-0 md:w-64 focus-ring" value="${staff.name || ''}">
                <div class="flex items-center gap-2 flex-grow justify-end">
                    <span class="text-sm text-gray-600">RM</span>
                    <input type="number" placeholder="e.g., 1500" class="staff-salary p-2 border rounded-lg w-24 focus-ring" value="${staff.salary || ''}">
                    <span class="text-sm text-gray-600">per</span>
                    <input type="number" value="${staff.duration_value || 1}" min="1" class="staff-duration-value p-2 border rounded-lg w-16 text-center focus-ring">
                    <select class="staff-duration-type p-2 border rounded-lg bg-gray-100 focus-ring">
                        <option value="day" ${staff.duration_type === 'day' ? 'selected' : ''}>Day(s)</option>
                        <option value="week" ${staff.duration_type === 'week' ? 'selected' : ''}>Week(s)</option>
                        <option value="month" ${staff.duration_type === 'month' ? 'selected' : ''}>Month(s)</option>
                    </select>
                </div>
                <button type="button" class="remove-staff-btn text-red-500 font-semibold text-xs p-1 rounded hover:bg-red-50">REMOVE</button>
            </div>
        `;
                staffList.appendChild(div);
            };

            const addTeamRecipeRow = (teamRecipe = {}) => {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg bg-gray-50 team-recipe-row border';
                const recipeOptions = recipes.map(r => `<option value="${r.id}" ${teamRecipe.recipeId == r.id ? 'selected' : ''}>${r.title}</option>`).join('');
                if (!recipeOptions) {
                    div.innerHTML = `<p class="text-sm text-red-500">No recipes found. Please go to the 'Recipes' page to create one first.</p>`;
                    teamRecipeList.appendChild(div);
                    return;
                }

                const selectedDates = teamRecipe.cookDates || [];
                div.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
                <select class="team-recipe-select p-2.5 border rounded-lg focus-ring bg-white">${recipeOptions}</select>
                <input type="number" placeholder="Quantity per day" value="${teamRecipe.qtyPerDay || 30}" class="team-recipe-qty p-2.5 border rounded-lg focus-ring">
                <input type="text" readonly placeholder="Click to select dates" class="team-recipe-dates p-2.5 border rounded-lg bg-white cursor-pointer focus-ring" 
                        data-selected-dates='${JSON.stringify(selectedDates)}' value="${selectedDates.length} day(s) selected">
            </div>
            <div class="flex justify-between items-center">
                <div class="calendar-container hidden mt-2 p-2 bg-white border rounded-lg shadow-sm w-full max-w-xs"></div>
                <button type="button" class="remove-team-recipe-btn text-red-500 text-xs font-semibold mt-1 px-1 hover:bg-red-50 rounded">REMOVE</button>
            </div>
        `;
                teamRecipeList.appendChild(div);

                const dateInput = div.querySelector('.team-recipe-dates');
                const calendarContainer = div.querySelector('.calendar-container');

                dateInput.addEventListener('click', () => {
                    const isHidden = calendarContainer.classList.contains('hidden');
                    document.querySelectorAll('.calendar-container').forEach(c => c.classList.add('hidden'));
                    if (isHidden) {
                        calendarContainer.classList.remove('hidden');
                        const currentDates = JSON.parse(dateInput.dataset.selectedDates || '[]');
                        renderCalendar(calendarContainer, new Date(), currentDates);
                    }
                });
            };

            const renderCalendar = (container, currentDate, selectedDates) => {
                container.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const nav = document.createElement('div');
                nav.className = 'calendar-nav';
                nav.innerHTML = `
            <button type="button" class="prev-month">&lt;</button>
            <span class="font-semibold">${currentDate.toLocaleString('default', { month: 'long' })} ${year}</span>
            <button type="button" class="next-month">&gt;</button>
        `;
                container.appendChild(nav);

                const grid = document.createElement('div');
                grid.className = 'calendar';
                'S,M,T,W,T,F,S'.split(',').forEach(day => {
                    grid.innerHTML += `<div class="calendar-header">${day}</div>`;
                });


                for (let i = 0; i < firstDay; i++) {
                    grid.innerHTML += '<div></div>';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.textContent = i;
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayDiv.dataset.date = dateStr;
                    if (selectedDates.includes(dateStr)) {
                        dayDiv.classList.add('selected');
                    }
                    grid.appendChild(dayDiv);
                }
                container.appendChild(grid);

                container.querySelector('.prev-month').addEventListener('click', () => {
                    currentDate.setMonth(month - 1);
                    renderCalendar(container, currentDate, selectedDates);
                });
                container.querySelector('.next-month').addEventListener('click', () => {
                    currentDate.setMonth(month + 1);
                    renderCalendar(container, currentDate, selectedDates);
                });

                container.querySelectorAll('.calendar-day').forEach(day => {
                    day.addEventListener('click', () => {
                        day.classList.toggle('selected');
                        const date = day.dataset.date;
                        if (selectedDates.includes(date)) {
                            selectedDates.splice(selectedDates.indexOf(date), 1);
                        } else {
                            selectedDates.push(date);
                        }
                        const dateInput = container.closest('.team-recipe-row').querySelector('.team-recipe-dates');
                        dateInput.value = `${selectedDates.length} day(s) selected`;
                        dateInput.dataset.selectedDates = JSON.stringify(selectedDates);
                        updateBudgetSummary();
                    });
                });
            };

            const updateBudgetSummary = () => {
                const tempTeam = { staff: [], recipes: [] };
                document.querySelectorAll('.staff-row').forEach(row => {
                    tempTeam.staff.push({
                        salary: parseFloat(row.querySelector('.staff-salary').value) || 0,
                        duration_value: parseInt(row.querySelector('.staff-duration-value').value) || 1,
                        duration_type: row.querySelector('.staff-duration-type').value
                    });
                });
                document.querySelectorAll('.team-recipe-row').forEach(row => {
                    const recipeId = row.querySelector('.team-recipe-select')?.value;
                    if (!recipeId) return;
                    tempTeam.recipes.push({
                        recipeId: parseInt(recipeId),
                        qtyPerDay: parseInt(row.querySelector('.team-recipe-qty').value) || 0,
                        cookDates: JSON.parse(row.querySelector('.team-recipe-dates').dataset.selectedDates || '[]')
                    });
                });

                const summaryData = calculateTeamData(tempTeam);

                document.getElementById('summary-total-days').textContent = summaryData.totalProductionDays;
                document.getElementById('summary-total-salary').textContent = `RM ${summaryData.totalLaborCost.toFixed(2)}`;

                const spendingDiv = document.getElementById('summary-recipe-spending');
                spendingDiv.innerHTML = '';

                if (summaryData.recipeBreakdowns.length > 0) {
                    summaryData.recipeBreakdowns.forEach(rb => {
                        spendingDiv.innerHTML += `
                        <div class="text-xs p-2 bg-white rounded-md border">
                            <p class="font-bold">${rb.title}</p>
                            <p>Total Cost (Ingredients + Labor): <strong class="text-brand-pink-700">RM ${rb.totalCostPerPc} per pc</strong></p>
                        </div>
                    `;
                    });
                }

                if (spendingDiv.innerHTML === '') {
                    spendingDiv.innerHTML = '<p class="text-xs text-gray-500">Assign recipes and select cook dates to see breakdown.</p>';
                }
            };

            // Toggle Inventory History
            window.toggleHistory = (id) => {
                const content = document.getElementById(`history-content-${id}`);
                const icon = document.getElementById(`history-icon-${id}`);
                if (content && icon) {
                    content.classList.toggle('hidden');
                    if (content.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            };

            // =================================================================
            // INGREDIENT PAGE FUNCTIONS
            // =================================================================
            const renderIngredients = () => {
                ingredientListDiv.innerHTML = '';
                let processedIngredients = [...ingredients];
                const searchTerm = ingredientSearchInput.value.toLowerCase();
                if (searchTerm) {
                    processedIngredients = processedIngredients.filter(ing => ing.name.toLowerCase().includes(searchTerm));
                }
                const sortBy = ingredientSortSelect.value;
                processedIngredients.sort((a, b) => {
                    switch (sortBy) {
                        case 'name-az': return a.name.localeCompare(b.name);
                        case 'name-za': return b.name.localeCompare(a.name);
                        case 'price-desc': return b.price - a.price;
                        case 'price-asc': return a.price - b.price;
                        case 'weight-desc': return b.weight - a.weight;
                        case 'weight-asc': return a.weight - b.weight;
                        case 'oldest': return new Date(a.dateAdded) - new Date(b.dateAdded);
                        case 'latest': default: return new Date(b.dateAdded) - new Date(a.dateAdded);
                    }
                });
                if (processedIngredients.length === 0) {
                    ingredientListDiv.innerHTML = `<p class="text-center text-gray-500 py-10 px-6">No ingredients found.</p>`;
                    return;
                }
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left text-gray-600';
                table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-3 text-center w-12">#</th><th class="px-6 py-3 w-full">Name</th><th class="px-6 py-3 whitespace-nowrap text-center">Purchase Cost</th><th class="px-6 py-3 whitespace-nowrap text-center">Cost per unit</th><th class="px-6 py-3 text-center">Actions</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                processedIngredients.forEach((ingredient, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    let baseUnit = '', costPerUnit = 0, totalAmountInBaseUnit = 0;
                    switch (ingredient.unit) {
                        case 'kg': totalAmountInBaseUnit = ingredient.weight * 1000; baseUnit = 'g'; break;
                        case 'l': totalAmountInBaseUnit = ingredient.weight * 1000; baseUnit = 'ml'; break;
                        default: totalAmountInBaseUnit = ingredient.weight; baseUnit = ingredient.unit;
                    }
                    if (totalAmountInBaseUnit > 0) costPerUnit = ingredient.price / totalAmountInBaseUnit;
                    tr.innerHTML = `<td class="px-4 py-4 text-center text-gray-500">${index + 1}</td><td class="px-6 py-4 font-medium text-gray-900">${ingredient.name}</td><td class="px-6 py-4 whitespace-nowrap text-center">RM ${ingredient.price.toFixed(2)} for ${ingredient.weight} ${ingredient.unit}</td><td class="px-6 py-4 font-semibold text-green-600 whitespace-nowrap text-center">RM ${costPerUnit.toFixed(5)} / ${baseUnit}</td><td class="px-6 py-4 flex justify-center"><button class="edit-btn w-8 h-8 flex items-center justify-center bg-brand-pink-600 rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors group" data-id="${ingredient.id}"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button></td>`;
                    tbody.appendChild(tr);
                });
                ingredientListDiv.appendChild(table);
            };

            // =================================================================
            // INVENTORY PAGE FUNCTIONS
            // =================================================================
            const renderInventory = () => {
                const inventoryListDiv = document.getElementById('inventory-list');
                const inventoryEmptyState = document.getElementById('inventory-empty-state');
                const inventorySearchInput = document.getElementById('inventory-search-input');
                const inventoryFilterSelect = document.getElementById('inventory-filter-select');
                const inventorySortSelect = document.getElementById('inventory-sort-select');
                const inventoryTotalItems = document.getElementById('inventory-total-items');
                const inventoryOutOfStockCount = document.getElementById('inventory-out-of-stock-count');
                const inventoryLowStockCount = document.getElementById('inventory-low-stock-count');
                const inventoryTotalValue = document.getElementById('inventory-total-value');

                if (!inventoryListDiv) return;

                inventoryListDiv.innerHTML = '';

                // Process ingredients for inventory display
                let processedIngredients = [...ingredients];

                // Search filter
                const searchTerm = inventorySearchInput?.value?.toLowerCase() || '';
                if (searchTerm) {
                    processedIngredients = processedIngredients.filter(ing =>
                        ing.name.toLowerCase().includes(searchTerm)
                    );
                }

                // Stock status filter
                const filter = inventoryFilterSelect?.value || 'all';
                processedIngredients = processedIngredients.filter(ing => {
                    const stockQty = ing.inventory?.stockQty || 0;
                    const reorderLevel = ing.inventory?.reorderLevel || 0;

                    switch (filter) {
                        case 'low-stock': return stockQty > 0 && stockQty <= reorderLevel;
                        case 'in-stock': return stockQty > reorderLevel;
                        case 'out-of-stock': return stockQty === 0;
                        default: return true;
                    }
                });

                // Sorting
                const sortBy = inventorySortSelect?.value || 'name-az';
                processedIngredients.sort((a, b) => {
                    const aStock = a.inventory?.stockQty || 0;
                    const bStock = b.inventory?.stockQty || 0;
                    // Helper to get value
                    const getVal = (ing) => {
                        let w = ing.weight;
                        if (ing.unit === 'kg') w = ing.weight * 1000;
                        if (ing.unit === 'l') w = ing.weight * 1000;
                        const p = w > 0 ? ing.price / w : 0;
                        return (ing.inventory?.stockQty || 0) * p;
                    };
                    const aValue = getVal(a);
                    const bValue = getVal(b);

                    switch (sortBy) {
                        case 'name-az': return a.name.localeCompare(b.name);
                        case 'name-za': return b.name.localeCompare(a.name);
                        case 'stock-asc': return aStock - bStock;
                        case 'stock-desc': return bStock - aStock;
                        case 'value-desc': return bValue - aValue;
                        default: return 0;
                    }
                });

                // Calculate dashboard stats
                let totalValue = 0;
                let lowStockCount = 0;
                let outOfStockCount = 0;
                ingredients.forEach(ing => {
                    const stockQty = ing.inventory?.stockQty || 0;
                    const reorderLevel = ing.inventory?.reorderLevel || 0;

                    // Convert basic reorder level for calculation
                    let baseReorderLevel = reorderLevel;
                    if (ing.unit === 'kg' || ing.unit === 'l') baseReorderLevel = reorderLevel * 1000;

                    let weightInBase = ing.weight;
                    if (ing.unit === 'kg') weightInBase = ing.weight * 1000;
                    if (ing.unit === 'l') weightInBase = ing.weight * 1000;

                    const pricePerBaseUnit = weightInBase > 0 ? ing.price / weightInBase : 0;
                    totalValue += stockQty * pricePerBaseUnit;

                    // Alert Counting Logic
                    // Low Stock Alert: <= 15% of Reorder Level (includes Out of Stock 0)
                    if (stockQty <= baseReorderLevel * 0.15) lowStockCount++;
                    // Out of Stock Alert: Exactly 0
                    if (stockQty === 0) outOfStockCount++;
                });

                if (inventoryTotalItems) inventoryTotalItems.textContent = ingredients.length;
                if (inventoryOutOfStockCount) inventoryOutOfStockCount.textContent = outOfStockCount;
                if (inventoryLowStockCount) inventoryLowStockCount.textContent = lowStockCount;
                if (inventoryTotalValue) inventoryTotalValue.textContent = `RM ${totalValue.toFixed(2)}`;

                // Show empty state if no ingredients
                if (ingredients.length === 0) {
                    inventoryListDiv.classList.add('hidden');
                    inventoryEmptyState?.classList.remove('hidden');
                    return;
                }

                inventoryListDiv.classList.remove('hidden');
                inventoryEmptyState?.classList.add('hidden');

                // Render inventory cards
                processedIngredients.forEach(ing => {
                    const stockQty = ing.inventory?.stockQty || 0;
                    const reorderLevel = ing.inventory?.reorderLevel || 0;
                    const location = ing.inventory?.location || '';
                    const restockHistory = ing.inventory?.restockHistory || [];

                    // Calculate price per base unit (e.g., per g or ml)
                    let weightInBase = ing.weight;
                    if (ing.unit === 'kg') weightInBase = ing.weight * 1000;
                    if (ing.unit === 'l') weightInBase = ing.weight * 1000;

                    const pricePerBaseUnit = weightInBase > 0 ? ing.price / weightInBase : 0;
                    const stockValue = stockQty * pricePerBaseUnit;

                    // 3-Tier stock status
                    let statusColor = 'bg-green-100 text-green-700 border-green-200';
                    let statusText = 'In Stock';
                    let statusIcon = '';

                    // Prepare base reorder level for comparison
                    let baseReorderLevel = reorderLevel;
                    if (ing.unit === 'kg' || ing.unit === 'l') baseReorderLevel = reorderLevel * 1000;

                    if (stockQty === 0) {
                        statusColor = 'bg-red-100 text-red-700 border-red-200';
                        statusText = 'Out of Stock';
                        statusIcon = '';
                    } else if (stockQty <= baseReorderLevel * 0.15) {
                        statusColor = 'bg-red-100 text-red-700 border-red-200';
                        statusText = 'Low Stock';
                        statusIcon = '!';
                    } else if (stockQty <= baseReorderLevel) {
                        statusColor = 'bg-amber-100 text-amber-700 border-amber-200';
                        statusText = 'Running Low';
                        statusIcon = '';
                    }

                    // Get base unit
                    let baseUnit = ing.unit;
                    if (baseUnit === 'kg') baseUnit = 'g';
                    if (baseUnit === 'l') baseUnit = 'ml';

                    // Determine display unit and quantity
                    let displayUnit = ing.inventory?.displayUnit || baseUnit;
                    let displayStockQty = stockQty;

                    if (displayUnit === 'kg' && baseUnit === 'g') displayStockQty = stockQty / 1000;
                    if (displayUnit === 'l' && baseUnit === 'ml') displayStockQty = stockQty / 1000;

                    // Build purchase history HTML (scrollable with fade)
                    let historyContent = '';
                    if (restockHistory.length > 0) {
                        const listItems = restockHistory.map(h => `
                            <div class="flex justify-between items-center bg-gray-50 rounded-md p-1.5 shrink-0">
                                <span class="text-gray-600">${new Date(h.date).toLocaleDateString('en-MY', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                                <span class="font-semibold text-green-600">+${h.quantity} ${h.unit || ing.unit}</span>
                            </div>
                        `).join('');

                        historyContent = `
                            <div class="relative">
                                <div class="space-y-1 overflow-y-auto max-h-[100px] pr-1 custom-scrollbar">
                                    ${listItems}
                                </div>
                                ${restockHistory.length > 3 ? `
                                <div class="absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        historyContent = `<p class="text-gray-400 italic text-center py-1">No recent purchases</p>`;
                    }

                    const historyHTML = `
                        <div class="mt-2 pt-2 border-t">
                            <button onclick="window.toggleHistory('${ing.id}')" class="flex items-center justify-between w-full text-xs font-semibold text-gray-500 uppercase mb-1 hover:text-gray-700 focus:outline-none select-none">
                                <span>Recent Purchases</span>
                                <svg id="history-icon-${ing.id}" class="w-4 h-4 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="history-content-${ing.id}" class="hidden text-xs relative group">
                                ${historyContent}
                            </div>
                        </div>
                    `;

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2 gap-3">
                            <h3 class="font-semibold text-gray-800 text-base pr-2 flex-1">${ing.name}</h3>
                            <span class="px-2 py-0.5 text-xs font-semibold rounded-full border ${statusColor} shrink-0">
                                ${statusIcon} ${statusText}
                            </span>
                        </div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Current Stock:</span>
                                <span class="font-semibold text-gray-800">${displayStockQty.toLocaleString()} ${displayUnit}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Reorder Level:</span>
                                <span class="text-gray-600">${reorderLevel.toLocaleString()} ${ing.unit}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Stock Value:</span>
                                <span class="font-semibold text-green-600">RM ${stockValue.toFixed(2)}</span>
                            </div>
                            ${location ? `
                            <div class="flex justify-between">
                                <span class="text-gray-500">Location:</span>
                                <span class="text-gray-600">${location}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${historyHTML}
                        <div class="mt-3 pt-2 border-t flex gap-2">
                            <button class="inventory-restock-btn flex-1 py-1.5 px-3 bg-brand-pink-50 text-brand-pink-700 font-semibold rounded-lg text-sm hover:bg-brand-pink-100 transition-colors" data-id="${ing.id}">
                                + Restock
                            </button>
                            <button class="inventory-edit-btn px-3 py-1.5 bg-gray-50 text-gray-600 font-medium rounded-lg text-sm hover:bg-gray-100 transition-colors" data-id="${ing.id}">
                                Edit
                            </button>
                        </div>
                    `;
                    inventoryListDiv.appendChild(card);
                });
            };

            // Inventory event listeners
            document.addEventListener('click', (e) => {
                // Restock button
                if (e.target.closest('.inventory-restock-btn')) {
                    const id = parseInt(e.target.closest('.inventory-restock-btn').dataset.id, 10);
                    openRestockModal(id);
                }
                // Edit from inventory
                if (e.target.closest('.inventory-edit-btn')) {
                    const id = parseInt(e.target.closest('.inventory-edit-btn').dataset.id, 10);
                    openEditModal(id);
                }
                // Go to ingredients from empty state
                if (e.target.id === 'inventory-go-to-ingredients-btn') {
                    window.location.hash = '#ingredients';
                }
            });

            // Inventory search/filter event listeners
            const inventorySearchInput = document.getElementById('inventory-search-input');
            const inventoryFilterSelect = document.getElementById('inventory-filter-select');
            const inventorySortSelect = document.getElementById('inventory-sort-select');

            if (inventorySearchInput) inventorySearchInput.addEventListener('input', () => renderInventory());
            if (inventoryFilterSelect) inventoryFilterSelect.addEventListener('change', () => renderInventory());
            if (inventorySortSelect) inventorySortSelect.addEventListener('change', () => renderInventory());

            // Restock modal functions
            const restockModal = document.getElementById('restock-modal');
            const restockForm = document.getElementById('restock-form');
            const restockCancelBtn = document.getElementById('restock-cancel-btn');

            const openRestockModal = (ingredientId) => {
                const ingredient = ingredients.find(ing => ing.id === ingredientId);
                if (!ingredient) return;

                // Use original purchase unit (kg, l, pcs, etc.)
                const purchaseUnit = ingredient.unit;

                // Set modal values
                document.getElementById('restock-ingredient-id').value = ingredientId;
                document.getElementById('restock-ingredient-name').textContent = `Adding stock for: ${ingredient.name}`;
                document.getElementById('restock-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('restock-qty').value = '';

                // Populate Unit Select
                // Populate Unit Select (g, kg, ml, l, pcs)
                const unitSelect = document.getElementById('restock-unit-select');
                unitSelect.innerHTML = '';

                const standardUnits = ['g', 'kg', 'ml', 'l', 'pcs'];
                // Ensure purchaseUnit is included if weird
                const allOptions = [...new Set([...standardUnits, purchaseUnit])];

                // Sort? Or keep standard order? User image: g, kg, ml, l, pcs.
                // We'll trust the set order or force sorting if needed. 
                // Set keeps insertion order. 'g' is first.

                allOptions.forEach(opt => {
                    const el = document.createElement('option');
                    el.value = opt;
                    el.textContent = opt;
                    if (opt === purchaseUnit) el.selected = true;
                    unitSelect.appendChild(el);
                });

                restockModal.classList.remove('hidden');
            };

            const closeRestockModal = () => {
                restockModal.classList.add('hidden');
                restockForm.reset();
            };

            restockCancelBtn.addEventListener('click', closeRestockModal);
            // Click outside to close - DISABLED (only buttons can close)
            // restockModal.addEventListener('click', (e) => {
            //     if (e.target === restockModal) closeRestockModal();
            // });

            restockForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const ingredientId = parseInt(document.getElementById('restock-ingredient-id').value, 10);
                const ingredient = ingredients.find(ing => ing.id === ingredientId);
                if (!ingredient) return;

                const quantity = parseFloat(document.getElementById('restock-qty').value);
                const purchaseDate = document.getElementById('restock-date').value;

                if (isNaN(quantity) || quantity <= 0) {
                    showFeedbackModal({
                        type: 'warning',
                        title: 'Invalid Quantity',
                        message: 'Please enter a valid quantity greater than 0.'
                    });
                    return;
                }

                // Initialize inventory if needed
                if (!ingredient.inventory) {
                    ingredient.inventory = { stockQty: 0, reorderLevel: 0, location: '', restockHistory: [] };
                }
                if (!ingredient.inventory.restockHistory) {
                    ingredient.inventory.restockHistory = [];
                }

                // Get selected unit and convert to base unit (g/ml)
                const selectedUnit = document.getElementById('restock-unit-select').value;
                let stockToAddInBase = quantity;

                if (selectedUnit === 'kg') stockToAddInBase = quantity * 1000;
                else if (selectedUnit === 'l') stockToAddInBase = quantity * 1000;
                else if (selectedUnit === 'pcs') {
                    // Treat 'pcs' as the ingredient's defined unit size
                    // If ingredient is 'kg', 1 pcs = 1 kg = 1000g
                    // If ingredient is 'g', 1 pcs = 1 g
                    if (ingredient.unit === 'kg' || ingredient.unit === 'l') stockToAddInBase = quantity * 1000;
                    else stockToAddInBase = quantity;
                }
                // g, ml are basic units (factor 1)

                // Update ingredient stock (stored in base unit)
                if (!ingredient.inventory) ingredient.inventory = { stockQty: 0, reorderLevel: 0, restockHistory: [] };

                ingredient.inventory.stockQty = (ingredient.inventory.stockQty || 0) + stockToAddInBase;

                // Add to history (store ENTERED quantity and unit)
                if (!ingredient.inventory.restockHistory) ingredient.inventory.restockHistory = [];
                ingredient.inventory.restockHistory.unshift({
                    date: purchaseDate,
                    quantity: quantity,
                    unit: selectedUnit, // Store the unit user selected
                    timestamp: new Date().toISOString()
                });

                saveIngredients();
                renderInventory();
                closeRestockModal();

                showFeedbackModal({
                    type: 'success',
                    title: 'Stock Updated!',
                    message: `Added ${quantity} ${selectedUnit} to ${ingredient.name}.`
                });
            });

            const appendConversionInput = (unitName = '', grams = '', targetUnit = 'g') => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 conversion-row w-full';
                const predefinedUnits = ['tsp', 'tbsp', 'cup', '1 cup', '3/4 cup', '2/3 cup', '1/2 cup', '1/3 cup', '1/4 cup', '1/8 cup', '1/16 cup'];
                const datalistId = `unit-options-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const optionsHTML = predefinedUnits.map(unit => `<option value="${unit}">`).join('');

                div.innerHTML = `
                    <span class="font-mono text-sm">1</span>
                    <input list="${datalistId}" type="text" value="${unitName}" placeholder="1 cup" class="conversion-unit-name flex-1 min-w-0 p-1.5 border border-gray-300 rounded-lg text-sm bg-white focus-ring">
                    <datalist id="${datalistId}">${optionsHTML}</datalist>
                    <span class="font-mono text-sm">=</span>
                    <input type="number" placeholder="120" value="${grams}" step="0.01" min="0" class="conversion-grams w-24 p-1.5 border border-gray-300 rounded-lg text-sm focus-ring">
                    <select class="conversion-target-unit w-20 p-1.5 border border-gray-300 rounded-lg text-sm bg-white focus-ring">
                        <option value="g" ${targetUnit === 'g' ? 'selected' : ''}>g</option>
                        <option value="kg" ${targetUnit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="ml" ${targetUnit === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="l" ${targetUnit === 'l' ? 'selected' : ''}>l</option>
                        <option value="oz" ${targetUnit === 'oz' ? 'selected' : ''}>oz</option>
                        <option value="lb" ${targetUnit === 'lb' ? 'selected' : ''}>lb</option>
                    </select>
                    <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Remove Conversion">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                conversionsListDiv.appendChild(div);
            };
            // --- Multi-Supplier Tab Logic ---
            let currentEditSuppliers = [];
            let currentEditTabIndex = 0;

            const updateTabNavButtons = () => {
                const leftBtn = document.getElementById('tab-scroll-left');
                const rightBtn = document.getElementById('tab-scroll-right');

                if (!leftBtn || !rightBtn) return;

                if (currentEditTabIndex > 0) {
                    leftBtn.classList.remove('invisible', 'pointer-events-none');
                    leftBtn.disabled = false;
                } else {
                    leftBtn.classList.add('invisible', 'pointer-events-none');
                    leftBtn.disabled = true;
                }

                if (currentEditTabIndex < currentEditSuppliers.length - 1) {
                    rightBtn.classList.remove('invisible', 'pointer-events-none');
                    rightBtn.disabled = false;
                } else {
                    rightBtn.classList.add('invisible', 'pointer-events-none');
                    rightBtn.disabled = true;
                }
            };

            // Initialize Nav Listeners
            document.addEventListener('DOMContentLoaded', () => {
                const container = document.getElementById('edit-supplier-tabs');
                const leftBtn = document.getElementById('tab-scroll-left');
                const rightBtn = document.getElementById('tab-scroll-right');

                // Drag-to-Scroll Logic
                let isDown = false;
                let startX;
                let scrollLeft;

                const mouseMoveHandler = (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - container.offsetLeft;
                    const walk = (x - startX) * 2; // Scroll-fast multiplier
                    container.scrollLeft = scrollLeft - walk;

                    // If moved significantly (more than 5px), mark as dragging
                    if (Math.abs(walk) > 5) {
                        container.dataset.isDragging = 'true';
                    }
                };

                const mouseUpHandler = () => {
                    isDown = false;
                    container.classList.remove('cursor-grabbing');
                    container.classList.add('cursor-grab');

                    // Remove global listeners
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);

                    // Delay clearing drag flag to allow click event to process
                    setTimeout(() => { container.dataset.isDragging = 'false'; }, 50);
                };

                // Mouse Down - Attach to Container
                container.addEventListener('mousedown', (e) => {
                    isDown = true;
                    container.dataset.isDragging = 'false';
                    container.classList.add('cursor-grabbing');
                    container.classList.remove('cursor-grab');
                    startX = e.pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;

                    // Attach global listeners
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                });

                // Add initial cursor style
                container.classList.add('cursor-grab');
                // Prevent text selection during drag
                container.style.userSelect = 'none';

                // Update Button Click Handlers
                if (leftBtn) leftBtn.addEventListener('click', () => {
                    if (currentEditTabIndex > 0) switchSupplierTab(currentEditTabIndex - 1);
                });
                if (rightBtn) rightBtn.addEventListener('click', () => {
                    if (currentEditTabIndex < currentEditSuppliers.length - 1) switchSupplierTab(currentEditTabIndex + 1);
                });
            });

            const renderSupplierTabs = () => {
                const container = document.getElementById('edit-supplier-tabs');
                container.innerHTML = '';
                // Ensure helper classes are applied if re-rendered
                container.classList.add('cursor-grab', 'active:cursor-grabbing');

                currentEditSuppliers.forEach((sup, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = `supplier-tab ${index === currentEditTabIndex ? 'active' : ''}`;
                    const label = sup.supplierName || `Shop ${String.fromCharCode(65 + index)}`;

                    btn.innerHTML = `
                        <div class="tab-label-container"><span class="tab-label">${label}</span></div>
                        ${currentEditSuppliers.length > 1 ? '<span class="tab-close">&times;</span>' : ''}
                    `;

                    btn.onclick = (e) => {
                        // If we were just dragging, DO NOT switch tabs
                        // Note: 'isDragging' variable scope needs to be accessible here. 
                        // Since renderSupplierTabs is outside the DOMContentLoaded scope where the variable was defined, 
                        // we need to make sure isDragging is accessible or checking the class state.
                        // However, a cleaner way is to use a data attribute or check movement distance in the click itself if we rewrote it.
                        // But wait, the previous block I wrote was inside 'DOMContentLoaded'. 
                        // 'renderSupplierTabs' is defined outside.
                        // I need to handle the scope issue.

                        // FIX: I will check a global or attached property on the container.
                        if (container.dataset.isDragging === 'true') {
                            return;
                        }

                        if (e.target.classList.contains('tab-close')) {
                            e.stopPropagation();
                            removeSupplierTab(index);
                        } else {
                            switchSupplierTab(index);
                        }
                    };
                    container.appendChild(btn);
                });

                const addBtn = document.createElement('button');
                addBtn.id = 'add-tab-btn';
                addBtn.type = 'button';
                addBtn.className = 'ml-1 text-gray-400 hover:text-brand-pink-600 px-2 rounded hover:bg-brand-pink-50 text-xl font-light h-full flex items-center mb-1 flex-shrink-0';
                addBtn.textContent = '+';
                addBtn.onclick = addSupplierTab;
                container.appendChild(addBtn);

                updateActiveToggleUI();
                updateTabNavButtons();

                // Scroll logic to ensure visibility
                setTimeout(() => {
                    const activeBtn = container.querySelector('.supplier-tab.active');
                    if (activeBtn) {
                        if (currentEditTabIndex === currentEditSuppliers.length - 1) {
                            // If last tab, scroll to end to show Add button too
                            container.scrollTo({ left: container.scrollWidth, behavior: 'smooth' });
                        } else {
                            activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                        }
                    }
                }, 50);
            };

            const switchSupplierTab = (newIndex) => {
                if (currentEditSuppliers[currentEditTabIndex]) {
                    const s = currentEditSuppliers[currentEditTabIndex];
                    s.price = parseFloat(editPriceInput.value) || 0;
                    s.weight = parseFloat(editWeightInput.value) || 0;
                    s.unit = editUnitInput.value;
                    s.supplierName = editSupplierInput.value.trim();
                    s.notes = editNotesInput.value.trim();
                }

                currentEditTabIndex = newIndex;
                const next = currentEditSuppliers[newIndex];

                editPriceInput.value = next.price; // .toFixed handled by input type number usually, but raw value ok
                editWeightInput.value = next.weight;
                editUnitInput.value = next.unit;
                editSupplierInput.value = next.supplierName;
                editNotesInput.value = next.notes;

                renderSupplierTabs();
            };

            const addSupplierTab = () => {
                const firstTab = currentEditSuppliers[0];
                // Sync current input to array first (in case we are on tab 0)
                if (currentEditTabIndex === 0) firstTab.supplierName = editSupplierInput.value.trim();

                if (!firstTab.supplierName && currentEditSuppliers.length === 1) {
                    showFeedbackModal({
                        type: 'warning',
                        title: 'Missing Supplier Name',
                        message: 'Please enter a Supplier Name for the first shop before adding another.',
                        confirmText: 'OK'
                    });
                    editSupplierInput.focus();
                    return;
                }

                const currentSup = currentEditSuppliers[currentEditTabIndex];
                currentSup.supplierName = editSupplierInput.value.trim();
                if (!currentSup.supplierName) {
                    showFeedbackModal({
                        type: 'warning',
                        title: 'Missing Supplier Name',
                        message: 'Please name the current shop before adding a new one.',
                        confirmText: 'OK'
                    });
                    editSupplierInput.focus();
                    return;
                }

                currentEditSuppliers.push({
                    price: 0,
                    weight: 1,
                    unit: 'kg',
                    supplierName: '',
                    notes: '',
                    active: false
                });
                switchSupplierTab(currentEditSuppliers.length - 1);
                setTimeout(pushHistory, 0);
            };

            const removeSupplierTab = (index) => {
                showFeedbackModal({
                    type: 'danger',
                    title: 'Remove Supplier Tab?',
                    message: 'Are you sure you want to remove this supplier tab?',
                    confirmText: 'Delete',
                    onConfirm: () => {
                        const wasActive = currentEditSuppliers[index].active;
                        currentEditSuppliers.splice(index, 1);

                        if (currentEditSuppliers.length === 0) {
                            currentEditSuppliers.push({ price: 0, weight: 1, unit: 'kg', supplierName: '', notes: '', active: true });
                        } else if (wasActive) {
                            currentEditSuppliers[0].active = true;
                        }

                        if (index === currentEditTabIndex) {
                            switchSupplierTab(Math.max(0, index - 1));
                        } else if (index < currentEditTabIndex) {
                            currentEditTabIndex--;
                            renderSupplierTabs();
                        } else {
                            renderSupplierTabs();
                        }
                        setTimeout(pushHistory, 0);
                    }
                });
            };

            const updateActiveToggleUI = () => {
                const btn = document.getElementById('edit-active-toggle');
                const sup = currentEditSuppliers[currentEditTabIndex];
                const text = btn.querySelector('.toggle-text'); // updated selector

                if (sup && sup.active) {
                    btn.classList.remove('inactive');
                    btn.classList.add('active');
                    btn.title = "This price is currently used for calculations";
                    text.textContent = 'Active Price';
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                    btn.title = "Click to use this price for calculations";
                    text.textContent = 'Set active';
                }
            };

            const toggleActivePrice = () => {
                // Sync DOM first
                if (currentEditSuppliers[currentEditTabIndex]) {
                    const s = currentEditSuppliers[currentEditTabIndex];
                    s.price = parseFloat(editPriceInput.value);
                    s.weight = parseFloat(editWeightInput.value);
                    s.unit = editUnitInput.value;
                    s.supplierName = editSupplierInput.value.trim();
                    s.notes = editNotesInput.value.trim();
                }

                const s = currentEditSuppliers[currentEditTabIndex];
                // Strict validation: Price MUST be > 0.
                if (!s.supplierName || isNaN(s.price) || isNaN(s.weight) || s.price <= 0 || s.weight <= 0) {
                    showFeedbackModal({
                        type: 'warning',
                        title: 'Incomplete Details',
                        message: 'To set this price as Active, please fill in all details (Supplier Name, Price, Amount). Price must be greater than 0.',
                        confirmText: 'OK'
                    });
                    return;
                }

                currentEditSuppliers.forEach(s => s.active = false);
                currentEditSuppliers[currentEditTabIndex].active = true;
                updateActiveToggleUI();
                pushHistory();
            };

            document.getElementById('edit-active-toggle').onclick = toggleActivePrice;
            editSupplierInput.addEventListener('input', () => {
                if (currentEditSuppliers[currentEditTabIndex]) {
                    currentEditSuppliers[currentEditTabIndex].supplierName = editSupplierInput.value.trim();
                    renderSupplierTabs();
                }
            });

            const openEditModal = (id) => {
                const ingredientToEdit = ingredients.find(ing => ing.id === id);
                if (!ingredientToEdit) return;
                currentlyEditingId = id;
                editNameInput.value = ingredientToEdit.name;

                if (ingredientToEdit.suppliers && ingredientToEdit.suppliers.length > 0) {
                    currentEditSuppliers = JSON.parse(JSON.stringify(ingredientToEdit.suppliers));
                } else {
                    currentEditSuppliers = [{
                        price: ingredientToEdit.price,
                        weight: ingredientToEdit.weight,
                        unit: ingredientToEdit.unit,
                        supplierName: ingredientToEdit.supplier || '',
                        notes: ingredientToEdit.notes || '',
                        active: true
                    }];
                }

                const activeIndex = currentEditSuppliers.findIndex(s => s.active);
                currentEditTabIndex = activeIndex >= 0 ? activeIndex : 0;

                const sup = currentEditSuppliers[currentEditTabIndex];
                editPriceInput.value = sup.price;
                editWeightInput.value = sup.weight;
                editUnitInput.value = sup.unit;
                editSupplierInput.value = sup.supplierName;
                editNotesInput.value = sup.notes;

                // Load inventory fields with proper units
                const editStockQty = document.getElementById('edit-stock-qty');
                const editStockUnit = document.getElementById('edit-stock-unit');
                const editReorderLevel = document.getElementById('edit-reorder-level');
                const editReorderUnit = document.getElementById('edit-reorder-unit');
                const editStockLocation = document.getElementById('edit-stock-location');

                // Stock is stored in base unit (g/ml), display based on ingredient's saved display unit or default to base
                const stockQtyBase = ingredientToEdit.inventory?.stockQty || 0;
                const savedDisplayUnit = ingredientToEdit.inventory?.displayUnit || (ingredientToEdit.unit === 'kg' ? 'g' : (ingredientToEdit.unit === 'l' ? 'ml' : ingredientToEdit.unit));

                // Convert from base to display unit
                let displayStock = stockQtyBase;
                if (savedDisplayUnit === 'kg' && stockQtyBase > 0) displayStock = stockQtyBase / 1000;
                if (savedDisplayUnit === 'l' && stockQtyBase > 0) displayStock = stockQtyBase / 1000;

                if (editStockQty) editStockQty.value = displayStock || '';
                if (editStockUnit) editStockUnit.value = savedDisplayUnit;

                // Reorder level is stored in purchase unit
                if (editReorderLevel) editReorderLevel.value = ingredientToEdit.inventory?.reorderLevel || '';
                if (editReorderUnit) editReorderUnit.textContent = ingredientToEdit.unit;

                if (editStockLocation) editStockLocation.value = ingredientToEdit.inventory?.location || '';

                conversionsListDiv.innerHTML = '';
                if (ingredientToEdit.conversions && ingredientToEdit.conversions.length > 0) {
                    ingredientToEdit.conversions.forEach(conv => appendConversionInput(conv.unitName, conv.grams, conv.targetUnit || 'g'));
                }

                renderSupplierTabs();

                editHistory = [];
                historyStep = -1;
                pushHistory();
                updateHistoryButtons();

                editModal.classList.remove('hidden');
            };

            // --- UNDO/REDO LOGIC ---
            let editHistory = [];
            let historyStep = -1;
            let isUndoingRedoing = false;

            const captureEditState = () => {
                // Sync DOM
                if (currentEditSuppliers[currentEditTabIndex]) {
                    const s = currentEditSuppliers[currentEditTabIndex];
                    s.price = parseFloat(editPriceInput.value) || 0;
                    s.weight = parseFloat(editWeightInput.value) || 0;
                    s.unit = editUnitInput.value;
                    s.supplierName = editSupplierInput.value.trim();
                    s.notes = editNotesInput.value.trim();
                }

                const conversions = [];
                conversionsListDiv.querySelectorAll('.conversion-row').forEach(row => {
                    conversions.push({
                        unitName: row.querySelector('.conversion-unit-name').value,
                        grams: row.querySelector('.conversion-grams').value,
                        targetUnit: row.querySelector('.conversion-target-unit').value
                    });
                });
                return JSON.stringify({
                    name: editNameInput.value,
                    suppliers: currentEditSuppliers,
                    tabIndex: currentEditTabIndex,
                    conversions: conversions
                });
            };

            const restoreEditState = (stateStr) => {
                isUndoingRedoing = true;
                const state = JSON.parse(stateStr);
                editNameInput.value = state.name;
                currentEditSuppliers = JSON.parse(JSON.stringify(state.suppliers));
                currentEditTabIndex = state.tabIndex || 0;

                const sup = currentEditSuppliers[currentEditTabIndex];
                editPriceInput.value = sup.price;
                editWeightInput.value = sup.weight;
                editUnitInput.value = sup.unit;
                editSupplierInput.value = sup.supplierName;
                editNotesInput.value = sup.notes;

                renderSupplierTabs();

                conversionsListDiv.innerHTML = '';
                state.conversions.forEach(c => appendConversionInput(c.unitName, c.grams, c.targetUnit));
                isUndoingRedoing = false;
            };

            const pushHistory = () => {
                if (isUndoingRedoing) return;
                const state = captureEditState();

                // Dedup: Don't push if same as current top
                if (historyStep >= 0 && editHistory[historyStep] === state) return;

                historyStep++;
                editHistory = editHistory.slice(0, historyStep); // Truncate redo history
                editHistory.push(state);
                updateHistoryButtons();
            };

            const updateHistoryButtons = () => {
                if (historyStep > 0) { // Has history to undo (0 is initial)
                    editHistoryControls.classList.remove('hidden');
                } else {
                    editHistoryControls.classList.add('hidden');
                }

                editUndoBtn.disabled = historyStep <= 0;
                editRedoBtn.disabled = historyStep >= editHistory.length - 1;
            };

            editUndoBtn.addEventListener('click', () => {
                if (historyStep > 0) {
                    historyStep--;
                    restoreEditState(editHistory[historyStep]);
                    updateHistoryButtons();
                }
            });

            editRedoBtn.addEventListener('click', () => {
                if (historyStep < editHistory.length - 1) {
                    historyStep++;
                    restoreEditState(editHistory[historyStep]);
                    updateHistoryButtons();
                }
            });

            // Watch for changes
            editForm.addEventListener('input', () => {
                pushHistory();
            });
            // Also capture changes when adding/removing rows (handled in listener)
            conversionsListDiv.addEventListener('input', () => pushHistory()); // Delegate input for dynamic fields

            // Override original append for history
            const originalAppend = appendConversionInput; // Self-reference issue, better to wrap
            addConversionBtn.addEventListener('click', () => {
                // The original listener calls appendConversionInput, we need to capture state AFTER
                setTimeout(pushHistory, 0);
            });
            // Override remove click
            conversionsListDiv.addEventListener('click', (e) => {
                // Wait for existing listener to maybe remove it? 
                // The existing listener is: if (e.target.classList.contains('remove-btn')) e.target.closest('.conversion-row').remove();
                // We add another one that runs after
                if (e.target.closest('.remove-btn')) {
                    setTimeout(pushHistory, 0);
                }
            });
            const closeEditModal = () => { currentlyEditingId = null; editModal.classList.add('hidden'); };
            const openAddIngredientModal = () => addIngredientModal.classList.remove('hidden');
            const closeAddIngredientModal = () => {
                addIngredientForm.reset();
                addIngredientModal.classList.add('hidden');
            }
            const addIngredient = (e) => {
                try {
                    e.preventDefault();
                    const name = document.getElementById('add-name').value.trim();
                    const price = parseFloat(document.getElementById('add-price').value);
                    const weight = parseFloat(document.getElementById('add-weight').value);
                    const unit = document.getElementById('add-unit').value;

                    if (!name || isNaN(price) || isNaN(weight) || price <= 0 || weight <= 0) {
                        showFeedbackModal({
                            type: 'warning',
                            title: 'Invalid Input',
                            message: 'Please fill in all fields correctly. Price and Weight must be greater than 0.',
                            confirmText: 'OK'
                        });
                        return;
                    }

                    const newIngredient = { id: Date.now(), name, price, weight, unit, supplier: '', notes: '', conversions: [], dateAdded: new Date().toISOString() };
                    ingredients.push(newIngredient);
                    saveIngredients();
                    renderIngredients();
                    closeAddIngredientModal();

                    // Show success modal
                    showFeedbackModal({
                        type: 'success',
                        title: 'Ingredient Added!',
                        message: `${name} has been successfully added to your library.`
                    });
                } catch (err) {
                    console.error('Error in addIngredient:', err);
                    showFeedbackModal({
                        type: 'danger',
                        title: 'Error',
                        message: 'An unexpected error occurred while adding the ingredient. Please check the console for details.'
                    });
                }
            };

            // =================================================================
            // RECIPE PAGE FUNCTIONS
            // =================================================================
            const setupYieldUI = (modalType) => {
                const prefix = modalType === 'add' ? '' : 'edit-';
                const yieldTypeSelect = document.getElementById(`${prefix}recipe-yield-type`);
                const quantityFields = document.getElementById(`${prefix}yield-quantity-fields`);
                const sizeFields = document.getElementById(`${prefix}yield-size-fields`);
                const panShapeSelect = document.getElementById(`${prefix}recipe-pan-shape`);
                const rectangularFields = document.getElementById(`${prefix}pan-shape-rectangular`);
                const roundFields = document.getElementById(`${prefix}pan-shape-round`);

                if (!yieldTypeSelect) return;

                const updatePanels = () => {
                    if (yieldTypeSelect.value === 'quantity') {
                        quantityFields.classList.remove('hidden');
                        sizeFields.classList.add('hidden');
                    } else {
                        quantityFields.classList.add('hidden');
                        sizeFields.classList.remove('hidden');
                    }
                };

                const updateShapes = () => {
                    if (panShapeSelect.value === 'rectangular') {
                        rectangularFields.classList.remove('hidden');
                        roundFields.classList.add('hidden');
                    } else {
                        rectangularFields.classList.add('hidden');
                        roundFields.classList.remove('hidden');
                    }
                };

                yieldTypeSelect.addEventListener('change', updatePanels);
                panShapeSelect.addEventListener('change', updateShapes);

                updatePanels();
                updateShapes();
            };

            const openAddRecipeModal = () => {
                addRecipeModal.classList.remove('hidden');
                const categorySelect = document.getElementById('recipe-category');
                populateCategoryDropdown(categorySelect);
            };
            const closeAddRecipeModal = () => {
                Object.values(recipeTomSelectInstances).forEach(instance => instance.destroy());
                recipeTomSelectInstances = {};
                recipeForm.reset();
                recipeIngredientsList.innerHTML = '';
                addRecipeModal.classList.add('hidden');
            }

            const createIngredientOptions = () => {
                const ingredientOptions = ingredients.map(ing => `<option value="${ing.id}">${ing.name}</option>`).join('');
                return `<option value="">Select an ingredient...</option>${ingredientOptions}`;
            };

            const createUnitOptions = (ingredientId) => { const ingredient = ingredients.find(ing => ing.id === parseInt(ingredientId)); if (!ingredient) return ''; let units = []; if (['kg', 'g'].includes(ingredient.unit)) units.push('g', 'kg'); else if (['l', 'ml'].includes(ingredient.unit)) units.push('ml', 'l'); else units.push(ingredient.unit); if (ingredient.conversions) { ingredient.conversions.forEach(conv => units.push(conv.unitName)); } return [...new Set(units)].map(u => `<option value="${u}">${u}</option>`).join(''); };

            const addLibraryIngredientRow = () => {
                const div = document.createElement('div');
                const rowId = `row-${Date.now()}`;
                div.id = rowId;
                div.className = 'grid grid-cols-12 gap-2 items-center p-2 rounded-lg bg-gray-50 fade-in recipe-item-row';
                div.dataset.type = 'library';
                div.innerHTML = `
            <div class="col-span-7"><select class="ingredient-select w-full" required></select></div>
            <div class="col-span-2"><input type="number" step="0.01" placeholder="100" class="amount-input w-full p-2.5 border border-gray-300 rounded-lg text-sm focus-ring" required></div>
            <div class="col-span-2"><select class="unit-select w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white focus-ring" required disabled><option value="">Unit</option></select></div>
            <div class="col-span-1 text-right"><button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-50">&times;</button></div>
        `;
                recipeIngredientsList.appendChild(div);

                const ingredientSelect = div.querySelector('.ingredient-select');
                const unitSelect = div.querySelector('.unit-select');

                const tomInstance = new TomSelect(ingredientSelect, {
                    create: false,
                    placeholder: 'Search for an ingredient...',
                    plugins: ['dropdown_input'],
                    options: ingredients.map(ing => ({ value: ing.id, text: ing.name })),
                    onFocus: () => {
                        ingredientSelect.closest('.recipe-item-row').classList.add('is-active');
                    },
                    onBlur: () => {
                        ingredientSelect.closest('.recipe-item-row').classList.remove('is-active');
                    }
                });
                recipeTomSelectInstances[rowId] = tomInstance;

                tomInstance.on('change', (value) => {
                    unitSelect.innerHTML = createUnitOptions(value);
                    if (value) {
                        unitSelect.disabled = false;
                    } else {
                        unitSelect.disabled = true;
                    }
                });
            };

            const addOpenItemRow = () => { const div = document.createElement('div'); div.className = 'grid grid-cols-12 gap-2 items-center p-2 rounded-lg bg-gray-50 fade-in recipe-item-row'; div.dataset.type = 'open'; div.innerHTML = ` <div class="col-span-11"> <input type="text" placeholder="e.g., Water, Pinch of Salt" class="open-item-name w-full p-2.5 border border-gray-300 rounded-lg text-sm focus-ring" required> </div> <div class="col-span-1 text-right"> <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-50">&times;</button> </div> `; recipeIngredientsList.appendChild(div); };

            const formatAmount = (num) => {
                if (num === 0) return 0;
                if (isNaN(num) || num === null || num === undefined) return '?'; // Safeguard
                return parseFloat(num.toFixed(2));
            };

            // Animation Utility
            const animateValue = (obj, start, end, duration) => {
                if (!obj) return;
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const value = progress * (end - start) + start;
                    obj.textContent = `RM ${value.toFixed(2)}`;
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            };

            const calculateVolume = (servings) => {
                if (servings.type !== 'size' || !servings.shape) return 0;
                const height = servings.height;
                if (servings.shape === 'round') {
                    const radius = (servings.diameter || 0) / 2;
                    return Math.PI * Math.pow(radius, 2) * height;
                }
                if (servings.shape === 'rectangular') {
                    return (servings.length || 0) * (servings.width || 0) * height;
                }
                return 0;
            };

            const calculateRecipeCost = (recipe) => {
                let totalCost = 0;
                const breakdown = recipe.items.map(item => {
                    if (item.type === 'open') {
                        return { name: item.name, cost: 0, detail: '' };
                    }
                    const ingredient = ingredients.find(ing => ing.id === item.ingredientId);
                    if (!ingredient) {
                        return { name: 'Unknown Ingredient', cost: 0, detail: 'Ingredient not found' };
                    }

                    let costPerBaseUnit = 0, baseUnit = ingredient.unit, purchaseAmountInBaseUnit = ingredient.weight;
                    if (ingredient.unit === 'kg') { purchaseAmountInBaseUnit = ingredient.weight * 1000; baseUnit = 'g'; }
                    else if (ingredient.unit === 'l') { purchaseAmountInBaseUnit = ingredient.weight * 1000; baseUnit = 'ml'; }
                    if (purchaseAmountInBaseUnit > 0) { costPerBaseUnit = ingredient.price / purchaseAmountInBaseUnit; }

                    let requiredAmountInBaseUnit = item.amount;
                    let detail = `${formatAmount(item.amount)} ${item.unit}`;

                    if (item.unit === 'kg') {
                        requiredAmountInBaseUnit = item.amount * 1000;
                    } else if (item.unit === 'l') {
                        requiredAmountInBaseUnit = item.amount * 1000;
                    } else if (item.unit !== baseUnit) {
                        const conversion = ingredient.conversions.find(c => c.unitName === item.unit);
                        if (conversion) {
                            // Normalize conversion value to base unit
                            let conversionValue = conversion.grams; // This is the 'value' user entered
                            const targetUnit = conversion.targetUnit || 'g'; // Default to g for old data

                            // Multiplier to convert TARGET unit to BASE unit (g or ml)
                            let multiplier = 1;
                            if (targetUnit === 'kg' || targetUnit === 'l') multiplier = 1000;
                            else if (targetUnit === 'oz') multiplier = 28.35;
                            else if (targetUnit === 'lb') multiplier = 453.6;
                            // g and ml are treated as 1 (base)

                            requiredAmountInBaseUnit = item.amount * conversionValue * multiplier;
                            detail = `${formatAmount(item.amount)} ${item.unit} (${conversionValue}${targetUnit}/ea)`;
                        } else {
                            return { name: ingredient.name, cost: 0, detail: `Conversion for '${item.unit}' not defined` };
                        }
                    }
                    const itemCost = requiredAmountInBaseUnit * costPerBaseUnit;
                    totalCost += itemCost;
                    return { name: ingredient.name, cost: itemCost, detail: detail };
                });

                let finalPrice = totalCost, profitDetail = '';
                if (recipe.profit.type === 'percent') {
                    const profitAmount = totalCost * (recipe.profit.value / 100);
                    finalPrice += profitAmount;
                    profitDetail = `+ ${recipe.profit.value}% (RM ${profitAmount.toFixed(2)})`;
                } else if (recipe.profit.type === 'multiplier') {
                    finalPrice = totalCost * recipe.profit.value;
                    profitDetail = `x ${recipe.profit.value}`;
                }

                const servingsValue = recipe.servings.type === 'quantity' ? recipe.servings.value : (recipe.servings.quantity || 1);
                const costPerServing = servingsValue > 0 ? totalCost / servingsValue : 0;
                const pricePerServing = servingsValue > 0 ? finalPrice / servingsValue : 0;

                return { totalCost, finalPrice, pricePerServing, costPerServing, breakdown, profitDetail };
            };

            const displayScaledRecipe = (cardElement, recipeId, mode = 'pan') => {
                const originalRecipe = recipes.find(r => r.id === recipeId);
                if (!originalRecipe) return;

                let scalingFactor = 1;
                const scaledRecipe = JSON.parse(JSON.stringify(originalRecipe));

                if (mode === 'pan') { // Scale by Dimension
                    if (originalRecipe.servings.type === 'size') {
                        const originalVolume = calculateVolume(originalRecipe.servings);
                        const targetServings = { ...originalRecipe.servings };

                        // Gather inputs based on shape
                        const shape = targetServings.shape;
                        let newPrimaryDimension = 0; // Just for validation check

                        if (shape === 'round') {
                            const diameterInput = cardElement.querySelector(`.scale-input-diameter[data-id="${recipeId}"]`);
                            const heightInput = cardElement.querySelector(`.scale-input-height[data-id="${recipeId}"]`);
                            // Use fallback to original if empty, but try to parse if present
                            targetServings.diameter = diameterInput && diameterInput.value ? parseFloat(diameterInput.value) : targetServings.diameter;
                            targetServings.height = heightInput && heightInput.value ? parseFloat(heightInput.value) : targetServings.height;
                            newPrimaryDimension = targetServings.diameter; // simplified validation check
                        } else { // rectangular
                            const lengthInput = cardElement.querySelector(`.scale-input-length[data-id="${recipeId}"]`);
                            const widthInput = cardElement.querySelector(`.scale-input-width[data-id="${recipeId}"]`);
                            const heightInput = cardElement.querySelector(`.scale-input-height[data-id="${recipeId}"]`);

                            targetServings.length = lengthInput && lengthInput.value ? parseFloat(lengthInput.value) : targetServings.length;
                            targetServings.width = widthInput && widthInput.value ? parseFloat(widthInput.value) : targetServings.width;
                            targetServings.height = heightInput && heightInput.value ? parseFloat(heightInput.value) : targetServings.height;
                            newPrimaryDimension = targetServings.length; // simplified validation check
                        }

                        if (isNaN(newPrimaryDimension) || newPrimaryDimension <= 0) return; // Basic validation

                        const targetVolume = calculateVolume(targetServings);
                        if (originalVolume > 0) scalingFactor = targetVolume / originalVolume;

                        scaledRecipe.servings = targetServings;

                    } else {
                        // Fallback for quantity-type recipes forced into PAN mode
                        // Robustly find the VISIBLE input
                        const inputs = cardElement.querySelectorAll('.scale-input-qty');
                        const input = Array.from(inputs).find(el => el.offsetParent !== null);
                        const val = input ? parseFloat(input.value) : 0;
                        if (isNaN(val) || val <= 0) return;

                        const originalServings = originalRecipe.servings.value;
                        scalingFactor = val / originalServings;
                        scaledRecipe.servings.value = val;
                    }
                } else if (mode === 'pcs') { // Scale by Quantity
                    const inputs = cardElement.querySelectorAll('.scale-input-qty');
                    const input = Array.from(inputs).find(el => el.offsetParent !== null);
                    const val = input ? parseFloat(input.value) : 0;
                    if (isNaN(val) || val <= 0) return;

                    if (originalRecipe.servings.type === 'size') {
                        const originalQuantity = originalRecipe.servings.quantity || 1;
                        scalingFactor = val / originalQuantity;
                        scaledRecipe.servings.quantity = val;
                    } else {
                        const originalValue = originalRecipe.servings.value;
                        scalingFactor = val / originalValue;
                        scaledRecipe.servings.value = val;
                    }
                }

                scaledRecipe.items = originalRecipe.items.map(item => {
                    if (item.type === 'library') {
                        return { ...item, amount: item.amount * scalingFactor };
                    }
                    return item;
                });
                // Capture OLD values for animation
                const summaryBody = cardElement.querySelector('.summary-table-body');
                let startTotal = 0, startServing = 0, startFinal = 0, startSell = 0;

                if (summaryBody) {
                    const cleanVal = (txt) => parseFloat(txt.replace(/[^0-9.-]+/g, '')) || 0;
                    // Try to find via classes first, fallback to row indices
                    const totalEl = summaryBody.querySelector('.summary-total-cost') || summaryBody.querySelectorAll('tr')[0]?.querySelectorAll('td')[1];
                    const servingEl = summaryBody.querySelector('.summary-serving-cost') || summaryBody.querySelectorAll('tr')[1]?.querySelectorAll('td')[1];
                    const finalEl = summaryBody.querySelector('.summary-final-price') || summaryBody.querySelectorAll('tr')[3]?.querySelectorAll('td')[1];
                    const sellEl = summaryBody.querySelector('.summary-sell-price') || summaryBody.querySelectorAll('tr')[4]?.querySelectorAll('td')[1];

                    if (totalEl) startTotal = cleanVal(totalEl.textContent);
                    if (servingEl) startServing = cleanVal(servingEl.textContent);
                    if (finalEl) startFinal = cleanVal(finalEl.textContent);
                    if (sellEl) startSell = cleanVal(sellEl.textContent);
                }

                const calc = calculateRecipeCost(scaledRecipe);

                const breakdownTbody = cardElement.querySelector('.grid > div:first-child table tbody');
                breakdownTbody.innerHTML = calc.breakdown.map(item => `
            <tr class="border-b">
                <td class="py-2 pr-4 text-gray-700 font-medium">${item.name} <span class="text-xs text-brand-indigo-700 font-normal">(${item.detail})</span></td>
                <td class="py-2 pl-4 text-right font-mono whitespace-nowrap">${item.cost > 0 ? `RM ${item.cost.toFixed(2)}` : '-'}</td>
            </tr>`).join('');

                const summaryTbody = cardElement.querySelector('.summary-table-body');

                let finalPriceServingsText = '';
                if (scaledRecipe.servings.type === 'size') {
                    const { shape, length, width, diameter, unit } = scaledRecipe.servings;
                    finalPriceServingsText = shape === 'round' ? `${formatAmount(diameter)}"` : `${formatAmount(length)}"x${formatAmount(width)}" ${unit}`;
                } else {
                    finalPriceServingsText = `${scaledRecipe.servings.value} ${scaledRecipe.servings.unit}`;
                }

                summaryTbody.innerHTML = `
            <tr><td class="py-1 pr-2">Total Ingredient Cost</td><td class="py-1 pl-2 text-right font-bold summary-total-cost">RM ${calc.totalCost.toFixed(2)}</td></tr>
            <tr><td class="py-1 pr-2 text-gray-600">Cost per Serving</td><td class="py-1 pl-2 text-right text-gray-800 font-mono summary-serving-cost">RM ${calc.costPerServing.toFixed(2)}</td></tr>
            <tr><td class="py-1 pr-2">Profit</td><td class="py-1 pl-2 text-right">${calc.profitDetail}</td></tr>
            <tr class="border-t-2 border-gray-300"><td class="pt-2 pr-2 text-lg font-bold text-brand-pink-700">Final Price (${finalPriceServingsText})</td><td class="pt-2 pl-2 text-right text-lg font-bold text-brand-pink-700 summary-final-price">RM ${calc.finalPrice.toFixed(2)}</td></tr>
            <tr><td class="py-1 pr-2 text-green-700 font-semibold">Sell Price per Serving</td><td class="py-1 pl-2 text-right text-green-700 font-semibold summary-sell-price">RM ${calc.pricePerServing.toFixed(2)}</td></tr>
        `;

                // Trigger Animations
                animateValue(summaryTbody.querySelector('.summary-total-cost'), startTotal, calc.totalCost, 800);
                animateValue(summaryTbody.querySelector('.summary-serving-cost'), startServing, calc.costPerServing, 800);
                animateValue(summaryTbody.querySelector('.summary-final-price'), startFinal, calc.finalPrice, 800);
                animateValue(summaryTbody.querySelector('.summary-sell-price'), startSell, calc.pricePerServing, 800);

                cardElement.querySelector('.scale-btn').classList.add('hidden');
                cardElement.querySelector('.reset-btn').classList.remove('hidden');
            };

            const renderRecipes = (activeCategoryId = 'all') => {
                recipeListDisplay.innerHTML = '';

                // 1. Group recipes by their category
                const categorizedRecipes = recipes.reduce((acc, recipe) => {
                    const categoryId = recipe.categoryId || 0; // Default to "Uncategorized"
                    if (!acc[categoryId]) {
                        acc[categoryId] = [];
                    }
                    acc[categoryId].push({ ...recipe, calculatedCost: calculateRecipeCost(recipe).totalCost });
                    return acc;
                }, {});

                const allCategories = [{ id: 0, name: 'Uncategorized' }, ...categories];

                // 2. Loop through each category to display it
                allCategories.forEach(category => {
                    // If a filter is active, skip categories that don't match
                    // THIS IS THE CORRECTED LINE:
                    if (activeCategoryId !== 'all' && category.id !== parseInt(activeCategoryId, 10)) return;

                    let recipesInCategory = categorizedRecipes[category.id] || [];
                    if (recipesInCategory.length === 0) return;

                    // 3. Apply search and sort to the recipes within this category
                    const searchTerm = recipeSearchInput.value.toLowerCase();
                    if (searchTerm) {
                        recipesInCategory = recipesInCategory.filter(recipe => recipe.title.toLowerCase().includes(searchTerm));
                    }
                    const sortBy = recipeSortSelect.value;
                    recipesInCategory.sort((a, b) => {
                        switch (sortBy) {
                            case 'title-az': return a.title.localeCompare(b.title);
                            case 'title-za': return b.title.localeCompare(a.title);
                            case 'cost-desc': return b.calculatedCost - a.calculatedCost;
                            case 'cost-asc': return a.calculatedCost - b.calculatedCost;
                            case 'oldest': return a.id - b.id;
                            case 'latest': default: return b.id - a.id;
                        }
                    });

                    if (recipesInCategory.length === 0) return;

                    // 4. Create the HTML for the category section and its recipe cards
                    const categorySection = document.createElement('div');
                    categorySection.className = "space-y-6 mb-8";
                    categorySection.innerHTML = `<h3 class="text-2xl font-bold border-b-2 pb-2">${category.name}</h3>`;

                    recipesInCategory.forEach(recipe => {
                        const calc = calculateRecipeCost(recipe);
                        const recipeCard = document.createElement('div');
                        recipeCard.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-6';
                        const breakdownHTML = calc.breakdown.map(item => ` <tr class="border-b last:border-b-0 border-gray-100"> <td class="py-2 pr-4 text-gray-700 font-medium">${item.name} ${item.detail ? `<span class="text-xs text-gray-500 font-normal">(${item.detail})</span>` : ''}</td> <td class="py-2 pl-4 text-right font-mono whitespace-nowrap">${item.cost > 0 ? `RM ${item.cost.toFixed(2)}` : '-'}</td> </tr> `).join('');

                        const isPanMode = recipe.servings.type === 'size'; // Default to PAN if it's a size-based recipe
                        let yieldText = '';
                        let finalPriceServingsText = '';
                        if (recipe.servings.type === 'size') {
                            const { quantity, shape, length, width, height, diameter, roundHeight, unit, panUnit } = recipe.servings;
                            const displayUnit = panUnit || unit;
                            const dimensionText = shape === 'round' ? `${diameter}" x ${roundHeight}" (Round)` : `${length}" x ${width}" x ${height}"`;
                            yieldText = `${quantity} x ${dimensionText} ${displayUnit}`;
                            finalPriceServingsText = `${quantity} ${displayUnit}`;
                        } else {
                            yieldText = `${recipe.servings.value} ${recipe.servings.unit}`;
                            finalPriceServingsText = `${recipe.servings.value} ${recipe.servings.unit}`;
                        }

                        const isLongList = calc.breakdown.length > 6;
                        const containerClasses = `breakdown-container ${isLongList ? 'is-collapsed' : ''}`;
                        const toggleButtonHTML = isLongList ? `<button class="toggle-scroll-btn mt-2 text-sm font-semibold text-brand-pink-600 hover:text-brand-pink-800" data-id="${recipe.id}">See More</button>` : '';

                        recipeCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${recipe.title}</h3>
                        <p class="text-sm text-gray-500">Yields: ${yieldText}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="shopping-list-btn flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm" data-id="${recipe.id}" title="Generate Shopping List">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                        </button>
                        <button class="edit-recipe-btn flex items-center justify-center w-8 h-8 bg-brand-pink-600 text-white rounded-lg hover:bg-brand-pink-700 transition-colors shadow-sm" data-id="${recipe.id}" title="Edit Recipe">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2 border-b pb-1">Cost Breakdown</h4>
                        <div class="${containerClasses}"><table class="w-full text-sm"><tbody>${breakdownHTML}</tbody></table></div>
                        ${toggleButtonHTML}
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h4 class="font-semibold text-gray-700 mb-2 border-b pb-1">Summary</h4>
                        <table class="w-full text-sm">
                            <tbody class="summary-table-body">
                                <tr><td class="py-1 pr-2">Total Ingredient Cost</td><td class="py-1 pl-2 text-right font-bold text-gray-800 summary-total-cost">RM ${calc.totalCost.toFixed(2)}</td></tr>
                                <tr><td class="py-1 pr-2 text-gray-600">Cost per Serving</td><td class="py-1 pl-2 text-right text-gray-800 font-mono summary-serving-cost">RM ${calc.costPerServing.toFixed(2)}</td></tr>
                                <tr><td class="py-1 pr-2">Profit</td><td class="py-1 pl-2 text-right">${calc.profitDetail}</td></tr>
                                <tr class="border-t-2 border-gray-300"><td class="pt-2 pr-2 text-lg font-bold text-brand-pink-700">Final Price (${finalPriceServingsText})</td><td class="pt-2 pl-2 text-right text-lg font-bold text-brand-pink-700 summary-final-price">RM ${calc.finalPrice.toFixed(2)}</td></tr>
                                <tr><td class="py-1 pr-2 text-green-700 font-semibold">Sell Price per Serving</td><td class="py-1 pl-2 text-right text-green-700 font-semibold summary-sell-price">RM ${calc.pricePerServing.toFixed(2)}</td></tr>
                            </tbody>
                        </table>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex items-center justify-between mb-3">
                                <label class="text-sm font-medium text-gray-600">Scale Recipe to:</label>
                                <div class="flex bg-gray-100 p-0.5 rounded-lg">
                                    <button class="scale-mode-btn flex items-center justify-center px-4 py-1 text-xs font-semibold rounded-md transition-all ${isPanMode ? 'bg-brand-pink-600 text-white shadow-sm' : 'text-gray-500 hover:text-gray-700'}" data-mode="pan" data-id="${recipe.id}">
                                        PAN
                                    </button>
                                    <button class="scale-mode-btn flex items-center justify-center px-4 py-1 text-xs font-semibold rounded-md transition-all ${!isPanMode ? 'bg-brand-pink-600 text-white shadow-sm' : 'text-gray-500 hover:text-gray-700'}" data-mode="pcs" data-id="${recipe.id}">
                                        PCS
                                    </button>
                                </div>
                            </div>
                            
                            <div class="scale-inputs-container gap-2 flex-wrap ${isPanMode ? '' : 'hidden'}" data-container-mode="pan" data-id="${recipe.id}">
                                ${recipe.servings.type === 'size' && recipe.servings.shape === 'rectangular' ?
                                `<div class="flex gap-2 w-full"><input type="number" step="any" placeholder="L (${recipe.servings.unit})" class="scale-input-length w-full p-2 border border-gray-300 rounded-lg text-sm focus-ring" data-id="${recipe.id}"><input type="number" step="any" placeholder="W (${recipe.servings.unit})" class="scale-input-width w-full p-2 border border-gray-300 rounded-lg text-sm focus-ring" data-id="${recipe.id}"><input type="number" step="any" placeholder="H (${recipe.servings.unit})" class="scale-input-height w-full p-2 border border-gray-300 rounded-lg text-sm focus-ring" data-id="${recipe.id}"></div>` : ''}

                                ${recipe.servings.type === 'size' && recipe.servings.shape === 'round' ?
                                `<div class="flex gap-2 w-full"><input type="number" step="any" placeholder="Dia (${recipe.servings.unit})" class="scale-input-diameter w-full p-2 border border-gray-300 rounded-lg text-sm focus-ring" data-id="${recipe.id}"><input type="number" step="any" placeholder="H (${recipe.servings.unit})" class="scale-input-height w-full p-2 border border-gray-300 rounded-lg text-sm focus-ring" data-id="${recipe.id}"></div>` : ''}
                                
                                ${recipe.servings.type !== 'size' ?
                                `<input type="number" min="0.1" step="any" placeholder="New Yield Amount" class="scale-input-qty w-full p-2 border border-gray-300 rounded-lg text-sm focus-ring" data-id="${recipe.id}">` : ''}
                            </div>

                            <div class="scale-inputs-container ${!isPanMode ? '' : 'hidden'}" data-container-mode="pcs" data-id="${recipe.id}">
                                <input type="number" min="1" step="any" placeholder="New Quantity (pcs)" class="scale-input-qty w-full p-2 border border-gray-300 rounded-lg text-sm focus-ring" data-id="${recipe.id}">
                            </div>

                            <div class="flex gap-2 mt-2">
                                <button class="scale-btn w-full py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg text-sm hover:bg-gray-700" data-id="${recipe.id}">Scale</button>
                                <button class="reset-btn hidden w-full py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg text-sm hover:bg-gray-300" data-id="${recipe.id}">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                        categorySection.appendChild(recipeCard);
                    });
                    recipeListDisplay.appendChild(categorySection);
                });

                if (recipeListDisplay.innerHTML.trim() === '') {
                    recipeListDisplay.innerHTML = `<div class="bg-white rounded-xl shadow-sm border border-gray-200"><p class="text-center text-gray-500 py-10 px-6">No recipes found.</p></div>`;
                }
            };

            const addEditLibraryIngredientRow = (item) => {
                const div = document.createElement('div');
                const rowId = `edit-row-${Date.now()}`;
                div.id = rowId;
                div.className = 'grid grid-cols-12 gap-2 items-center p-2 rounded-lg bg-gray-50 fade-in recipe-item-row';
                div.dataset.type = 'library';
                div.innerHTML = `
            <div class="col-span-7"><select class="ingredient-select w-full" required></select></div>
            <div class="col-span-2"><input type="number" step="0.01" value="${item.amount || ''}" placeholder="100" class="amount-input w-full p-2.5 border border-gray-300 rounded-lg text-sm focus-ring" required></div>
            <div class="col-span-2"><select class="unit-select w-full p-2.5 border border-gray-300 rounded-lg text-sm bg-white focus-ring" required>${createUnitOptions(item.ingredientId)}</select></div>
            <div class="col-span-1 text-right">
                <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Remove Ingredient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        `;
                editRecipeIngredientsList.appendChild(div);

                const ingredientSelect = div.querySelector('.ingredient-select');
                const unitSelect = div.querySelector('.unit-select');
                unitSelect.value = item.unit;

                const tomInstance = new TomSelect(ingredientSelect, {
                    plugins: ['dropdown_input'],
                    options: ingredients.map(ing => ({ value: ing.id, text: ing.name })),
                    onFocus: () => {
                        ingredientSelect.closest('.recipe-item-row').classList.add('is-active');
                    },
                    onBlur: () => {
                        ingredientSelect.closest('.recipe-item-row').classList.remove('is-active');
                    }
                });
                editRecipeTomSelectInstances[rowId] = tomInstance;
                if (item.ingredientId) {
                    tomInstance.setValue(item.ingredientId);
                }

                tomInstance.on('change', (value) => {
                    unitSelect.innerHTML = createUnitOptions(value);
                    if (value) unitSelect.disabled = false; else unitSelect.disabled = true;
                });
            };

            const addEditOpenItemRow = (item) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-12 gap-2 items-center p-2 rounded-lg bg-gray-50 fade-in recipe-item-row';
                div.dataset.type = 'open';
                div.innerHTML = `
            <div class="col-span-7"><input type="text" value="${item.name || ''}" placeholder="e.g., Water" class="open-item-name w-full p-2.5 border border-gray-300 rounded-lg text-sm focus-ring" required></div>
            <div class="col-span-5 text-right">
                <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Remove Item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        `;
                editRecipeIngredientsList.appendChild(div);
            };

            // --- ADD RECIPE UNDO/REDO IMPLEMENTATION ---
            let addRecipeHistory = [];
            let addRecipeHistoryStep = -1;
            let isAddRecipeUndoingRedoing = false;

            const captureAddRecipeState = () => {
                const items = [];
                recipeIngredientsList.querySelectorAll('.recipe-item-row').forEach(row => {
                    if (row.dataset.type === 'library') {
                        const ingSelect = row.querySelector('.ingredient-select');
                        const amtInput = row.querySelector('.amount-input');
                        const unitSelect = row.querySelector('.unit-select');
                        // Get value from TomSelect instance if possible
                        let ingId = ingSelect.value;
                        if (recipeTomSelectInstances[row.id] && recipeTomSelectInstances[row.id].getValue()) {
                            ingId = recipeTomSelectInstances[row.id].getValue();
                        }

                        items.push({
                            type: 'library',
                            ingredientId: ingId ? parseInt(ingId, 10) : null,
                            amount: amtInput.value,
                            unit: unitSelect.value
                        });
                    } else {
                        const nameInput = row.querySelector('.open-item-name');
                        items.push({
                            type: 'open',
                            name: nameInput.value
                        });
                    }
                });

                const servings = {
                    type: document.getElementById('recipe-yield-type').value,
                    value: document.getElementById('recipe-servings-value').value,
                    unit: document.getElementById('recipe-servings-unit').value,
                    quantity: document.getElementById('recipe-pan-quantity').value,
                    shape: document.getElementById('recipe-pan-shape').value,
                    length: document.getElementById('recipe-pan-length').value,
                    width: document.getElementById('recipe-pan-width').value,
                    height: document.getElementById('recipe-pan-height').value,
                    diameter: document.getElementById('recipe-pan-diameter').value,
                    roundHeight: document.getElementById('recipe-pan-height-round').value,
                    panUnit: document.getElementById('recipe-pan-unit').value
                };

                const profit = {
                    type: document.getElementById('profit-type').value,
                    value: document.getElementById('profit-value').value
                };

                return JSON.stringify({
                    title: document.getElementById('recipe-title').value,
                    categoryId: document.getElementById('recipe-category').value,
                    servings,
                    profit,
                    items
                });
            };

            const restoreAddRecipeState = (stateStr) => {
                isAddRecipeUndoingRedoing = true;
                const state = JSON.parse(stateStr);

                // Basic Info
                document.getElementById('recipe-title').value = state.title;
                document.getElementById('recipe-category').value = state.categoryId;

                // Yields
                document.getElementById('recipe-yield-type').value = state.servings.type;
                document.getElementById('recipe-servings-value').value = state.servings.value;
                document.getElementById('recipe-servings-unit').value = state.servings.unit;
                document.getElementById('recipe-pan-quantity').value = state.servings.quantity;
                document.getElementById('recipe-pan-shape').value = state.servings.shape;
                document.getElementById('recipe-pan-length').value = state.servings.length;
                document.getElementById('recipe-pan-width').value = state.servings.width;
                document.getElementById('recipe-pan-height').value = state.servings.height;
                document.getElementById('recipe-pan-diameter').value = state.servings.diameter;
                document.getElementById('recipe-pan-height-round').value = state.servings.roundHeight;
                document.getElementById('recipe-pan-unit').value = state.servings.panUnit;

                // Trigger change to update UI
                setupYieldUI('add');

                // Profit
                document.getElementById('profit-type').value = state.profit.type;
                document.getElementById('profit-value').value = state.profit.value;

                // Ingredients
                recipeIngredientsList.innerHTML = '';
                // Clear TomSelect instances for deleted rows (handled roughly by overwriting list)
                // Note: older instances remain in 'recipeTomSelectInstances' object but keys won't collide due to Date.now() 

                state.items.forEach(item => {
                    if (item.type === 'library') {
                        addLibraryIngredientRow();
                        const row = recipeIngredientsList.lastElementChild;
                        const rowId = row.id;

                        setTimeout(() => { // Small delay to ensure TomSelect init
                            const tom = recipeTomSelectInstances[rowId];
                            if (tom && item.ingredientId) {
                                tom.setValue(item.ingredientId);
                                // Set other fields after TomSelect populates units
                                setTimeout(() => {
                                    row.querySelector('.amount-input').value = item.amount;
                                    row.querySelector('.unit-select').value = item.unit;
                                    row.querySelector('.unit-select').disabled = false;
                                }, 10);
                            }
                        }, 0);
                    } else {
                        addOpenItemRow();
                        const row = recipeIngredientsList.lastElementChild;
                        row.querySelector('.open-item-name').value = item.name;
                    }
                });

                isAddRecipeUndoingRedoing = false;
            };

            const pushAddRecipeHistory = () => {
                if (isAddRecipeUndoingRedoing) return;
                const state = captureAddRecipeState();
                if (addRecipeHistoryStep >= 0 && addRecipeHistory[addRecipeHistoryStep] === state) return;

                addRecipeHistoryStep++;
                addRecipeHistory = addRecipeHistory.slice(0, addRecipeHistoryStep);
                addRecipeHistory.push(state);
                updateAddRecipeHistoryButtons();
            };

            const updateAddRecipeHistoryButtons = () => {
                const controls = document.getElementById('add-recipe-history-controls');
                if (addRecipeHistoryStep > 0) {
                    controls.classList.remove('hidden');
                } else {
                    controls.classList.add('hidden');
                }
                document.getElementById('add-recipe-undo-btn').disabled = addRecipeHistoryStep <= 0;
                document.getElementById('add-recipe-redo-btn').disabled = addRecipeHistoryStep >= addRecipeHistory.length - 1;
            };

            // Event Listeners
            document.getElementById('add-recipe-undo-btn').addEventListener('click', () => {
                if (addRecipeHistoryStep > 0) {
                    addRecipeHistoryStep--;
                    restoreAddRecipeState(addRecipeHistory[addRecipeHistoryStep]);
                    updateAddRecipeHistoryButtons();
                }
            });

            document.getElementById('add-recipe-redo-btn').addEventListener('click', () => {
                if (addRecipeHistoryStep < addRecipeHistory.length - 1) {
                    addRecipeHistoryStep++;
                    restoreAddRecipeState(addRecipeHistory[addRecipeHistoryStep]);
                    updateAddRecipeHistoryButtons();
                }
            });

            document.getElementById('recipe-form').addEventListener('input', () => {
                pushAddRecipeHistory();
            });
            // Capture changes in recipe ingredients list (delegated)
            recipeIngredientsList.addEventListener('input', () => pushAddRecipeHistory());
            recipeIngredientsList.addEventListener('click', (e) => {
                if (e.target.closest('.remove-btn')) {
                    setTimeout(pushAddRecipeHistory, 50); // Delay to let row removal happen
                }
            });
            document.getElementById('add-library-ingredient-btn').addEventListener('click', () => setTimeout(pushAddRecipeHistory, 50));
            document.getElementById('add-open-item-btn').addEventListener('click', () => setTimeout(pushAddRecipeHistory, 50));

            // Hook into Open Modal to reset history
            // Finding the Add Recipe button via text content since ID is missing
            document.addEventListener('DOMContentLoaded', () => {
                const addRecipeBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.trim().includes('Add Recipe') && !b.id);
                if (addRecipeBtn) {
                    addRecipeBtn.addEventListener('click', () => {
                        addRecipeHistory = [];
                        addRecipeHistoryStep = -1;
                        setTimeout(pushAddRecipeHistory, 100); // Capture initial state once modal is ready
                    });
                }
            });

            const openEditRecipeModal = (recipeId) => {
                const recipeToEdit = recipes.find(r => r.id === recipeId);
                if (!recipeToEdit) return;
                currentlyEditingRecipeId = recipeId;

                // --- Basic Info ---
                document.getElementById('edit-recipe-title').value = recipeToEdit.title;

                // --- Populate Category Dropdown ---
                const categorySelect = document.getElementById('edit-recipe-category');
                populateCategoryDropdown(categorySelect, recipeToEdit.categoryId);

                // --- Yields Section ---
                const { servings } = recipeToEdit;
                const yieldTypeSelect = document.getElementById('edit-recipe-yield-type');
                yieldTypeSelect.value = servings.type || 'quantity';

                if (servings.type === 'size') {
                    document.getElementById('edit-recipe-pan-shape').value = servings.shape;
                    document.getElementById('edit-recipe-pan-quantity').value = servings.quantity;
                    document.getElementById('edit-recipe-pan-unit').value = servings.unit;
                    document.getElementById('edit-recipe-pan-length').value = servings.length || '';
                    document.getElementById('edit-recipe-pan-width').value = servings.width || '';
                    document.getElementById('edit-recipe-pan-height').value = servings.shape === 'rectangular' ? servings.height : '';
                    document.getElementById('edit-recipe-pan-diameter').value = servings.diameter || '';
                    document.getElementById('edit-recipe-pan-height-round').value = servings.shape === 'round' ? servings.height : '';
                } else {
                    document.getElementById('edit-recipe-servings-value').value = servings.value;
                    document.getElementById('edit-recipe-servings-unit').value = servings.unit;
                }
                setupYieldUI('edit');

                // --- Profit Calculation ---
                document.getElementById('edit-profit-type').value = recipeToEdit.profit.type;
                document.getElementById('edit-profit-value').value = recipeToEdit.profit.value;

                // --- Ingredients List ---
                editRecipeIngredientsList.innerHTML = '';
                recipeToEdit.items.forEach(item => {
                    if (item.type === 'library') {
                        addEditLibraryIngredientRow(item);
                    } else {
                        addEditOpenItemRow(item);
                    }
                });

                editRecipeModal.classList.remove('hidden');

                // Initialize History
                recipeEditHistory = [];
                recipeHistoryStep = -1;
                pushRecipeHistory();
                updateRecipeHistoryButtons();
            };

            // --- RECIPE UNDO/REDO IMPLEMENTATION ---
            const captureRecipeState = () => {
                const items = [];
                editRecipeIngredientsList.querySelectorAll('.recipe-item-row').forEach(row => {
                    if (row.dataset.type === 'library') {
                        // For library items, we need ingredientId, amount, unit
                        // If TomSelect is destroyed or not ready, fallback might be needed but usually value is there
                        const ingSelect = row.querySelector('.ingredient-select');
                        const amtInput = row.querySelector('.amount-input');
                        const unitSelect = row.querySelector('.unit-select');
                        items.push({
                            type: 'library',
                            ingredientId: ingSelect.value ? parseInt(ingSelect.value, 10) : null,
                            amount: amtInput.value,
                            unit: unitSelect.value
                        });
                    } else {
                        const nameInput = row.querySelector('.open-item-name');
                        items.push({
                            type: 'open',
                            name: nameInput.value
                        });
                    }
                });

                const servings = {
                    type: document.getElementById('edit-recipe-yield-type').value,
                    value: document.getElementById('edit-recipe-servings-value').value,
                    unit: document.getElementById('edit-recipe-servings-unit').value,
                    quantity: document.getElementById('edit-recipe-pan-quantity').value,
                    shape: document.getElementById('edit-recipe-pan-shape').value,
                    length: document.getElementById('edit-recipe-pan-length').value,
                    width: document.getElementById('edit-recipe-pan-width').value,
                    height: document.getElementById('edit-recipe-pan-height').value, // Rect uses this
                    diameter: document.getElementById('edit-recipe-pan-diameter').value,
                    heightRound: document.getElementById('edit-recipe-pan-height-round').value, // Round uses this
                    panUnit: document.getElementById('edit-recipe-pan-unit').value
                };

                return JSON.stringify({
                    title: document.getElementById('edit-recipe-title').value,
                    categoryId: document.getElementById('edit-recipe-category').value,
                    servings: servings,
                    profitType: document.getElementById('edit-profit-type').value,
                    profitValue: document.getElementById('edit-profit-value').value,
                    items: items
                });
            };

            const restoreRecipeState = (stateStr) => {
                isRecipeUndoingRedoing = true;
                const state = JSON.parse(stateStr);

                // Restore Basic Info
                document.getElementById('edit-recipe-title').value = state.title;
                document.getElementById('edit-recipe-category').value = state.categoryId;

                // Restore Yields - Set values then trigger UI update
                document.getElementById('edit-recipe-yield-type').value = state.servings.type;
                document.getElementById('edit-recipe-servings-value').value = state.servings.value;
                document.getElementById('edit-recipe-servings-unit').value = state.servings.unit;

                document.getElementById('edit-recipe-pan-quantity').value = state.servings.quantity;
                document.getElementById('edit-recipe-pan-shape').value = state.servings.shape;
                document.getElementById('edit-recipe-pan-length').value = state.servings.length;
                document.getElementById('edit-recipe-pan-width').value = state.servings.width;
                document.getElementById('edit-recipe-pan-height').value = state.servings.height;
                document.getElementById('edit-recipe-pan-diameter').value = state.servings.diameter;
                document.getElementById('edit-recipe-pan-height-round').value = state.servings.heightRound;
                document.getElementById('edit-recipe-pan-unit').value = state.servings.panUnit;

                setupYieldUI('edit'); // Refresh visibility

                // Restore Profit
                document.getElementById('edit-profit-type').value = state.profitType;
                document.getElementById('edit-profit-value').value = state.profitValue;

                // Restore Items
                // Destroy existing instances first to avoid leaks
                Object.values(editRecipeTomSelectInstances).forEach(i => i.destroy());
                editRecipeTomSelectInstances = {};
                editRecipeIngredientsList.innerHTML = '';

                state.items.forEach(item => {
                    if (item.type === 'library') {
                        // We need to pass the IDs back. amount/unit are strings in state, convert if needed? 
                        // addEditLibraryIngredientRow expects {ingredientId, amount, unit}
                        addEditLibraryIngredientRow({
                            ingredientId: item.ingredientId,
                            amount: item.amount,
                            unit: item.unit
                        });
                    } else {
                        addEditOpenItemRow({ name: item.name });
                    }
                });

                isRecipeUndoingRedoing = false;
            };

            const pushRecipeHistory = () => {
                if (isRecipeUndoingRedoing) return;
                const state = captureRecipeState();
                if (recipeHistoryStep >= 0 && recipeEditHistory[recipeHistoryStep] === state) return;

                recipeHistoryStep++;
                recipeEditHistory = recipeEditHistory.slice(0, recipeHistoryStep);
                recipeEditHistory.push(state);
                updateRecipeHistoryButtons();
            };

            const updateRecipeHistoryButtons = () => {
                const undoBtn = document.getElementById('edit-recipe-undo-btn');
                const redoBtn = document.getElementById('edit-recipe-redo-btn');
                const controls = document.getElementById('edit-recipe-history-controls');

                if (recipeHistoryStep > 0) {
                    controls.classList.remove('hidden');
                } else {
                    controls.classList.add('hidden');
                }

                undoBtn.disabled = recipeHistoryStep <= 0;
                redoBtn.disabled = recipeHistoryStep >= recipeEditHistory.length - 1;
            };

            // Event Listeners for Recipe History
            // We need to attach these once. Where is the best place? 
            // Since we are replacing content, let's put them here if they don't exist, 
            // or better yet, assume we add them in the init section with others. 
            // For now, I'll attach them inside this block but checking if they are attached is hard.
            // BETTER STRATEGY: Add them to the global listener section below.

            // --- END RECIPE UNDO/REDO IMPLEMENTATION ---

            const closeEditRecipeModal = () => {
                Object.values(editRecipeTomSelectInstances).forEach(instance => instance.destroy());
                editRecipeTomSelectInstances = {};
                editRecipeForm.reset();
                editRecipeIngredientsList.innerHTML = '';
                currentlyEditingRecipeId = null;
                editRecipeModal.classList.add('hidden');
            };

            // =================================================================
            // RECIPE BOOK & CATEGORY FUNCTIONS
            // =================================================================
            const renderRecipePageCategoryFilters = () => {
                recipeCategoryFiltersContainer.innerHTML = '';
                let buttonsHTML = `<button class="category-filter-btn active py-2 px-4 border rounded-lg transition-colors text-sm" data-id="all">All</button>`;

                categories.forEach(cat => {
                    buttonsHTML += `<button class="category-filter-btn py-2 px-4 border rounded-lg transition-colors text-sm" data-id="${cat.id}">${cat.name}</button>`;
                });
                recipeCategoryFiltersContainer.innerHTML = buttonsHTML;
            };

            const Font = Quill.import('formats/font');
            Font.whitelist = ['sans-serif', 'serif', 'monospace'];
            Quill.register(Font, true);

            const colorPalette = ['#000000', '#e60000', '#ff9900', '#ffff00', '#008a00', '#0066cc', '#9933ff', '#ffffff', '#facccc', '#ffebcc', '#ffffcc', '#cce8cc', '#cce0f5', '#ebd6ff', '#bbbbbb', '#f06666', '#ffc266', '#ffff66', '#66b966', '#66a3e0', '#c285ff', '#888888', '#a10000', '#b26b00', '#b2b200', '#006100', '#0047b2', '#6b24b2'];

            let Inline = Quill.import('blots/inline');
            class TextBoxBlot extends Inline {
                static create() {
                    return super.create();
                }
                static formats() {
                    return true;
                }
            }
            TextBoxBlot.blotName = 'textbox';
            TextBoxBlot.tagName = 'SPAN';
            TextBoxBlot.className = 'ql-textbox';
            Quill.register(TextBoxBlot);

            const icons = Quill.import('ui/icons');
            icons['textbox'] = `<svg viewBox="0 0 18 18"><rect class="ql-stroke" x="2" y="4" width="14" height="10" rx="1"></rect><line class="ql-stroke" x1="5" x2="13" y1="9" y2="9"></line></svg>`;

            let quillEditor = null;
            let currentlyEditingPrepId = null;

            const renderCategoryFilters = () => {
                categoryFiltersContainer.innerHTML = '';
                let buttonsHTML = `<button class="category-filter-btn active py-2 px-4 border rounded-lg transition-colors text-sm" data-id="all">All</button>`;

                categories.forEach(cat => {
                    buttonsHTML += `<button class="category-filter-btn py-2 px-4 border rounded-lg transition-colors text-sm" data-id="${cat.id}">${cat.name}</button>`;
                });

                categoryFiltersContainer.innerHTML = buttonsHTML;
            };

            const renderRecipeBook = (activeCategoryId = 'all') => {
                recipeBookList.innerHTML = '';
                recipeBookPagination.innerHTML = '';

                const categorizedRecipes = recipes.reduce((acc, recipe) => {
                    const categoryId = recipe.categoryId || 0;
                    if (!acc[categoryId]) {
                        acc[categoryId] = [];
                    }
                    acc[categoryId].push(recipe);
                    return acc;
                }, {});

                const allCategories = [{ id: 0, name: 'Uncategorized' }, ...categories];

                allCategories.forEach(category => {
                    if (activeCategoryId !== 'all' && category.id != activeCategoryId) return;

                    let recipesInCategory = categorizedRecipes[category.id] || [];
                    if (recipesInCategory.length === 0) return;

                    const searchTerm = recipeBookSearchInput.value.toLowerCase();
                    if (searchTerm) {
                        recipesInCategory = recipesInCategory.filter(r => r.title.toLowerCase().includes(searchTerm));
                    }
                    const sortBy = recipeBookSortSelect.value;
                    recipesInCategory.sort((a, b) => {
                        switch (sortBy) {
                            case 'title-az': return a.title.localeCompare(b.title);
                            case 'title-za': return b.title.localeCompare(a.title);
                            case 'oldest': return a.id - b.id;
                            case 'latest': default: return b.id - a.id;
                        }
                    });

                    if (recipesInCategory.length === 0) return;

                    const categorySection = document.createElement('div');
                    categorySection.className = "space-y-3";
                    categorySection.innerHTML = `<h3 class="text-2xl font-bold text-brand-indigo-900 border-b-2 border-brand-indigo-200 pb-2 mb-4">${category.name}</h3>`;

                    recipesInCategory.forEach(recipe => {
                        const servingsInfo = recipe.servings.type === 'quantity' ? `${recipe.servings.value} ${recipe.servings.unit}` : `${recipe.servings.quantity} x ${recipe.servings.shape === 'round' ? `${recipe.servings.diameter}" Round` : `${recipe.servings.length}" x ${recipe.servings.width}"`} ${recipe.servings.unit}`;

                        // --- Auto-balancing logic for ingredients list ---
                        const totalItems = recipe.items.length;
                        const splitIndex = Math.ceil(totalItems / 2); // Ensures the left column gets the extra item if the total is odd

                        // Helper function to generate a list item to avoid repeating code
                        const generateListItem = (item) => {
                            if (item.type === 'library') {
                                const ingredient = ingredients.find(ing => ing.id === item.ingredientId);
                                return ingredient ? `<li>${ingredient.name} - ${item.amount} ${item.unit}</li>` : '';
                            }
                            return `<li>${item.name}</li>`;
                        };

                        const leftColumnHtml = recipe.items.slice(0, splitIndex).map(generateListItem).join('');
                        const rightColumnHtml = recipe.items.slice(splitIndex).map(generateListItem).join('');

                        const itemWrapper = document.createElement('div');
                        itemWrapper.className = 'recipe-book-item bg-white rounded-xl shadow-sm border border-gray-200';

                        itemWrapper.innerHTML = `
                    <div class="recipe-book-trigger flex justify-between items-center p-4 cursor-pointer">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">${recipe.title}</h4>
                            <p class="text-sm text-gray-500">Yields: ${servingsInfo}</p>
                        </div>
                        <div class="p-2 rounded-full hover:bg-gray-100">
                            <svg class="chevron-icon w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                    <div class="recipe-book-content">
                        <div class="p-6 border-t border-gray-200">
                            
                            <div>
                                <h5 class="font-semibold text-gray-700 mb-2 border-b pb-1">Ingredients</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                                    <ul class="list-disc list-inside text-gray-600 text-sm space-y-1">${leftColumnHtml}</ul>
                                    <ul class="list-disc list-inside text-gray-600 text-sm space-y-1">${rightColumnHtml}</ul>
                                </div>
                            </div>

                            <div class="mt-6">
                                <div class="flex justify-between items-center mb-2 border-b pb-1">
                                    <h5 class="font-semibold text-gray-700">Preparation Steps</h5>
                                    <button class="edit-preparation-btn py-2 px-4 bg-brand-pink-50 text-brand-pink-700 font-semibold rounded-lg text-sm hover:bg-brand-pink-100 transition-colors" data-id="${recipe.id}">
                                        Edit Preparation
                                    </button>
                                </div>
                                <div class="prose prose-sm max-w-none">${recipe.preparationSteps || '<p class="text-gray-400">No instructions added yet.</p>'}</div>
                            </div>
                            
                            <button class="collapse-recipe-btn w-full mt-6 py-2 bg-gray-50 hover:bg-gray-100 border-t flex justify-center items-center transition-colors">
                                <svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M14.77 12.79a.75.75 0 01-1.06-.02L10 8.832 6.29 12.77a.75.75 0 11-1.08-1.04l4.25-4.5a.75.75 0 011.08 0l4.25 4.5a.75.75 0 01-.02 1.06z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                        categorySection.appendChild(itemWrapper);
                    });
                    recipeBookList.appendChild(categorySection);
                });

                if (recipeBookList.innerHTML === '') {
                    recipeBookList.innerHTML = `<div class="bg-white rounded-xl shadow-sm border border-gray-200"><p class="text-center text-gray-500 py-10 px-6">No recipes found for the selected filter.</p></div>`;
                }
            };

            const openPreparationEditor = (recipeId) => {
                currentlyEditingPrepId = recipeId;
                const recipe = recipes.find(r => r.id === recipeId);
                if (!recipe) return;
                editorRecipeTitle.textContent = recipe.title;
                preparationEditorModal.classList.remove('hidden');
                quillEditor = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: {
                            container: [
                                [{ 'font': Font.whitelist }],
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'color': colorPalette }, { 'background': colorPalette }],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                ['link', 'textbox'],
                                ['clean']
                            ],
                            handlers: {
                                'textbox': function () {
                                    const range = this.quill.getSelection();
                                    if (range) {
                                        const isTextbox = this.quill.getFormat(range)['textbox'];
                                        this.quill.format('textbox', !isTextbox);
                                    }
                                }
                            }
                        }
                    }
                });
                quillEditor.root.innerHTML = recipe.preparationSteps || '';
            };

            const closePreparationEditor = () => {
                preparationEditorModal.classList.add('hidden');
                const editorParent = document.getElementById('quill-editor').parentElement;
                if (editorParent) {
                    editorParent.innerHTML = '<div id="quill-editor" style="height: 400px;"></div>';
                }
                quillEditor = null;
                currentlyEditingPrepId = null;
            };

            const openManageCategoryModal = () => {
                // Create backup and working copy
                originalCategories = JSON.parse(JSON.stringify(categories));
                tempCategories = JSON.parse(JSON.stringify(categories));

                // Reset undo/redo state
                categoryEditHistory = [JSON.parse(JSON.stringify(tempCategories))];
                categoryHistoryStep = 0;
                updateCategoryUndoRedoButtons();

                manageCategoriesModal.classList.remove('hidden');
                renderCategoryListInModal();
            };

            const renderCategoryListInModal = () => {
                categoryListInModal.innerHTML = '';
                tempCategories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-white border border-gray-200 p-3 rounded-lg hover:shadow-md hover:border-brand-pink-300 transition-all duration-200 group';
                    div.innerHTML = `
                <span class="font-medium text-gray-800 group-hover:text-brand-pink-600 transition-colors">${cat.name}</span>
                <button class="remove-category-btn flex items-center justify-center w-7 h-7 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all duration-200" data-id="${cat.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
                    categoryListInModal.appendChild(div);
                });
            };

            const saveCategoryHistory = () => {
                if (isCategoryUndoingRedoing) return;

                // Remove any future history if we're not at the end
                categoryEditHistory = categoryEditHistory.slice(0, categoryHistoryStep + 1);

                // Add new state
                categoryEditHistory.push(JSON.parse(JSON.stringify(tempCategories)));
                categoryHistoryStep++;

                // Limit history to 50 steps
                if (categoryEditHistory.length > 50) {
                    categoryEditHistory.shift();
                    categoryHistoryStep--;
                }

                updateCategoryUndoRedoButtons();
            };

            const updateCategoryUndoRedoButtons = () => {
                categoryUndoBtn.disabled = categoryHistoryStep <= 0;
                categoryRedoBtn.disabled = categoryHistoryStep >= categoryEditHistory.length - 1;

                // Toggle visibility based on whether there are any changes (history > 1)
                if (categoryEditHistory.length > 1) {
                    categoryHistoryControls.classList.remove('hidden');
                } else {
                    categoryHistoryControls.classList.add('hidden');
                }
            };

            const categoryUndo = () => {
                if (categoryHistoryStep > 0) {
                    isCategoryUndoingRedoing = true;
                    categoryHistoryStep--;
                    tempCategories = JSON.parse(JSON.stringify(categoryEditHistory[categoryHistoryStep]));
                    renderCategoryListInModal();
                    updateCategoryUndoRedoButtons();
                    isCategoryUndoingRedoing = false;
                }
            };

            const categoryRedo = () => {
                if (categoryHistoryStep < categoryEditHistory.length - 1) {
                    isCategoryUndoingRedoing = true;
                    categoryHistoryStep++;
                    tempCategories = JSON.parse(JSON.stringify(categoryEditHistory[categoryHistoryStep]));
                    renderCategoryListInModal();
                    updateCategoryUndoRedoButtons();
                    isCategoryUndoingRedoing = false;
                }
            };

            const addCategory = () => {
                const name = newCategoryNameInput.value.trim();
                if (name && !tempCategories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                    tempCategories.push({ id: Date.now(), name: name });
                    saveCategoryHistory();
                    renderCategoryListInModal();
                    newCategoryNameInput.value = '';
                }
            };

            const removeCategory = (categoryId) => {
                tempCategories = tempCategories.filter(c => c.id !== categoryId);
                saveCategoryHistory();
                renderCategoryListInModal();
            };

            const cancelCategoryChanges = () => {
                // Restore original categories
                tempCategories = [];
                originalCategories = [];
                categoryEditHistory = [];
                categoryHistoryStep = -1;
                manageCategoriesModal.classList.add('hidden');
            };

            const saveCategoryChanges = () => {
                // Apply changes to actual categories
                categories = JSON.parse(JSON.stringify(tempCategories));

                // Update recipes that reference deleted categories
                const categoryIds = categories.map(c => c.id);
                recipes.forEach(r => {
                    if (r.categoryId && !categoryIds.includes(r.categoryId)) {
                        r.categoryId = 0;
                    }
                });

                saveCategories();
                saveRecipes();

                // Show success message
                showFeedbackModal({
                    type: 'success',
                    title: 'Categories Saved',
                    message: 'Your category changes have been saved successfully!',
                    confirmText: 'OK',
                    onConfirm: () => {
                        // Clean up
                        tempCategories = [];
                        originalCategories = [];
                        categoryEditHistory = [];
                        categoryHistoryStep = -1;

                        manageCategoriesModal.classList.add('hidden');
                        renderCategoryFilters();
                        renderRecipeBook();
                        renderRecipePageCategoryFilters();
                    }
                });
            };

            const populateCategoryDropdown = (selectElement, selectedId = 0) => {
                selectElement.innerHTML = `<option value="0">Uncategorized</option>`;
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    if (cat.id === selectedId) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
            };

            // =================================================================
            // EVENT LISTENERS & INITIALIZATION
            // =================================================================

            // --- Budget Page Listeners ---
            const teamListDiv = document.getElementById('team-list');

            teamListDiv.addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('.toggle-team-details');
                if (toggleBtn) {
                    const teamId = toggleBtn.dataset.teamId;
                    const details = document.querySelector(`.team-card-details[data-details-for="${teamId}"]`);
                    details.classList.toggle('expanded');
                    toggleBtn.textContent = details.classList.contains('expanded') ? 'Collapse' : 'Details';

                    if (details.classList.contains('expanded')) {
                        const calendarContainer = details.querySelector('.production-calendar-container');
                        if (!calendarContainer.hasChildNodes()) {
                            const team = teams.find(t => t.id == teamId);
                            renderProductionCalendar(calendarContainer, team);
                        }
                    }
                }

                const editBtn = e.target.closest('.edit-team-btn');
                if (editBtn) {
                    const teamId = parseInt(editBtn.dataset.teamId, 10);
                    openEditTeamModal(teamId);
                }

                const deleteBtn = e.target.closest('.delete-team-btn');
                if (deleteBtn) {
                    const teamId = parseInt(deleteBtn.dataset.teamId, 10);
                    showFeedbackModal({
                        type: 'danger',
                        title: 'Delete Team?',
                        message: 'Are you sure you want to delete this team? This action cannot be undone.',
                        confirmText: 'Delete',
                        onConfirm: () => {
                            teams = teams.filter(t => t.id !== teamId);
                            saveTeams();
                            renderTeams();
                            renderFullProductionCalendar();
                        }
                    });
                }
            });

            openAddTeamModalBtn.addEventListener('click', openAddTeamModal);
            addTeamModalCancelBtn.addEventListener('click', closeAddTeamModal);
            addStaffBtn.addEventListener('click', () => addStaffRow());

            teamForm.addEventListener('input', updateBudgetSummary);

            staffList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-staff-btn')) {
                    e.target.closest('.staff-row').remove();
                    updateBudgetSummary();
                }
            });
            addTeamRecipeBtn.addEventListener('click', () => addTeamRecipeRow());
            teamRecipeList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-team-recipe-btn')) {
                    e.target.closest('.team-recipe-row').remove();
                    updateBudgetSummary();
                }
            });

            teamForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const teamData = {
                    id: currentlyEditingTeamId || Date.now(),
                    name: document.getElementById('team-name').value.trim() || 'Untitled Team',
                    staff: [],
                    recipes: []
                };

                document.querySelectorAll('.staff-row').forEach(row => {
                    teamData.staff.push({
                        name: row.querySelector('.staff-name').value,
                        salary: parseFloat(row.querySelector('.staff-salary').value),
                        duration_value: parseInt(row.querySelector('.staff-duration-value').value),
                        duration_type: row.querySelector('.staff-duration-type').value,
                    });
                });

                document.querySelectorAll('.team-recipe-row').forEach(row => {
                    const recipeId = row.querySelector('.team-recipe-select')?.value;
                    if (!recipeId) return;
                    teamData.recipes.push({
                        recipeId: parseInt(recipeId),
                        qtyPerDay: parseInt(row.querySelector('.team-recipe-qty').value),
                        cookDates: JSON.parse(row.querySelector('.team-recipe-dates').dataset.selectedDates || '[]')
                    });
                });

                if (currentlyEditingTeamId) {
                    const teamIndex = teams.findIndex(t => t.id === currentlyEditingTeamId);
                    if (teamIndex > -1) {
                        teams[teamIndex] = teamData;
                    }
                } else {
                    teams.push(teamData);
                }

                const isEdit = !!currentlyEditingTeamId;
                saveTeams();
                renderTeams();
                renderFullProductionCalendar();
                closeAddTeamModal();

                showFeedbackModal({
                    type: 'success',
                    title: isEdit ? 'Team Updated!' : 'Team Created!',
                    message: `${teamData.name} has been successfully ${isEdit ? 'updated' : 'created'}.`
                });
            });

            // --- Ingredient Page Listeners ---
            openAddIngredientModalBtn.addEventListener('click', openAddIngredientModal);
            addIngredientModalCancelBtn.addEventListener('click', closeAddIngredientModal);
            addIngredientForm.addEventListener('submit', addIngredient);
            ingredientListDiv.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    openEditModal(parseInt(editBtn.dataset.id, 10));
                }
            });
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = editNameInput.value.trim();

                if (currentEditSuppliers[currentEditTabIndex]) {
                    const s = currentEditSuppliers[currentEditTabIndex];
                    s.price = parseFloat(editPriceInput.value) || 0;
                    s.weight = parseFloat(editWeightInput.value) || 0;
                    s.unit = editUnitInput.value;
                    s.supplierName = editSupplierInput.value.trim();
                    s.notes = editNotesInput.value.trim();
                }

                let activeSup = currentEditSuppliers.find(s => s.active);
                if (!activeSup) {
                    activeSup = currentEditSuppliers[0];
                    activeSup.active = true;
                }

                if (!name || isNaN(activeSup.price) || isNaN(activeSup.weight) || activeSup.price < 0 || activeSup.weight <= 0) {
                    alert('Invalid values. Ensure the active price profile has valid Price and Amount.');
                    return;
                }

                const newConversions = [];
                conversionsListDiv.querySelectorAll('.conversion-row').forEach(row => {
                    const unitName = row.querySelector('.conversion-unit-name').value.trim();
                    const grams = parseFloat(row.querySelector('.conversion-grams').value);
                    const targetUnit = row.querySelector('.conversion-target-unit').value;
                    if (unitName && !isNaN(grams) && grams > 0) newConversions.push({ unitName, grams, targetUnit });
                });

                const ingToUpdate = ingredients.find(ing => ing.id === currentlyEditingId);
                if (ingToUpdate) {
                    // Get inventory field values
                    const displayStockQty = parseFloat(document.getElementById('edit-stock-qty')?.value) || 0;
                    const displayUnit = document.getElementById('edit-stock-unit')?.value || 'g';
                    const reorderLevel = parseFloat(document.getElementById('edit-reorder-level')?.value) || 0;
                    const stockLocation = document.getElementById('edit-stock-location')?.value?.trim() || '';

                    // Convert display stock to base unit (g/ml) for storage
                    let stockQtyInBaseUnit = displayStockQty;
                    if (displayUnit === 'kg') stockQtyInBaseUnit = displayStockQty * 1000;
                    if (displayUnit === 'l') stockQtyInBaseUnit = displayStockQty * 1000;

                    // Preserve existing inventory data while updating
                    const existingInventory = ingToUpdate.inventory || {};

                    Object.assign(ingToUpdate, {
                        name,
                        price: activeSup.price,
                        weight: activeSup.weight,
                        unit: activeSup.unit,
                        supplier: activeSup.supplierName,
                        notes: activeSup.notes,
                        suppliers: JSON.parse(JSON.stringify(currentEditSuppliers)),
                        conversions: newConversions,
                        inventory: {
                            ...existingInventory,
                            stockQty: stockQtyInBaseUnit,
                            displayUnit: displayUnit,
                            reorderLevel,
                            location: stockLocation
                        }
                    });
                }
                saveIngredients();
                renderIngredients();
                renderInventory();
                closeEditModal();
                showFeedbackModal({
                    type: 'success',
                    title: 'Ingredient Updated!',
                    message: `${name} has been successfully updated.`
                });
            });
            modalCancelBtn.addEventListener('click', closeEditModal);
            modalDeleteBtn.addEventListener('click', () => {
                showFeedbackModal({
                    type: 'danger',
                    title: 'Delete Ingredient?',
                    message: 'Are you sure you want to delete this ingredient? This cannot be undone.',
                    confirmText: 'Delete',
                    onConfirm: () => {
                        ingredients = ingredients.filter(ing => ing.id !== currentlyEditingId);
                        saveIngredients();
                        renderIngredients();
                        closeEditModal();
                    }
                });
            });
            addConversionBtn.addEventListener('click', () => appendConversionInput());
            conversionsListDiv.addEventListener('click', (e) => { if (e.target.classList.contains('remove-btn')) e.target.closest('.conversion-row').remove(); });
            ingredientSearchInput.addEventListener('input', renderIngredients);
            ingredientSortSelect.addEventListener('change', renderIngredients);
            // Click outside to close - DISABLED (only buttons can close)
            // addIngredientModal.addEventListener('click', (e) => { if (e.target === addIngredientModal) closeAddIngredientModal(); });

            // --- Recipe Page Listeners ---
            addLibraryIngredientBtn.addEventListener('click', addLibraryIngredientRow);
            addOpenItemBtn.addEventListener('click', addOpenItemRow);

            recipeIngredientsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const row = e.target.closest('.recipe-item-row');
                    if (row) {
                        const rowId = row.id;
                        if (recipeTomSelectInstances[rowId]) {
                            recipeTomSelectInstances[rowId].destroy();
                            delete recipeTomSelectInstances[rowId];
                        }
                        row.remove();
                    }
                }
            });

            recipeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const yieldType = document.getElementById('recipe-yield-type').value;
                let servingsData = {};

                if (yieldType === 'quantity') {
                    servingsData = {
                        type: 'quantity',
                        value: parseInt(document.getElementById('recipe-servings-value').value, 10),
                        unit: document.getElementById('recipe-servings-unit').value
                    };
                } else {
                    const shape = document.getElementById('recipe-pan-shape').value;
                    servingsData = {
                        type: 'size',
                        shape: shape,
                        unit: document.getElementById('recipe-pan-unit').value,
                        quantity: parseInt(document.getElementById('recipe-pan-quantity').value, 10),
                        length: shape === 'rectangular' ? parseFloat(document.getElementById('recipe-pan-length').value) : null,
                        width: shape === 'rectangular' ? parseFloat(document.getElementById('recipe-pan-width').value) : null,
                        diameter: shape === 'round' ? parseFloat(document.getElementById('recipe-pan-diameter').value) : null,
                        height: shape === 'rectangular'
                            ? parseFloat(document.getElementById('recipe-pan-height').value)
                            : parseFloat(document.getElementById('recipe-pan-height-round').value)
                    };
                }

                const newRecipe = {
                    id: Date.now(),
                    title: document.getElementById('recipe-title').value.trim(),
                    categoryId: parseInt(document.getElementById('recipe-category').value, 10) || 0,
                    servings: servingsData,
                    profit: {
                        type: document.getElementById('profit-type').value,
                        value: parseFloat(document.getElementById('profit-value').value)
                    },
                    items: [],
                    preparationSteps: ''
                };

                document.querySelectorAll('#recipe-ingredients-list .recipe-item-row').forEach(row => {
                    if (row.dataset.type === 'library') {
                        newRecipe.items.push({ type: 'library', ingredientId: parseInt(row.querySelector('.ingredient-select').value, 10), amount: parseFloat(row.querySelector('.amount-input').value), unit: row.querySelector('.unit-select').value });
                    } else {
                        newRecipe.items.push({ type: 'open', name: row.querySelector('.open-item-name').value.trim() });
                    }
                });
                recipes.push(newRecipe);
                saveRecipes();
                renderRecipes();
                closeAddRecipeModal();
                showFeedbackModal({
                    type: 'success',
                    title: 'Recipe Added!',
                    message: `${newRecipe.title} has been successfully added to your recipe book.`
                });
            });

            openAddRecipeModalBtn.addEventListener('click', openAddRecipeModal);
            addRecipeModalCancelBtn.addEventListener('click', closeAddRecipeModal);
            recipeSearchInput.addEventListener('input', () => {
                const activeFilter = recipeCategoryFiltersContainer.querySelector('.active')?.dataset.id || 'all';
                renderRecipes(activeFilter);
            });
            recipeSortSelect.addEventListener('change', () => {
                const activeFilter = recipeCategoryFiltersContainer.querySelector('.active')?.dataset.id || 'all';
                renderRecipes(activeFilter);
            });

            recipeCategoryFiltersContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.category-filter-btn');
                if (!btn) return;

                recipeCategoryFiltersContainer.querySelectorAll('.category-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const categoryId = btn.dataset.id;
                renderRecipes(categoryId);
            });

            editRecipeModalCancelBtn.addEventListener('click', closeEditRecipeModal);
            editAddLibraryIngredientBtn.addEventListener('click', () => addEditLibraryIngredientRow({}));
            editAddOpenItemBtn.addEventListener('click', () => {
                addEditOpenItemRow({ name: '' });
                setTimeout(pushRecipeHistory, 0);
            });

            // Recipe Undo/Redo/Delete Button Listeners
            document.getElementById('edit-recipe-undo-btn').addEventListener('click', () => {
                if (recipeHistoryStep > 0) {
                    recipeHistoryStep--;
                    restoreRecipeState(recipeEditHistory[recipeHistoryStep]);
                    updateRecipeHistoryButtons();
                }
            });
            document.getElementById('edit-recipe-redo-btn').addEventListener('click', () => {
                if (recipeHistoryStep < recipeEditHistory.length - 1) {
                    recipeHistoryStep++;
                    restoreRecipeState(recipeEditHistory[recipeHistoryStep]);
                    updateRecipeHistoryButtons();
                }
            });
            document.getElementById('edit-recipe-modal-delete-btn').addEventListener('click', () => {
                showFeedbackModal({
                    type: 'danger',
                    title: 'Delete Recipe?',
                    message: 'Are you sure you want to delete this recipe?',
                    confirmText: 'Delete',
                    onConfirm: () => {
                        recipes = recipes.filter(r => r.id !== currentlyEditingRecipeId);
                        saveRecipes();
                        renderRecipes();
                        closeEditRecipeModal();
                    }
                });
            });

            // Capture changes on form input
            editRecipeForm.addEventListener('input', () => pushRecipeHistory());
            editRecipeForm.addEventListener('change', () => pushRecipeHistory()); // For selects

            // Delegate click for removing items to capture history
            editRecipeIngredientsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn') || e.target.closest('.remove-btn')) {
                    setTimeout(pushRecipeHistory, 0); // Wait for the remove to happen (handled by other listener)
                }
            });

            editRecipeIngredientsList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-btn');
                if (removeBtn) {
                    const row = removeBtn.closest('.recipe-item-row');
                    if (row) {
                        const rowId = row.id;
                        if (editRecipeTomSelectInstances[rowId]) {
                            editRecipeTomSelectInstances[rowId].destroy();
                            delete editRecipeTomSelectInstances[rowId];
                        }
                        row.remove();
                    }
                }
            });

            recipeListDisplay.addEventListener('click', (e) => {
                const target = e.target;
                const cardElement = target.closest('.bg-white.rounded-xl.shadow-sm');

                const editBtn = target.closest('.edit-recipe-btn');
                if (editBtn) {
                    const recipeId = parseInt(editBtn.dataset.id, 10);
                    openEditRecipeModal(recipeId);
                    return;
                }

                const deleteBtn = target.closest('.delete-recipe-btn');
                if (deleteBtn) {
                    const recipeId = parseInt(deleteBtn.dataset.id, 10);
                    showFeedbackModal({
                        type: 'danger',
                        title: 'Delete Recipe?',
                        message: 'Are you sure you want to delete this recipe?',
                        confirmText: 'Delete',
                        onConfirm: () => {
                            recipes = recipes.filter(r => r.id !== recipeId);
                            saveRecipes();
                            renderRecipes();
                        }
                    });
                    return;
                }

                const scaleBtn = target.closest('.scale-btn');
                if (scaleBtn) {
                    const id = scaleBtn.dataset.id;
                    const container = scaleBtn.closest('.rounded-lg'); // Find the container for this recipe's scaling UI
                    // Find active mode
                    const activeBtn = container.querySelector('.scale-mode-btn.bg-brand-pink-600');
                    const mode = activeBtn ? activeBtn.dataset.mode : 'pan';

                    displayScaledRecipe(cardElement, parseInt(id), mode);
                    return;
                }

                const scaleModeBtn = target.closest('.scale-mode-btn');
                if (scaleModeBtn) {
                    const mode = scaleModeBtn.dataset.mode;
                    const id = scaleModeBtn.dataset.id;
                    const container = scaleModeBtn.closest('.rounded-lg');

                    // Update Buttons UI
                    container.querySelectorAll('.scale-mode-btn').forEach(btn => {
                        if (btn.dataset.mode === mode) {
                            btn.classList.remove('text-gray-500', 'hover:text-gray-700');
                            btn.classList.add('bg-brand-pink-600', 'text-white', 'shadow-sm');
                        } else {
                            btn.classList.remove('bg-brand-pink-600', 'text-white', 'shadow-sm');
                            btn.classList.add('text-gray-500', 'hover:text-gray-700');
                        }
                    });

                    // Toggle Input Containers
                    container.querySelectorAll('.scale-inputs-container').forEach(div => {
                        if (div.dataset.containerMode === mode) {
                            div.classList.remove('hidden');
                        } else {
                            div.classList.add('hidden');
                        }
                    });

                    // Reset inputs? Maybe optional.
                    return;
                }

                // Handle Mode Checking
                if (target.classList.contains('scale-mode-btn')) {
                    const mode = target.dataset.mode;
                    const id = target.dataset.id;
                    const container = target.closest('.rounded-lg');

                    // Update Buttons UI
                    container.querySelectorAll('.scale-mode-btn').forEach(btn => {
                        if (btn.dataset.mode === mode) {
                            btn.classList.remove('text-gray-500', 'hover:text-gray-700');
                            btn.classList.add('bg-brand-pink-600', 'text-white', 'shadow-sm');
                        } else {
                            btn.classList.remove('bg-brand-pink-600', 'text-white', 'shadow-sm');
                            btn.classList.add('text-gray-500', 'hover:text-gray-700');
                        }
                    });

                    // Toggle Input Containers
                    container.querySelectorAll('.scale-inputs-container').forEach(div => {
                        if (div.dataset.containerMode === mode) {
                            div.classList.remove('hidden');
                        } else {
                            div.classList.add('hidden');
                        }
                    });
                }

                if (target.classList.contains('reset-btn')) {
                    renderRecipes();
                }

                if (target.classList.contains('toggle-scroll-btn')) {
                    const container = cardElement.querySelector('.breakdown-container');
                    if (container) {
                        const isCollapsed = container.classList.contains('is-collapsed');
                        if (isCollapsed) {
                            container.classList.remove('is-collapsed');
                            target.textContent = 'See Less';
                        } else {
                            container.classList.add('is-collapsed');
                            target.textContent = 'See More';
                        }
                    }
                }
            });

            editRecipeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const recipeIndex = recipes.findIndex(r => r.id === currentlyEditingRecipeId);
                if (recipeIndex === -1) return;

                const yieldType = document.getElementById('edit-recipe-yield-type').value;
                let servingsData = {};

                if (yieldType === 'quantity') {
                    servingsData = {
                        type: 'quantity',
                        value: parseInt(document.getElementById('edit-recipe-servings-value').value, 10),
                        unit: document.getElementById('edit-recipe-servings-unit').value
                    };
                } else {
                    const shape = document.getElementById('edit-recipe-pan-shape').value;
                    servingsData = {
                        type: 'size',
                        shape: shape,
                        unit: document.getElementById('edit-recipe-pan-unit').value,
                        quantity: parseInt(document.getElementById('edit-recipe-pan-quantity').value, 10),
                        length: shape === 'rectangular' ? parseFloat(document.getElementById('edit-recipe-pan-length').value) : null,
                        width: shape === 'rectangular' ? parseFloat(document.getElementById('edit-recipe-pan-width').value) : null,
                        diameter: shape === 'round' ? parseFloat(document.getElementById('edit-recipe-pan-diameter').value) : null,
                        height: shape === 'rectangular'
                            ? parseFloat(document.getElementById('edit-recipe-pan-height').value)
                            : parseFloat(document.getElementById('edit-recipe-pan-height-round').value)
                    };
                }

                const updatedRecipe = {
                    id: currentlyEditingRecipeId,
                    title: document.getElementById('edit-recipe-title').value.trim(),
                    categoryId: parseInt(document.getElementById('edit-recipe-category').value, 10) || 0,
                    servings: servingsData,
                    profit: {
                        type: document.getElementById('edit-profit-type').value,
                        value: parseFloat(document.getElementById('edit-profit-value').value)
                    },
                    items: [],
                    preparationSteps: recipes[recipeIndex].preparationSteps || ''
                };

                editRecipeIngredientsList.querySelectorAll('.recipe-item-row').forEach(row => {
                    if (row.dataset.type === 'library') {
                        updatedRecipe.items.push({ type: 'library', ingredientId: parseInt(row.querySelector('.ingredient-select').value, 10), amount: parseFloat(row.querySelector('.amount-input').value), unit: row.querySelector('.unit-select').value });
                    } else {
                        updatedRecipe.items.push({ type: 'open', name: row.querySelector('.open-item-name').value.trim() });
                    }
                });
                recipes[recipeIndex] = updatedRecipe;
                saveRecipes();
                renderRecipes();
                closeEditRecipeModal();
                showFeedbackModal({
                    type: 'success',
                    title: 'Recipe Updated!',
                    message: `${updatedRecipe.title} has been successfully updated.`
                });
            });

            // --- Recipe Book Listeners ---
            viewRecipeBookBtn.addEventListener('click', () => {
                recipesPage.classList.add('hidden');
                recipeBookPage.classList.remove('hidden');
                renderCategoryFilters(); // --- NEW --- Render filters when switching to the page
                renderRecipeBook();
            });
            backToRecipesBtn.addEventListener('click', () => {
                recipeBookPage.classList.add('hidden');
                recipesPage.classList.remove('hidden');
            });
            recipeBookList.addEventListener('click', (e) => {
                // Handle the "Edit Preparation" button click
                const editBtn = e.target.closest('.edit-preparation-btn');
                if (editBtn) {
                    const recipeId = parseInt(editBtn.dataset.id, 10);
                    openPreparationEditor(recipeId);
                    return; // Stop further execution
                }

                const collapseBtn = e.target.closest('.collapse-recipe-btn');
                if (collapseBtn) {
                    const itemWrapper = collapseBtn.closest('.recipe-book-item');
                    if (itemWrapper) {
                        itemWrapper.classList.remove('is-expanded');
                    }
                    return;
                }

                // Handle the collapsible trigger click
                const trigger = e.target.closest('.recipe-book-trigger');
                if (trigger) {
                    const itemWrapper = trigger.closest('.recipe-book-item');
                    if (itemWrapper) {
                        itemWrapper.classList.toggle('is-expanded');
                    }
                }
            });
            editorSaveBtn.addEventListener('click', () => {
                if (!quillEditor || currentlyEditingPrepId === null) return;
                const recipeIndex = recipes.findIndex(r => r.id === currentlyEditingPrepId);
                if (recipeIndex > -1) {
                    recipes[recipeIndex].preparationSteps = quillEditor.root.innerHTML;
                    saveRecipes();
                    renderRecipeBook();
                    closePreparationEditor();
                }
            });
            editorCancelBtn.addEventListener('click', closePreparationEditor);

            // --- Category Listeners ---
            manageCategoriesBtn.addEventListener('click', openManageCategoryModal);

            // Prevent closing by clicking outside
            manageCategoriesModal.addEventListener('click', (e) => {
                if (e.target === manageCategoriesModal) {
                    e.stopPropagation();
                }
            });

            cancelCategoriesBtn.addEventListener('click', cancelCategoryChanges);
            saveCategoriesBtn.addEventListener('click', saveCategoryChanges);
            categoryUndoBtn.addEventListener('click', categoryUndo);
            categoryRedoBtn.addEventListener('click', categoryRedo);

            addCategoryBtn.addEventListener('click', addCategory);
            categoryListInModal.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-category-btn');
                if (removeBtn) {
                    const categoryId = parseInt(removeBtn.dataset.id, 10);
                    removeCategory(categoryId);
                }
            });

            // Keyboard shortcuts for undo/redo in category modal
            document.addEventListener('keydown', (e) => {
                if (!manageCategoriesModal.classList.contains('hidden')) {
                    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        categoryUndo();
                    } else if (e.ctrlKey && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                        e.preventDefault();
                        categoryRedo();
                    }
                }
            });


            // --- NEW --- Event listener for the filter buttons container
            categoryFiltersContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.category-filter-btn');
                if (!btn) return;

                // Update active state on buttons
                categoryFiltersContainer.querySelectorAll('.category-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Rerender the book with the filter
                const categoryId = btn.dataset.id;
                renderRecipeBook(categoryId);
            });

            // Add listeners for search and sort on recipe book page
            recipeBookSearchInput.addEventListener('input', () => renderRecipeBook());
            recipeBookSortSelect.addEventListener('change', () => renderRecipeBook());


            // --- SUPPLIER DASHBOARD LOGIC ---
            const getNormalizedPrice = (price, weight, unit) => {
                if (!price || !weight || weight === 0) return 0;
                // Standardize to per gram or per unit (simplification)
                return price / weight;
            };

            const renderSupplierDashboard = () => {
                supplierMatrixBody.innerHTML = '';
                const searchTerm = supplierSearchInput.value.toLowerCase();
                let visibleCount = 0;
                let totalSuppliers = new Set();
                let minMaxDiff = 0;
                let totalPotentialSavings = 0;

                const filteredIngredients = ingredients.filter(ing => ing.name.toLowerCase().includes(searchTerm));

                if (filteredIngredients.length === 0) {
                    supplierEmptyState.classList.remove('hidden');
                    supplierMatrixBody.parentElement.classList.add('hidden');
                } else {
                    supplierEmptyState.classList.add('hidden');
                    supplierMatrixBody.parentElement.classList.remove('hidden');
                }

                filteredIngredients.forEach(ing => {
                    const suppliers = ing.suppliers || [{
                        supplierName: ing.supplier || 'Unknown',
                        price: ing.price,
                        weight: ing.weight,
                        unit: ing.unit,
                        active: true
                    }];

                    // Collect stats
                    suppliers.forEach(s => {
                        if (s.supplierName) totalSuppliers.add(s.supplierName);
                    });

                    // Calculate Best Price, Highest Price, and variance
                    let bestPrice = Infinity;
                    let highestPrice = 0;
                    let bestSupplier = null;
                    let activeSupplierData = null;

                    suppliers.forEach(s => {
                        const normPrice = getNormalizedPrice(s.price, s.weight, s.unit);
                        if (normPrice > 0) {
                            if (normPrice < bestPrice) {
                                bestPrice = normPrice;
                                bestSupplier = s;
                            }
                            if (normPrice > highestPrice) {
                                highestPrice = normPrice;
                            }
                        }
                        if (s.active) {
                            activeSupplierData = s;
                        }
                    });

                    if (!activeSupplierData) activeSupplierData = suppliers[0];
                    const activeNormPrice = getNormalizedPrice(activeSupplierData.price, activeSupplierData.weight, activeSupplierData.unit);

                    // Calculate savings potential and variance
                    const savingsRM = activeNormPrice > bestPrice ? (activeNormPrice - bestPrice) * activeSupplierData.weight : 0;
                    const savingsPercent = activeNormPrice > 0 && activeNormPrice > bestPrice ? ((activeNormPrice - bestPrice) / activeNormPrice) * 100 : 0;
                    const priceVariance = highestPrice > 0 && bestPrice < Infinity ? ((highestPrice - bestPrice) / bestPrice) * 100 : 0;

                    if (bestPrice !== Infinity && activeNormPrice > bestPrice) {
                        minMaxDiff += savingsRM;
                        totalPotentialSavings += savingsRM;
                    }

                    visibleCount++;

                    // Render Row
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';

                    const isOptimal = activeSupplierData === bestSupplier || Math.abs(activeNormPrice - bestPrice) < 0.0001;

                    const supplierBadges = suppliers.map(s => {
                        const norm = getNormalizedPrice(s.price, s.weight, s.unit);
                        const isBest = Math.abs(norm - bestPrice) < 0.0001;
                        const isActive = s.active;
                        let color = 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200 hover:border-gray-300';
                        if (isBest && isActive) {
                            color = 'bg-green-100 text-green-700 border-green-300 ring-2 ring-green-400/30';
                        } else if (isBest) {
                            color = 'bg-green-50 text-green-600 border-green-200 hover:bg-green-100 hover:border-green-300 hover:ring-2 hover:ring-green-400/20';
                        } else if (isActive) {
                            color = 'bg-brand-pink-50 text-brand-pink-600 border-brand-pink-200';
                        }
                        const activeIcon = isActive ? ' ' : '';
                        const bestIcon = isBest ? ' ' : '';
                        const cursorClass = isActive ? 'cursor-default' : 'cursor-pointer';
                        const hoverTitle = isActive ? 'Currently active' : `Click to switch to ${s.supplierName}`;
                        return `<button class="supplier-badge-btn inline-block text-sm px-2.5 py-1.5 rounded-md border ${color} mr-1 mb-1 whitespace-nowrap transition-all ${cursorClass} ${!isActive ? 'hover:shadow-sm hover:scale-[1.02]' : ''}" 
                                data-ingredient-id="${ing.id}" 
                                data-supplier-name="${s.supplierName}"
                                data-is-active="${isActive}"
                                title="${hoverTitle}">
                            ${bestIcon}${activeIcon}${s.supplierName} <span class="font-semibold">(RM${norm.toFixed(2)}/u)</span>
                         </button>`;
                    }).join('');

                    const categoryBadge = ing.category
                        ? `<span class="text-[9px] px-1.5 py-0.5 bg-purple-50 text-purple-600 rounded-full border border-purple-100">${ing.category}</span>`
                        : '';

                    row.innerHTML = `
                        <td class="p-3 border-b text-center text-gray-400">${visibleCount}</td>
                        <td class="p-3 border-b">
                            <div class="font-semibold text-gray-800 text-base">${ing.name}</div>
                            <div class="flex items-center gap-2 mt-1">
                                ${categoryBadge}
                                <span class="text-[10px] text-gray-400">${suppliers.length} supplier${suppliers.length > 1 ? 's' : ''}</span>
                            </div>
                        </td>
                        <td class="px-2 py-2 border-b whitespace-nowrap">
                            <span class="font-bold text-gray-700 text-sm">${activeSupplierData.supplierName}</span>
                            <div class="text-[11px] text-brand-pink-500">RM${activeSupplierData.price.toFixed(2)}/${activeSupplierData.weight}${activeSupplierData.unit}</div>
                        </td>
                        <td class="px-2 py-2 border-b whitespace-nowrap">
                            <span class="font-bold text-green-600 text-sm">${bestSupplier ? bestSupplier.supplierName : '-'}</span>
                            <div class="text-[11px] text-green-500">${bestSupplier ? `RM${bestSupplier.price.toFixed(2)}/${bestSupplier.weight}${bestSupplier.unit}` : ''}</div>
                        </td>
                        <td class="px-2 py-2 border-b text-center whitespace-nowrap">
                            ${isOptimal
                            ? `<span class="px-2.5 py-1 bg-green-100 text-green-700 text-[10px] font-bold rounded-full uppercase"> Best</span>`
                            : `<div class="flex flex-col items-center">
                                <span class="px-2.5 py-1 bg-amber-50 text-amber-600 text-[10px] font-bold rounded-full uppercase border border-amber-200">Overpay</span>
                                <span class="text-[10px] font-bold text-red-500">-RM${savingsRM.toFixed(2)}</span>
                               </div>`}
                        </td>
                        <td class="px-2 py-2 border-b align-middle text-center">
                            <div class="flex flex-wrap gap-1 items-center justify-center">
                                ${supplierBadges}
                            </div>
                        </td>
                    `;
                    supplierMatrixBody.appendChild(row);
                });

                totalSuppliersCount.textContent = totalSuppliers.size;
                ingredientsCheckedCount.textContent = visibleCount;
            };

            supplierMatrixBody.addEventListener('click', (e) => {
                // Handle the main switch button in the Action column
                if (e.target.classList.contains('switch-supplier-btn')) {
                    const ingId = parseInt(e.target.dataset.id);
                    const targetSupplierName = e.target.dataset.supplier;
                    const ing = ingredients.find(i => i.id === ingId);

                    if (ing && ing.suppliers) {
                        ing.suppliers.forEach(s => {
                            s.active = s.supplierName === targetSupplierName;
                        });
                        const newActive = ing.suppliers.find(s => s.active);
                        if (newActive) {
                            ing.price = newActive.price;
                            ing.weight = newActive.weight;
                            ing.unit = newActive.unit;
                            ing.supplier = newActive.supplierName;
                        }
                        saveIngredients();
                        rerenderAll(); // Update ingredients list with new prices
                        renderSupplierDashboard();
                        showFeedbackModal({
                            type: 'success',
                            title: 'Supplier Switched',
                            message: `Active supplier switched to ${targetSupplierName}. Recipes updated.`
                        });
                    }
                }

                // Handle clicks on supplier badge buttons
                const badgeBtn = e.target.closest('.supplier-badge-btn');
                if (badgeBtn && badgeBtn.dataset.isActive !== 'true') {
                    const ingId = parseInt(badgeBtn.dataset.ingredientId);
                    const targetSupplierName = badgeBtn.dataset.supplierName;
                    const ing = ingredients.find(i => i.id === ingId);

                    if (ing && ing.suppliers) {
                        ing.suppliers.forEach(s => {
                            s.active = s.supplierName === targetSupplierName;
                        });
                        const newActive = ing.suppliers.find(s => s.active);
                        if (newActive) {
                            ing.price = newActive.price;
                            ing.weight = newActive.weight;
                            ing.unit = newActive.unit;
                            ing.supplier = newActive.supplierName;
                        }
                        saveIngredients();
                        rerenderAll(); // Update ingredients list with new prices
                        renderSupplierDashboard();
                        showFeedbackModal({
                            type: 'success',
                            title: 'Supplier Switched',
                            message: `Switched ${ing.name} to ${targetSupplierName}. Recipes updated.`
                        });
                    }
                }
            });

            const runShoppingListOptimizer = () => {
                // DOM references for optimizer modal
                const optimizerModal = document.getElementById('optimizer-modal');
                const optimizerTableBody = document.getElementById('optimizer-table-body');
                const optimizerEmptyState = document.getElementById('optimizer-empty-state');
                const optTotalSavings = document.getElementById('opt-total-savings');
                const optAvgSavings = document.getElementById('opt-avg-savings');
                const optItemsCount = document.getElementById('opt-items-count');
                const optSuppliersCount = document.getElementById('opt-suppliers-count');
                const applyAllBtn = document.getElementById('apply-all-optimizations-btn');
                const closeOptimizerBtn = document.getElementById('close-optimizer-btn');
                const closeOptimizerBtnFooter = document.getElementById('close-optimizer-btn-footer');

                let optimizations = [];
                let totalSavingsRM = 0;
                const targetSuppliers = new Set();

                ingredients.forEach(ing => {
                    const suppliers = ing.suppliers || [];
                    if (suppliers.length < 2) return;

                    let bestSupplier = null;
                    let bestPrice = Infinity;
                    let bestNorm = Infinity;
                    let currentActive = null;

                    suppliers.forEach(s => {
                        const norm = getNormalizedPrice(s.price, s.weight, s.unit);
                        if (norm > 0 && norm < bestNorm) {
                            bestNorm = norm;
                            bestPrice = s.price;
                            bestSupplier = s;
                        }
                        if (s.active) currentActive = s;
                    });
                    if (!currentActive) currentActive = suppliers[0];

                    if (bestSupplier && currentActive && bestSupplier.supplierName !== currentActive.supplierName) {
                        const currentNorm = getNormalizedPrice(currentActive.price, currentActive.weight, currentActive.unit);
                        const savingsPercent = ((currentNorm - bestNorm) / currentNorm) * 100;
                        // Estimate savings in RM based on per-unit difference (simplified)
                        const savingsRM = Math.abs(currentActive.price - bestSupplier.price);

                        if (savingsPercent > 0) {
                            targetSuppliers.add(bestSupplier.supplierName);
                            totalSavingsRM += savingsRM;
                            optimizations.push({
                                ingredientName: ing.name,
                                ingredientId: ing.id,
                                category: ing.category || 'Uncategorized',
                                currentSupplier: currentActive.supplierName,
                                currentPrice: currentActive.price,
                                currentWeight: currentActive.weight,
                                currentUnit: currentActive.unit,
                                currentNorm: currentNorm,
                                bestSupplier: bestSupplier.supplierName,
                                bestPrice: bestSupplier.price,
                                bestWeight: bestSupplier.weight,
                                bestUnit: bestSupplier.unit,
                                bestNorm: bestNorm,
                                savingsPercent: savingsPercent,
                                savingsRM: savingsRM
                            });
                        }
                    }
                });

                // Calculate average savings
                const avgSavings = optimizations.length > 0
                    ? optimizations.reduce((sum, o) => sum + o.savingsPercent, 0) / optimizations.length
                    : 0;

                // Update stats
                optTotalSavings.textContent = `RM ${totalSavingsRM.toFixed(2)}`;
                optAvgSavings.textContent = `${avgSavings.toFixed(1)}%`;
                optItemsCount.textContent = optimizations.length;
                optSuppliersCount.textContent = targetSuppliers.size;

                // Clear and populate table
                optimizerTableBody.innerHTML = '';

                if (optimizations.length > 0) {
                    optimizerEmptyState.classList.add('hidden');
                    optimizerTableBody.parentElement.classList.remove('hidden');
                    applyAllBtn.classList.remove('hidden');

                    optimizations.forEach((opt, index) => {
                        const row = document.createElement('tr');
                        row.className = 'optimizer-table-row text-xs';
                        row.innerHTML = `
                            <td class="px-3 py-2">
                                <div class="font-semibold text-gray-800 text-sm">${opt.ingredientName}</div>
                                <span class="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded-full">${opt.category}</span>
                            </td>
                            <td class="px-3 py-2">
                                <div class="font-medium text-gray-700 text-xs">${opt.currentSupplier}</div>
                                <div class="text-[10px] text-gray-400">RM${opt.currentPrice.toFixed(2)}/${opt.currentWeight}${opt.currentUnit}</div>
                            </td>
                            <td class="px-2 py-2 text-center">
                                <div class="flex items-center justify-center gap-1">
                                    <span class="text-red-500 font-medium line-through text-[11px]">RM${opt.currentNorm.toFixed(2)}/u</span>
                                    <svg class="price-compare-arrow h-3 w-3 text-brand-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                    </svg>
                                    <span class="text-green-600 font-semibold text-[11px]">RM${opt.bestNorm.toFixed(2)}/u</span>
                                </div>
                            </td>
                            <td class="px-3 py-2">
                                <div class="font-medium text-green-700 text-xs">${opt.bestSupplier}</div>
                                <div class="text-[10px] text-gray-400">RM${opt.bestPrice.toFixed(2)}/${opt.bestWeight}${opt.bestUnit}</div>
                            </td>
                            <td class="px-2 py-2 text-right">
                                <div class="savings-badge inline-flex items-center gap-0.5 px-2 py-1 rounded-full text-white text-[11px] font-bold">
                                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                    </svg>
                                    ${opt.savingsPercent.toFixed(1)}%
                                </div>
                                <div class="text-[9px] text-gray-400 mt-0.5">Save RM${opt.savingsRM.toFixed(2)}</div>
                            </td>
                            <td class="px-2 py-2 text-center align-middle">
                                <button class="switch-btn-row px-3 py-1.5 bg-brand-pink-500 text-white text-[11px] font-semibold rounded-md hover:bg-brand-pink-600" 
                                        data-ingredient-id="${opt.ingredientId}" 
                                        data-target-supplier="${opt.bestSupplier}">
                                    Switch
                                </button>
                            </td>
                        `;
                        optimizerTableBody.appendChild(row);
                    });
                } else {
                    optimizerEmptyState.classList.remove('hidden');
                    optimizerTableBody.parentElement.classList.add('hidden');
                    applyAllBtn.classList.add('hidden');
                }

                // Show modal
                optimizerModal.classList.remove('hidden');

                // Close modal handlers
                const closeModal = () => optimizerModal.classList.add('hidden');
                closeOptimizerBtn.onclick = closeModal;
                closeOptimizerBtnFooter.onclick = closeModal;
                // Click outside to close - DISABLED (only buttons can close)
                // optimizerModal.onclick = (e) => {
                //     if (e.target === optimizerModal) closeModal();
                // };

                // Individual switch button handler
                optimizerTableBody.onclick = (e) => {
                    const switchBtn = e.target.closest('.switch-btn-row');
                    if (switchBtn) {
                        const ingredientId = parseInt(switchBtn.dataset.ingredientId, 10);
                        const targetSupplierName = switchBtn.dataset.targetSupplier;

                        const ing = ingredients.find(i => i.id === ingredientId);
                        if (ing && ing.suppliers) {
                            ing.suppliers.forEach(s => s.active = false);
                            const newActive = ing.suppliers.find(s => s.supplierName === targetSupplierName);
                            if (newActive) {
                                newActive.active = true;
                                ing.price = newActive.price;
                                ing.weight = newActive.weight;
                                ing.unit = newActive.unit;
                                ing.supplier = newActive.supplierName;
                            }
                            saveIngredients();
                            renderSupplierDashboard();

                            // Remove this row from the table and update stats
                            switchBtn.closest('tr').remove();
                            const remainingRows = optimizerTableBody.querySelectorAll('tr').length;
                            optItemsCount.textContent = remainingRows;

                            if (remainingRows === 0) {
                                closeModal();
                                showFeedbackModal({
                                    type: 'success',
                                    title: 'All Optimized!',
                                    message: 'All ingredients have been switched to their best prices.'
                                });
                            }
                        }
                    }
                };

                // Apply all optimizations
                applyAllBtn.onclick = () => {
                    optimizations.forEach(opt => {
                        const ing = ingredients.find(i => i.id === opt.ingredientId);
                        if (ing && ing.suppliers) {
                            ing.suppliers.forEach(s => s.active = false);
                            const newActive = ing.suppliers.find(s => s.supplierName === opt.bestSupplier);
                            if (newActive) {
                                newActive.active = true;
                                ing.price = newActive.price;
                                ing.weight = newActive.weight;
                                ing.unit = newActive.unit;
                                ing.supplier = newActive.supplierName;
                            }
                        }
                    });
                    saveIngredients();
                    renderSupplierDashboard();
                    closeModal();
                    showFeedbackModal({
                        type: 'success',
                        title: 'Optimization Complete!',
                        message: `Successfully switched ${optimizations.length} ingredients to their best prices. Total estimated savings: RM${totalSavingsRM.toFixed(2)}`
                    });
                };
            };

            supplierSearchInput.addEventListener('input', renderSupplierDashboard);
            if (optimizeShoppingListBtn) optimizeShoppingListBtn.addEventListener('click', runShoppingListOptimizer);

            // --- Page Navigation & Initial Render ---
            const showPage = (pageToShow) => {
                const activeClasses = ['bg-white/10', 'font-semibold'];

                // Hides all pages first
                [homePage, ingredientsPage, inventoryPage, recipesPage, budgetPage, settingsPage, recipeBookPage, supplierDashboardPage].forEach(page => {
                    if (page) {
                        page.classList.add('hidden');
                        page.classList.remove('fade-in');
                    }
                });

                // Deactivates all nav links
                [navHome, navIngredients, navInventory, navRecipes, navBudget, navSettings, navSupplier].forEach(nav => nav.classList.remove(...activeClasses));

                // Shows the correct page and activates the correct nav link
                let targetPage = null;
                if (pageToShow === 'home') {
                    targetPage = homePage;
                    navHome.classList.add(...activeClasses);
                } else if (pageToShow === 'ingredients') {
                    targetPage = ingredientsPage;
                    navIngredients.classList.add(...activeClasses);
                } else if (pageToShow === 'recipes') {
                    targetPage = recipesPage;
                    navRecipes.classList.add(...activeClasses);
                } else if (pageToShow === 'budget') {
                    targetPage = budgetPage;
                    navBudget.classList.add(...activeClasses);
                    plannerDate = new Date();
                    renderFullProductionCalendar();
                    renderTeams();
                } else if (pageToShow === 'settings') {
                    targetPage = settingsPage;
                    navSettings.classList.add(...activeClasses);
                } else if (pageToShow === 'inventory') {
                    targetPage = inventoryPage;
                    navInventory.classList.add(...activeClasses);
                    renderInventory();
                } else if (pageToShow === 'supplier') {
                    targetPage = supplierDashboardPage;
                    navSupplier.classList.add(...activeClasses);
                    renderSupplierDashboard();
                }

                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    targetPage.classList.add('fade-in');
                }
            };

            // --- Routing Logic ---
            const handleRoute = () => {
                const hash = window.location.hash;
                let page = 'home'; // Default

                switch (hash) {
                    case '#recipes': page = 'recipes'; break;
                    case '#ingredients': page = 'ingredients'; break;
                    case '#inventory': page = 'inventory'; break;
                    case '#supplier': page = 'supplier'; break;
                    case '#budget': page = 'budget'; break;
                    case '#settings': page = 'settings'; break;
                    case '#home': page = 'home'; break;
                    default: page = 'home'; break;
                }
                showPage(page);
            };

            // Listen for hash changes
            window.addEventListener('hashchange', handleRoute);

            // Update internal button links to use hash
            homeToRecipesBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#recipes'; });
            homeToIngredientsBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#ingredients'; });
            homeToRecipesBtn2.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#recipes'; });
            homeToIngredientsBtn2.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#ingredients'; });

            setupYieldUI('add');
            setupYieldUI('edit');

            // Initial render of all components
            // =================================================================
            // CUSTOM FEEDBACK MODAL UTILITY
            // =================================================================
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackIconContainer = document.getElementById('feedback-icon-container');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackMessage = document.getElementById('feedback-message');
            const feedbackCancelBtn = document.getElementById('feedback-cancel-btn');
            const feedbackConfirmBtn = document.getElementById('feedback-confirm-btn');

            // Stored callbacks
            let currentConfirmCallback = null;
            let currentCancelCallback = null;

            const closeFeedbackModal = () => {
                feedbackModal.classList.add('hidden');
                currentConfirmCallback = null;
                currentCancelCallback = null;
            };

            // Re-attach listeners outside to avoid duplicates
            if (feedbackCancelBtn) {
                feedbackCancelBtn.onclick = () => {
                    if (currentCancelCallback) currentCancelCallback();
                    closeFeedbackModal();
                };
            }

            const showFeedbackModal = ({ type = 'success', title, message, confirmText = 'OK', cancelText = 'Cancel', onConfirm, onCancel }) => {
                // 1. Set Icons and Colors
                if (type === 'danger') {
                    // Red / Trash
                    feedbackIconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6 bg-red-100";
                    feedbackIconContainer.innerHTML = `<svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                    feedbackConfirmBtn.className = "px-6 py-3 rounded-xl font-bold text-white transition-colors flex-1 shadow-md hover:shadow-lg bg-red-500 hover:bg-red-600";
                } else if (type === 'warning') {
                    // Yellow / Exclamation '!'
                    feedbackIconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6 bg-yellow-100";
                    feedbackIconContainer.innerHTML = `<svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    feedbackConfirmBtn.className = "px-6 py-3 rounded-xl font-bold text-white transition-colors flex-1 shadow-md hover:shadow-lg bg-yellow-500 hover:bg-yellow-600";
                } else {
                    // Green / Check
                    feedbackIconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6 bg-green-100";
                    feedbackIconContainer.innerHTML = `<svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                    feedbackConfirmBtn.className = "px-6 py-3 rounded-xl font-bold text-white transition-colors flex-1 shadow-md hover:shadow-lg bg-green-700 hover:bg-green-800";
                }

                // 2. Set Content
                feedbackTitle.textContent = title;
                feedbackMessage.textContent = message;
                feedbackConfirmBtn.textContent = confirmText;

                // 3. Handle Buttons
                if (onConfirm) {
                    // It's a choice modal (Confirm/Cancel)
                    feedbackCancelBtn.classList.remove('hidden');
                    feedbackCancelBtn.textContent = cancelText;
                    currentConfirmCallback = onConfirm;
                    currentCancelCallback = onCancel;

                    feedbackConfirmBtn.onclick = () => {
                        if (currentConfirmCallback) currentConfirmCallback();
                        closeFeedbackModal();
                    };
                } else {
                    // It's an alert modal (OK only)
                    feedbackCancelBtn.classList.add('hidden');
                    feedbackConfirmBtn.onclick = () => {
                        closeFeedbackModal();
                    };
                }

                // 4. Show
                feedbackModal.classList.remove('hidden');
            };

            // Make it globally accessible for inline event handlers if needed
            window.showFeedbackModal = showFeedbackModal;

            // Initial render of all components
            rerenderAll();
            handleRoute(); // Call on load to set initial state

            // --- Shopping List Logic ---
            const shoppingListModal = document.getElementById('shopping-list-modal');
            const closeShoppingListBtn = document.getElementById('close-shopping-list-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const slRecipeTitle = document.getElementById('sl-recipe-title');
            const slYieldInfo = document.getElementById('sl-yield-info');
            const slTotalCost = document.getElementById('sl-total-cost');
            const slItemsContainer = document.getElementById('sl-items-container');

            const closeShoppingListModal = () => {
                shoppingListModal.classList.add('hidden');
            };

            closeShoppingListBtn.addEventListener('click', closeShoppingListModal);

            // Close on background click - DISABLED (only X button can close)
            // shoppingListModal.addEventListener('click', (e) => {
            //     if (e.target === shoppingListModal) closeShoppingListModal();
            // });

            // Event Delegation for Shopping List Button
            document.getElementById('recipe-list-display').addEventListener('click', (e) => {
                const btn = e.target.closest('.shopping-list-btn');
                if (btn) {
                    const recipeId = parseInt(btn.dataset.id, 10);
                    openShoppingListModal(recipeId, btn);
                }
            });

            // Helper: Unit Conversion (Simple)
            const getGramWeight = (amount, unit) => {
                if (!amount) return 0;
                switch (unit.toLowerCase()) {
                    case 'kg': return amount * 1000;
                    case 'g': return amount;
                    case 'l': return amount * 1000; // Assume water density
                    case 'ml': return amount;
                    case 'pcs': return amount; // Cannot convert pcs to weight without context, treated as raw
                    default: return amount;
                }
            };

            // State for Shopping List Mode
            let currentShoppingListRecipeId = null;
            let currentShoppingListMode = 'purchase'; // 'purchase' | 'usage'

            const openShoppingListModal = (recipeId, btnElement) => {
                if (btnElement) currentShoppingListMode = 'purchase';
                currentShoppingListRecipeId = recipeId;

                const recipe = recipes.find(r => r.id === recipeId);
                if (!recipe) return;

                // Update Toggle Button Styles
                const btnPurchase = document.getElementById('sl-mode-purchase');
                const btnUsage = document.getElementById('sl-mode-usage');
                if (btnPurchase && btnUsage) {
                    if (currentShoppingListMode === 'purchase') {
                        btnPurchase.className = 'px-3 py-1.5 text-xs font-semibold rounded-md bg-white shadow-sm text-gray-800 transition-all cursor-default';
                        btnUsage.className = 'px-3 py-1.5 text-xs font-semibold rounded-md text-gray-600 hover:text-gray-800 transition-all cursor-pointer';
                    } else {
                        btnPurchase.className = 'px-3 py-1.5 text-xs font-semibold rounded-md text-gray-600 hover:text-gray-800 transition-all cursor-pointer';
                        btnUsage.className = 'px-3 py-1.5 text-xs font-semibold rounded-md bg-white shadow-sm text-gray-800 transition-all cursor-default';
                    }
                }

                // 1. Determine Scale Factor from DOM
                let card;
                if (btnElement) {
                    card = btnElement.closest('.bg-white');
                } else {
                    const btn = document.querySelector(`.shopping-list-btn[data-id="${recipeId}"]`);
                    if (btn) card = btn.closest('.bg-white');
                }

                let scalingFactor = 1;
                let yieldText = '';

                // Check if inputs are visible and valid
                const scaleInputs = card ? card.querySelector('.scale-inputs-container:not(.hidden)') : null;

                if (scaleInputs) {
                    const mode = card.querySelector('.scale-mode-btn.bg-brand-pink-600')?.dataset.mode || 'pan';

                    if (mode === 'pan') {
                        // For 'pcs' mode (Quantity):
                        const qtyInput = card.querySelector('.scale-input-qty');
                        if (qtyInput && qtyInput.offsetParent !== null && qtyInput.value) {
                            const targetVal = parseFloat(qtyInput.value);
                            if (recipe.servings.type === 'quantity') {
                                scalingFactor = targetVal / recipe.servings.value;
                                yieldText = `${targetVal} ${recipe.servings.unit}`;
                            } else if (recipe.servings.type === 'size') {
                                scalingFactor = targetVal / (recipe.servings.quantity || 1);
                                yieldText = `${targetVal} ${recipe.servings.panUnit || recipe.servings.unit}`;
                            }
                        } else {
                            if (recipe.servings.type === 'quantity') {
                                yieldText = `${recipe.servings.value} ${recipe.servings.unit}`;
                            } else {
                                const { quantity, unit, panUnit } = recipe.servings;
                                yieldText = `${quantity} ${panUnit || unit}`;
                            }
                        }


                    } else {
                        // PCS Mode
                        const qtyInput = card.querySelectorAll('.scale-input-qty');
                        const input = Array.from(qtyInput).find(el => el.offsetParent !== null);

                        if (input && input.value) {
                            const targetVal = parseFloat(input.value);
                            if (recipe.servings.type === 'quantity') {
                                scalingFactor = targetVal / recipe.servings.value;
                                yieldText = `${targetVal} ${recipe.servings.unit}`;
                            } else {
                                scalingFactor = targetVal / (recipe.servings.quantity || 1);
                                yieldText = `${targetVal} ${recipe.servings.panUnit || recipe.servings.unit}`;
                            }
                        } else {
                            // No value entered in PCS mode, use default
                            if (recipe.servings.type === 'quantity') {
                                yieldText = `${recipe.servings.value} ${recipe.servings.unit}`;
                            } else {
                                const { quantity, unit, panUnit } = recipe.servings;
                                yieldText = `${quantity} ${panUnit || unit}`;
                            }
                        }
                    }
                } else {
                    if (recipe.servings.type === 'quantity') {
                        yieldText = `${recipe.servings.value} ${recipe.servings.unit}`;
                    } else {
                        const { quantity, unit, panUnit } = recipe.servings;
                        yieldText = `${quantity} ${panUnit || unit}`;
                    }
                }

                // Fallback: If yieldText is still empty, use recipe default
                if (!yieldText) {
                    if (recipe.servings.type === 'quantity') {
                        yieldText = `${recipe.servings.value} ${recipe.servings.unit}`;
                    } else {
                        const { quantity, unit, panUnit } = recipe.servings;
                        yieldText = `${quantity} ${panUnit || unit}`;
                    }
                }

                // 2. Calculate Costs & Grouping
                const shoppingList = {};
                let grandTotal = 0;

                recipe.items.forEach(item => {
                    if (item.type !== 'library') return;

                    const ingredient = ingredients.find(ing => ing.id === item.ingredientId);
                    if (!ingredient) return;

                    const requiredAmount = item.amount * scalingFactor;
                    const requiredUnit = item.unit;

                    const requiredGrams = getGramWeight(requiredAmount, requiredUnit);
                    const soldGrams = getGramWeight(ingredient.weight, ingredient.unit);

                    if (soldGrams === 0) return;

                    // --- NEW TOGGLE LOGIC & FORMATTING ---
                    let totalCost = 0;
                    let purchaseDetail = '';

                    if (currentShoppingListMode === 'usage') {
                        const usageRatio = requiredGrams / soldGrams;
                        totalCost = usageRatio * ingredient.price;
                        const pricePerGram = ingredient.price / soldGrams;

                        const isLiquid = ['ml', 'l', 'liter', 'liters', 'milliliter', 'milliliters'].includes(requiredUnit.toLowerCase());

                        if (requiredGrams >= 1000) {
                            const pricePerUnit = pricePerGram * 1000;
                            const quantity = requiredGrams / 1000;
                            const unitLabel = isLiquid ? 'L' : 'kg';
                            purchaseDetail = `RM ${pricePerUnit.toFixed(2)} x ${quantity.toLocaleString('en-US', { maximumFractionDigits: 2 })} ${unitLabel}`;
                        } else {
                            const unitLabel = isLiquid ? 'ml' : 'g';
                            purchaseDetail = `RM ${pricePerGram.toFixed(4)} x ${Math.round(requiredGrams)} ${unitLabel}`;
                        }
                    } else {
                        const packsNeeded = Math.ceil(requiredGrams / soldGrams);
                        totalCost = packsNeeded * ingredient.price;
                        purchaseDetail = `${packsNeeded} unit x ${ingredient.weight} ${ingredient.unit}`;
                    }

                    let supplierName = ingredient.supplier;
                    if (!supplierName && ingredient.suppliers && ingredient.suppliers.length > 0) {
                        const active = ingredient.suppliers.find(s => s.active);
                        if (active) supplierName = active.supplierName;
                        else supplierName = ingredient.suppliers[0].supplierName;
                    }
                    const supplier = supplierName || 'Other Stores';
                    if (!shoppingList[supplier]) shoppingList[supplier] = [];

                    // Format Required Detail (Need Column)
                    let needDisplay = `${requiredAmount.toLocaleString()} ${requiredUnit}`;
                    if (requiredUnit === 'g' && requiredAmount >= 1000) {
                        needDisplay = `${(requiredAmount / 1000).toLocaleString('en-US', { maximumFractionDigits: 2 })} kg`;
                    } else if (requiredUnit === 'ml' && requiredAmount >= 1000) {
                        needDisplay = `${(requiredAmount / 1000).toLocaleString('en-US', { maximumFractionDigits: 2 })} L`; // L for Litre
                    }

                    shoppingList[supplier].push({
                        name: ingredient.name,
                        requiredDetail: needDisplay,
                        purchaseDetail: purchaseDetail,
                        cost: totalCost
                    });

                    grandTotal += totalCost;
                });

                // 3. Render
                slRecipeTitle.textContent = recipe.title;
                slYieldInfo.textContent = `Yields: ${yieldText}`;
                slTotalCost.textContent = `RM ${grandTotal.toFixed(2)}`;
                slItemsContainer.innerHTML = '';

                if (Object.keys(shoppingList).length === 0) {
                    slItemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No library ingredients found for this recipe.</p>';
                } else {
                    for (const [supplier, items] of Object.entries(shoppingList)) {
                        const section = document.createElement('div');
                        section.className = 'border border-gray-200 rounded-lg overflow-hidden';

                        const header = document.createElement('div');
                        header.className = 'bg-gray-100 px-4 py-2 font-bold text-gray-700 flex justify-between';

                        const groupTotal = items.reduce((sum, item) => sum + item.cost, 0);

                        header.innerHTML = `<span>${supplier}</span> <span>RM ${groupTotal.toFixed(2)}</span>`;


                        const table = document.createElement('table');
                        table.className = 'w-full text-sm text-left table-fixed';
                        table.innerHTML = `
                            <thead class="bg-gray-50 text-gray-500 font-medium border-b">
                                <tr>
                                    <th class="px-4 py-2 w-[40%]">Item</th>
                                    <th class="px-4 py-2 w-[20%]">Need</th>
                                    <th class="px-4 py-2 w-[20%]">Buy</th>
                                    <th class="px-4 py-2 w-[20%] text-right">Cost</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${items.map(item => `
                                    <tr>
                                        <td class="px-4 py-2 text-gray-800 font-medium truncate" title="${item.name}">${item.name}</td>
                                        <td class="px-4 py-2 text-gray-600">${item.requiredDetail}</td>
                                        <td class="px-4 py-2 text-brand-indigo-600">${item.purchaseDetail}</td>
                                        <td class="px-4 py-2 text-right font-bold text-gray-800">RM ${item.cost.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;

                        section.appendChild(header);
                        section.appendChild(table);
                        slItemsContainer.appendChild(section);
                    }
                }

                shoppingListModal.classList.remove('hidden');
            };

            // Event Listeners for Purchase/Usage Mode
            const btnPurchase = document.getElementById('sl-mode-purchase');
            if (btnPurchase) {
                btnPurchase.addEventListener('click', () => {
                    if (currentShoppingListMode !== 'purchase') {
                        currentShoppingListMode = 'purchase';
                        if (currentShoppingListRecipeId) openShoppingListModal(currentShoppingListRecipeId);
                    }
                });
            }
            const btnUsage = document.getElementById('sl-mode-usage');
            if (btnUsage) {
                btnUsage.addEventListener('click', () => {
                    if (currentShoppingListMode !== 'usage') {
                        currentShoppingListMode = 'usage';
                        if (currentShoppingListRecipeId) openShoppingListModal(currentShoppingListRecipeId);
                    }
                });
            }

            downloadPdfBtn.addEventListener('click', () => {
                // Get the shopping list content
                const printArea = document.getElementById('shopping-list-print-area');

                // Create a new window for printing
                const printWindow = window.open('', '_blank');

                // Build the HTML for the print window
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${slRecipeTitle.textContent.trim()} - Shopping List</title>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            body {
                                font-family: 'Inter', sans-serif;
                                padding: 30px;
                                color: #1f2937;
                                background: white;
                                font-size: 14px;
                            }

                            /* Header Section */
                            .border-b {
                                border-bottom: 1px solid #e5e7eb;
                                padding-bottom: 12px;
                                margin-bottom: 16px;
                            }
                            .flex {
                                display: flex;
                            }
                            .justify-between {
                                justify-content: space-between;
                            }
                            .items-end {
                                align-items: flex-end;
                            }

                            /* Title and Yield */
                            h1 {
                                font-size: 20px;
                                font-weight: 700;
                                color: #1f2937;
                                margin-bottom: 2px;
                            }
                            .text-sm {
                                font-size: 14px;
                            }
                            .text-xs {
                                font-size: 12px;
                            }
                            .text-gray-500 {
                                color: #6b7280;
                            }
                            .text-gray-400 {
                                color: #9ca3af;
                            }
                            .text-gray-600 {
                                color: #4b5563;
                            }
                            .text-gray-700 {
                                color: #374151;
                            }
                            .text-gray-800 {
                                color: #1f2937;
                            }
                            .text-right {
                                text-align: right;
                            }
                            .uppercase {
                                text-transform: uppercase;
                            }
                            .tracking-wide {
                                letter-spacing: 0.025em;
                            }
                            .font-semibold {
                                font-weight: 600;
                            }
                            .font-bold {
                                font-weight: 700;
                            }
                            .font-medium {
                                font-weight: 500;
                            }

                            /* Total Cost */
                            .text-xl {
                                font-size: 20px;
                            }
                            .text-brand-pink-600 {
                                color: #d52770;
                            }
                            .text-brand-indigo-600 {
                                color: #1f2937;
                            }
                            .mt-0\\.5 {
                                margin-top: 2px;
                            }

                            /* Supplier Sections */
                            .space-y-4 > * + * {
                                margin-top: 16px;
                            }
                            .border {
                                border: 1px solid #e5e7eb;
                            }
                            .border-gray-200 {
                                border-color: #e5e7eb;
                            }
                            .rounded-lg {
                                border-radius: 8px;
                            }
                            .overflow-hidden {
                                overflow: hidden;
                            }

                            /* Supplier Header */
                            .bg-gray-100 {
                                background-color: #f3f4f6;
                            }
                            .bg-gray-50 {
                                background-color: #f9fafb;
                            }
                            .px-4 {
                                padding-left: 16px;
                                padding-right: 16px;
                            }
                            .py-2 {
                                padding-top: 8px;
                                padding-bottom: 8px;
                            }

                            /* Table */
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                font-size: 14px;
                                text-align: left;
                                table-layout: fixed;
                            }
                            thead {
                                background-color: #f9fafb;
                                color: #6b7280;
                                font-weight: 500;
                                border-bottom: 1px solid #e5e7eb;
                            }
                            th {
                                padding: 8px 16px;
                            }
                            th:nth-child(1) {
                                width: 40%;
                            }
                            th:nth-child(2) {
                                width: 20%;
                            }
                            th:nth-child(3) {
                                width: 20%;
                            }
                            th:nth-child(4) {
                                width: 20%;
                            }
                            tbody tr {
                                border-bottom: 1px solid #f3f4f6;
                                background-color: #ffffff;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            tbody tr:last-child {
                                border-bottom: none;
                            }
                            tbody tr:nth-child(even) {
                                background-color: #f3f4f6;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            td {
                                padding: 8px 16px;
                            }
                            .truncate {
                                overflow: hidden;
                                text-overflow: ellipsis;
                                white-space: nowrap;
                            }

                            @media print {
                                * {
                                    -webkit-print-color-adjust: exact !important;
                                    print-color-adjust: exact !important;
                                }
                                body {
                                    padding: 20px;
                                }
                                .border, .border-gray-200 {
                                    page-break-inside: avoid;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${printArea.innerHTML}
                    </body>
                    </html>
                `;

                printWindow.document.write(htmlContent);
                printWindow.document.close();

                // Wait for content to load, then trigger print
                printWindow.onload = function () {
                    printWindow.focus();
                    printWindow.print();
                    // Close the window after printing (user can cancel)
                    printWindow.onafterprint = function () {
                        printWindow.close();
                    };
                };
            });
        });

        /*
        // =================================================================
        // CUSTOM FEEDBACK MODAL UTILITY
        // =================================================================
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackIconContainer = document.getElementById('feedback-icon-container');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackCancelBtn = document.getElementById('feedback-cancel-btn');
        const feedbackConfirmBtn = document.getElementById('feedback-confirm-btn');

        // Stored callbacks
        let currentConfirmCallback = null;
        let currentCancelCallback = null;

        const closeFeedbackModal = () => {
            feedbackModal.classList.add('hidden');
            currentConfirmCallback = null;
            currentCancelCallback = null;
        };

        // Re-attach listeners outside to avoid duplicates
        feedbackCancelBtn.onclick = () => {
            if (currentCancelCallback) currentCancelCallback();
            closeFeedbackModal();
        };

        const showFeedbackModal = ({ type = 'success', title, message, confirmText = 'OK', cancelText = 'Cancel', onConfirm, onCancel }) => {
            // 1. Set Icons and Colors
            if (type === 'danger') {
                // Red / Trash
                feedbackIconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6 bg-red-100";
                feedbackIconContainer.innerHTML = `<svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                feedbackConfirmBtn.className = "px-6 py-3 rounded-xl font-bold text-white transition-colors flex-1 shadow-md hover:shadow-lg bg-red-500 hover:bg-red-600";
            } else if (type === 'warning') {
                // Yellow / Exclamation '!'
                feedbackIconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6 bg-yellow-100";
                // Using a simple exclamation mark icon (heroicons outline exclamation-circle style or similar)
                feedbackIconContainer.innerHTML = `<svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                feedbackConfirmBtn.className = "px-6 py-3 rounded-xl font-bold text-white transition-colors flex-1 shadow-md hover:shadow-lg bg-yellow-500 hover:bg-yellow-600";
            } else {
                // Green / Check
                feedbackIconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6 bg-green-100";
                feedbackIconContainer.innerHTML = `<svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                feedbackConfirmBtn.className = "px-6 py-3 rounded-xl font-bold text-white transition-colors flex-1 shadow-md hover:shadow-lg bg-green-700 hover:bg-green-800";
            }

            // 2. Set Content
            feedbackTitle.textContent = title;
            feedbackMessage.textContent = message;
            feedbackConfirmBtn.textContent = confirmText;

            // 3. Handle Buttons
            if (onConfirm) {
                // It's a choice modal (Confirm/Cancel)
                feedbackCancelBtn.classList.remove('hidden');
                feedbackCancelBtn.textContent = cancelText;
                currentConfirmCallback = onConfirm;
                currentCancelCallback = onCancel;

                feedbackConfirmBtn.onclick = () => {
                    if (currentConfirmCallback) currentConfirmCallback();
                    closeFeedbackModal();
                };
            } else {
                // It's an alert modal (OK only)
                feedbackCancelBtn.classList.add('hidden');
                feedbackConfirmBtn.onclick = () => {
                    closeFeedbackModal();
                };
            }

            // 4. Show
            feedbackModal.classList.remove('hidden');
        };
        */
    </script>
    <!-- Shopping List Optimizer Modal -->
    <div id="optimizer-modal"
        class="fixed inset-0 bg-black/40 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="optimizer-modal-content relative mx-4 w-full max-w-5xl shadow-2xl rounded-3xl bg-white overflow-hidden">
            <!-- Gradient Header -->
            <div class="optimizer-header-gradient px-8 py-6 text-white relative overflow-hidden">
                <div class="absolute inset-0 opacity-20">
                    <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <defs>
                            <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
                                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="currentColor" stroke-width="0.5" />
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid)" />
                    </svg>
                </div>
                <div class="relative flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <div class="p-2 bg-white/20 rounded-xl backdrop-blur-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold">Shopping List Optimizer</h2>
                        </div>
                        <p class="text-white/80 text-sm">Optimize your ingredient sourcing for maximum savings</p>
                    </div>
                    <button id="close-optimizer-btn"
                        class="close-optimizer-btn p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-6 bg-gradient-to-b from-gray-50 to-white">
                <div class="optimizer-stat-card rounded-2xl p-4 text-center">
                    <div class="flex justify-center mb-2">
                        <div class="p-2 bg-green-100 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Total Savings</p>
                    <p id="opt-total-savings" class="optimizer-stat-value text-2xl font-bold text-green-600">RM 0.00</p>
                </div>
                <div class="optimizer-stat-card rounded-2xl p-4 text-center">
                    <div class="flex justify-center mb-2">
                        <div class="p-2 bg-brand-pink-100 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-pink-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                    </div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Avg Savings</p>
                    <p id="opt-avg-savings" class="optimizer-stat-value text-2xl font-bold text-brand-pink-600">0%</p>
                </div>
                <div class="optimizer-stat-card rounded-2xl p-4 text-center">
                    <div class="flex justify-center mb-2">
                        <div class="p-2 bg-blue-100 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                        </div>
                    </div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Items to Switch</p>
                    <p id="opt-items-count" class="optimizer-stat-value text-2xl font-bold text-blue-600">0</p>
                </div>
                <div class="optimizer-stat-card rounded-2xl p-4 text-center">
                    <div class="flex justify-center mb-2">
                        <div class="p-2 bg-purple-100 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                        </div>
                    </div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Suppliers</p>
                    <p id="opt-suppliers-count" class="optimizer-stat-value text-2xl font-bold text-purple-600">0</p>
                </div>
            </div>

            <!-- Optimization Table -->
            <div class="px-6 pb-6">
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-brand-pink-500" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            Optimization Opportunities
                        </h3>
                    </div>
                    <div class="optimizer-scroll-container">
                        <table class="w-full text-left">
                            <thead
                                class="bg-pink-100 text-gray-500 text-[10px] uppercase tracking-wider sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-2 font-semibold">Ingredient</th>
                                    <th class="px-3 py-2 font-semibold">Current Supplier</th>
                                    <th class="px-2 py-2 font-semibold text-center">Price Comparison</th>
                                    <th class="px-3 py-2 font-semibold">Best Supplier</th>
                                    <th class="px-2 py-2 font-semibold text-right">Savings</th>
                                    <th class="px-2 py-2 font-semibold text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="optimizer-table-body" class="divide-y divide-gray-100">
                                <!-- Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Empty state -->
                    <div id="optimizer-empty-state" class="hidden py-12 text-center">
                        <div class="mx-auto w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Already Optimized!</h4>
                        <p class="text-gray-500">All your ingredients are using the best available prices.</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="px-6 pb-6 flex flex-col sm:flex-row gap-3">
                <button id="apply-all-optimizations-btn"
                    class="apply-all-btn flex-1 py-4 px-6 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    Apply All Optimizations
                </button>
                <button id="close-optimizer-btn-footer"
                    class="close-optimizer-btn py-4 px-6 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Restock Modal -->
    <div id="restock-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-4 border-b">
                <h3 class="text-lg font-bold text-gray-800">Add Stock</h3>
                <p id="restock-ingredient-name" class="text-xs text-gray-500 mt-0.5">Adding stock for: Flour</p>
            </div>
            <form id="restock-form" class="px-4 pt-2 pb-4 space-y-3">
                <input type="hidden" id="restock-ingredient-id">
                <div>
                    <label for="restock-date" class="block text-xs font-medium text-gray-700 mb-0.5">Purchase
                        Date</label>
                    <input type="date" id="restock-date" required
                        class="w-full p-1.5 text-sm border border-gray-300 rounded-lg focus-ring">
                </div>
                <div>
                    <label for="restock-qty" class="block text-xs font-medium text-gray-700 mb-0.5">Quantity</label>
                    <div class="flex">
                        <input type="number" id="restock-qty" step="0.01" min="0.01" required placeholder="1"
                            class="w-full p-1.5 text-sm border border-gray-300 rounded-l-lg focus-ring">
                        <select id="restock-unit-select"
                            class="px-2 py-1.5 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-700 text-sm font-medium focus:ring-0 focus:border-gray-300 w-16">
                        </select>
                    </div>
                </div>
            </form>
            <div class="flex justify-end items-center px-4 py-3 border-t bg-gray-50 rounded-b-xl gap-2">
                <button type="button" id="restock-cancel-btn"
                    class="py-2 px-4 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                <button type="submit" form="restock-form"
                    class="py-2 px-4 bg-brand-pink-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors">Add
                    Stock</button>
            </div>
        </div>
    </div>

    <!-- Generic Feedback Modal -->
    <div id="feedback-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="relative mx-auto p-8 border w-96 shadow-lg rounded-2xl bg-white text-center transform transition-all scale-100">
            <!-- Icon Container -->
            <div id="feedback-icon-container"
                class="mx-auto flex items-center justify-center h-20 w-20 rounded-full mb-6">
                <!-- Icon SVG will be injected here -->
            </div>

            <!-- Content -->
            <h3 id="feedback-title" class="text-2xl font-bold text-gray-900 mb-2"></h3>
            <p id="feedback-message" class="text-gray-500 mb-8"></p>

            <!-- Buttons -->
            <div id="feedback-actions" class="flex justify-center gap-4">
                <button id="feedback-cancel-btn"
                    class="hidden px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-colors flex-1">Cancel</button>
                <button id="feedback-confirm-btn"
                    class="px-6 py-3 rounded-xl font-bold text-white transition-colors flex-1 shadow-md hover:shadow-lg">OK</button>
            </div>
        </div>
    </div>
    <div id="shopping-list-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="px-6 py-3 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Shopping List</h3>
                    <p class="text-sm text-gray-500 mt-1" id="shopping-list-subtitle">Calculated based on your scaled
                        recipe</p>
                </div>
                <button type="button" id="close-shopping-list-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="shopping-list-content" class="px-6 pt-2 pb-6 overflow-y-auto bg-white flex-1">
                <!-- Printable Content Area -->
                <div id="shopping-list-print-area" class="space-y-4">
                    <div class="border-b pb-3 mb-4 flex justify-between items-end">
                        <div>
                            <h1 class="text-xl font-bold text-gray-800" id="sl-recipe-title">Recipe Title</h1>
                            <p class="text-sm text-gray-500 mt-0.5" id="sl-yield-info">Yields: 50 pcs</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold">Total Estimated Cost
                            </p>
                            <p class="text-xl font-bold text-brand-pink-600" id="sl-total-cost">RM 0.00</p>
                        </div>
                    </div>

                    <div id="sl-items-container" class="space-y-4">
                        <!-- Dynamic Content Injected Here -->
                    </div>
                </div>
            </div>


            <div class="flex justify-between items-center px-6 py-3 border-t bg-gray-50 rounded-b-xl">
                <div class="flex bg-gray-200 rounded-lg p-1 gap-1">
                    <button id="sl-mode-purchase"
                        class="px-3 py-1.5 text-xs font-semibold rounded-md bg-white shadow-sm text-gray-800 transition-all">Purchase
                        Price</button>
                    <button id="sl-mode-usage"
                        class="px-3 py-1.5 text-xs font-semibold rounded-md text-gray-600 hover:text-gray-800 transition-all">Usage
                        Price</button>
                </div>
                <button type="button" id="download-pdf-btn"
                    class="flex items-center gap-2 py-2 px-4 bg-brand-pink-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-brand-pink-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Print
                </button>
            </div>
        </div>
    </div>

</body>

</html>